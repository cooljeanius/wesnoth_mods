#textdomain wesnoth-AfterEI
#

# [ai][avoid] issues
# Need to [or] all the various areas to be avoided into a single [avoid].
# This could be done but decided on a simplified approach:
#
# 1: Allied starting points (Arrah, Elgenefar, Krag & Morn):
#    - No avoid.
#      IMO a player would have to be very unlucky to appear with
#       more than one or two enemy units within attack range.
#      But if that does happen, well battle is sometimes uncertain and unfair...
#
# 2: Side 7 (shaman defenders) avoid:
#    - Apply, then delete when side 7 appears.
#
# 3: SE enclave (side 8)
#    - Only needed to prevent early death of leader whilst region still in shroud.
#      Whilst shrouded, respawn leader if killed (slaying unit must be ai controlled).
#      Also results in a steady stream of enemy units invading spider territory
#
# 4: Enemy leaders
#    - Needed to prevent the (*exceedingly* unlikely) possibility of the ai forcing defeat.
#      Always applied to sides 8 & 9 ([or]ed with shaman defenders).
#


# --- Music macros ---

#define AEI_REPLACE_MUSIC_APPEND AEI_MUSIC
  [music]
    name={AEI_MUSIC}
    immediate=yes
    append=yes
  [/music]
#enddef

#define AEI_ARRIVAL_MUSIC ROCK_TRACK ALT_TRACK
  [if]
    [variable]
      name=add_rock
      equals=yes
    [/variable]
  [then]
    {AEI_REPLACE_MUSIC_APPEND {ROCK_TRACK}}
    {APPEND_MUSIC {ALT_TRACK}}
  [/then]
  [else]
    {AEI_REPLACE_MUSIC_APPEND {ALT_TRACK}}
  [/else]
  [/if]
#enddef

#define MORN_MUSIC
  {AEI_ARRIVAL_MUSIC ThoseofUsWhoFight.ogg March_of_the_divine.ogg}
  {APPEND_MUSIC land_of_adventure.ogg}
  {APPEND_MUSIC the_dangerous_symphony.ogg}
  {APPEND_MUSIC through_the_gates.ogg}
#enddef

#define ARRAH_MUSIC
  {AEI_ARRIVAL_MUSIC Floating_Paper_Bags.ogg Desert_Chase.ogg}
  {APPEND_MUSIC loyalists.ogg}
  {APPEND_MUSIC frantic-old.ogg}
  {APPEND_MUSIC no_way_out.ogg}
#enddef

#define KRAG_MUSIC
  [music]
    name=northern_mountains.ogg
    immediate=yes
    append=yes
  [/music]
  [if]
    [variable]
      name=add_rock
      equals=yes
    [/variable]
  [then]
    {APPEND_MUSIC Anonymity.ogg}
  [/then]
  [/if]
  {APPEND_MUSIC knalgan_theme.ogg}
  {APPEND_MUSIC legends_of_the_north.ogg}
  {APPEND_MUSIC northerners.ogg}
#enddef

#define ELGENEFAR_MUSIC
  [music]
    name=siege_of_laurelmor.ogg
    immediate=yes
    append=yes
  [/music]
  [if]
    [variable]
      name=add_rock
      equals=yes
    [/variable]
  [then]
    {APPEND_MUSIC Emotion.ogg}
  [/then]
  [/if]
  {APPEND_MUSIC frantic.ogg}
  {APPEND_MUSIC knolls.ogg}
  {APPEND_MUSIC moleman.ogg}
#enddef


# Arrah and Morn have no gold saved from previous scenarios
# Elgenefar starting gold setup in [side] 1
#
#
#  Leader     easy   norm  hard
#  Flynn      600    550   500
#  Morn       580    550   520
#  Arrah      300    250   200
#  Krag       350    300   250
#  Elgenefar  380    300   220
#
# Also setup invulnerability potion duration (if in play): {22 20 18} turns
#  and number of "safe" attacks with thunderdust (if in play): {12 10 8}
#  Note: the attack is magical and only attacks that miss are counted
#
#ifdef EASY
#define MIN_START_GOLD_FLYNN
600#enddef
#define START_GOLD_MORN
580#enddef
#define START_GOLD_ARRAH
300#enddef
#define MIN_START_GOLD_KRAG
350#enddef
#define MIN_START_GOLD_ELGENEFAR
380#enddef
#define POTION_INV_TURNS
22#enddef
#define DUST_SAFE_ATTACKS
12#enddef
#endif
#
#ifdef NORMAL
#define MIN_START_GOLD_FLYNN
550#enddef
#define START_GOLD_MORN
550#enddef
#define START_GOLD_ARRAH
250#enddef
#define MIN_START_GOLD_KRAG
300#enddef
#define MIN_START_GOLD_ELGENEFAR
300#enddef
#define POTION_INV_TURNS
20#enddef
#define DUST_SAFE_ATTACKS
10#enddef
#endif
#
#ifdef HARD
#define MIN_START_GOLD_FLYNN
500#enddef
#define START_GOLD_MORN
520#enddef
#define START_GOLD_ARRAH
200#enddef
#define MIN_START_GOLD_KRAG
250#enddef
#define MIN_START_GOLD_ELGENEFAR
220#enddef
#define POTION_INV_TURNS
18#enddef
#define DUST_SAFE_ATTACKS
8#enddef
#endif


# Bat cave moveto
#define C1_XY
32,10#enddef
#define C2_XY
13,7#enddef
#define C3_XY
18,14#enddef
#
# Bat cave entrances
#define C1E_XY
32,9#enddef
#define C2E_XY
12,6#enddef
#define C3E_XY
17,15#enddef
#define CE_ALL_XY
x=32,12,17
y= 9, 6,15#enddef
#
# Bat cave xy ranges
#define C1_RX
"25-38"#enddef
#define C1_RY
"1-9"#enddef
#define C2_RX
"1-15"#enddef
#define C2_RY
"1-7"#enddef
#define C3_RX
"1-17"#enddef
#define C3_RY
"11-20"#enddef
#
# Bat cave shaman locations
#define C1S_X
28#enddef
#define C1S_Y
1#enddef
#define C2S_X
2#enddef
#define C2S_Y
2#enddef
#define C3S_X
2#enddef
#define C3S_Y
15#enddef
#
# Bat cave spawn amount
# Only spawn if number of bats in cave is: {<5 <6 <7}

#ifdef EASY
#define C1_SPAM
3#enddef
#define C2_SPAM
3#enddef
#define C3_SPAM
2#enddef
#endif
#
#ifdef NORMAL
#define C1_SPAM
3#enddef
#define C2_SPAM
4#enddef
#define C3_SPAM
3#enddef
#endif
#
#ifdef HARD
#define C1_SPAM
4#enddef
#define C2_SPAM
4#enddef
#define C3_SPAM
4#enddef
#endif


# Modifiers for alpha and beta wolves
#define PACK_LEADER HP_ADD DAMAGE_ADD
[object]
  silent=yes
  [effect]
    apply_to=hitpoints
    increase_total={HP_ADD}
  [/effect]
  [effect]
    apply_to=attack
    range=melee
    increase_damage={DAMAGE_ADD}
  [/effect]
[/object]
#enddef


# Human (Flynn) potion locations (if any)
#define POTIONX_H
55#enddef
#define POTIONY_H
57#enddef

# Dwarf (Krag) potion locations (if any)
#define POTIONX_D
18#enddef
#define POTIONY_D
2#enddef

# Elf (Elgenefar) potion locations (if any)
#define POTIONX_E
75#enddef
#define POTIONY_E
1#enddef

# Potion label colour
#define POTION_LABEL_COLOUR
color=255,128,128#enddef

# Potion moveto event
#define POTION_MOVETO X Y COUNTER LEADER_ID
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y={X},{Y}
      side=1
      [not]
        status=unpoisonable
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name={COUNTER}
        greater_than=0
      [/variable]
      [have_unit]
        id={LEADER_ID}
      [/have_unit]
    [/filter_condition]
    [set_variable]
      name=potion_count
      value=${COUNTER}
    [/set_variable]
    [message]
      speaker=narrator
      image=items/potion-red.png
      message= _ "Drink antidote?  <i>$potion_count available here.</i>"
      [option]
        label= _ "Yes!"
        [command]
          [sound]
            name=potion.ogg
          [/sound]
          [heal_unit]		# Full heal (I'm nice like that :-)
            [filter]
              x,y=$x1,$y1
            [/filter]
            amount=full
            animate=yes
            restore_statuses=yes
          [/heal_unit]
          [object]
            take_only_once=no
            duration=scenario
            [filter]
              x,y=$x1,$y1
            [/filter]
            [effect]
              apply_to=status
              add=unpoisonable
            [/effect]
          [/object]
          [unit_overlay]
            x,y=$x1,$y1
            image=items/potion-red-overlay.png
          [/unit_overlay]
          [set_variable]
            name=potion_count
            sub=1
          [/set_variable]
          [if]
            [variable]
              name=potion_count
              equals=0
            [/variable]
          [then]
            [remove_item]
              image=items/potion-red.png
              x,y=$x1,$y1
            [/remove_item]
            [label]
              x,y=$x1,$y1
              {POTION_LABEL_COLOUR}
              text= _ ""
            [/label]
          [/then]
          [else]
            [label]
              x,y=$x1,$y1
              {POTION_LABEL_COLOUR}
              text= _ "$potion_count"
            [/label]
          [/else]
          [/if]
        [/command]
      [/option]
      [option]
        label= _ "No."
        [command]
          [allow_undo]
          [/allow_undo]
        [/command]
      [/option]
    [/message]
    [set_variable]
      name={COUNTER}
      value=$potion_count
    [/set_variable]
    [clear_variable]
      name=potion_count
    [/clear_variable]
  [/event]
#enddef

# Tunnel pairs (dwarves only)
# Used by dwarf messenger
#define MD_NORTHXY
x,y=18,1#enddef
#define MD_SOUTHXY
x,y=6,51#enddef
#
# North-south tunnel (east, ANY)
#define TE_NORTHXY
x,y=56,24#enddef
#define TE_SOUTHXY
x,y=61,59#enddef
#
# North-south tunnel  (far east, dwarves only)
#define TFE_NORTHXY
x,y=57,1#enddef
#define TFE_SOUTHXY
x,y=80,27#enddef
#
# North-south tunnel (west, dwarves only)
#define TW_NORTHXY
x,y=22,1#enddef
#define TW_SOUTHXY
x,y=8,10#enddef
#
# East-west tunnel (dwarves only)
#define T_EASTXY
x,y=55,1#enddef
#define T_WESTXY
x,y=25,15#enddef
#
# East-west tunnel (ANY)
#define TA_EASTXY
x,y=1,48#enddef
#define TA_WESTXY
x,y=80,24#enddef
#
# Boss tunnel (ANY)
#define TB_NORTHXY
x,y=80,29#enddef
#define TB_SOUTHXY
x,y=40,21#enddef
#
# Arrah-Elgenefar tunnel
#define TAE_ARRAHXY
x,y=4,52#enddef
#define TAE_ELGENEFARXY
x,y=79,3#enddef
#
# Krag-Morn tunnel
#define TKM_KRAGXY
x,y=27,9#enddef
#define TKM_MORNXY
x,y=32,60#enddef

#define TUNNELS_FILTER_ALL
x=56,61, 1,80,80,40, 4,79,27,32
y=24,59,48,24,29,21,52, 3, 9,60#enddef
#
#define TUNNELS_FILTER_DWARF
x=  6,18,57,80,22, 8,55,25
y= 51, 1, 1,27, 1,10, 1,15#enddef
#
#define TUNNEL_TELEPORT_DWARF STARTXY ENDXY
#ifdef EASY
#ifdef DEBUG_MODE
  [event]
    name=prestart
    [label]
      {STARTXY}
      text="to {ENDXY}"
    [/label]
  [/event]
#endif
#endif
  [event]
    name=moveto
    first_time_only=no
    [filter]
      {STARTXY}
      race=dwarf
    [/filter]
    [if]
      [have_unit]
        {ENDXY}
      [/have_unit]
    [then]
      [message]
        speaker=unit
        message= _ "Ah cannae get through, the way oot's blocked!"
      [/message]
      [allow_undo]
      [/allow_undo]
    [/then]
     [else]
      [teleport]
        [filter]
          x,y=$x1,$y1
        [/filter]
        {ENDXY}
      [/teleport]
      [scroll_to_unit]
        {ENDXY}
        highlight=yes
      [/scroll_to_unit]
    [/else]
    [/if]
  [/event]
#enddef
#
#define TUNNEL_TELEPORT_ALL STARTXY ENDXY
#ifdef EASY
#ifdef DEBUG_MODE
  [event]
    name=prestart
    [label]
      {STARTXY}
      text="to {ENDXY}"
    [/label]
  [/event]
#endif
#endif
  [event]
    name=moveto
    first_time_only=no
    [filter]
      {STARTXY}
      side=1
    [/filter]
    [if]
      [have_unit]
        {ENDXY}
      [/have_unit]
    [then]
      [set_variables]
        name=rspeak
        [value]
          x=$x1
          y=$y1
          r=$unit.race
          d="Ah cannae get through, the way oot's blocked!"
          e="I cannot get through: the point of egress is occupied."
          h="The far end isn't clear!"
          l="The exxit iss obsstructed."
          o="Out is blocked way!"
        [/value]
      [/set_variables]
      [fire_event]
        name=rspeak
      [/fire_event]
      [allow_undo]
      [/allow_undo]
    [/then]
    [else]
      [teleport]
        [filter]
          x,y=$x1,$y1
        [/filter]
        {ENDXY}
      [/teleport]
      [scroll_to_unit]
        {ENDXY}
        highlight=yes
      [/scroll_to_unit]
    [/else]
    [/if]
  [/event]
#enddef

#define KRAGX
21#enddef
#define KRAGY
2#enddef
#define KRAGXY
x,y={KRAGX},{KRAGY}#enddef
#define BLOKXY
x,y=19,2#enddef
#define CHEST_POTIONX
22#enddef
#define CHEST_POTIONY
2#enddef
#define CHEST_POTION
x,y={CHEST_POTIONX},{CHEST_POTIONY}#enddef
#define CHEST_GRITX
23#enddef
#define CHEST_GRITY
2#enddef
#define CHEST_GRIT
x,y={CHEST_GRITX},{CHEST_GRITY}#enddef
#define CHEST_AXEX
22#enddef
#define CHEST_AXEY
3#enddef
#define CHEST_AXE
x,y={CHEST_AXEX},{CHEST_AXEY}#enddef

#define ELGENEFARX
73#enddef
#define ELGENEFARY
2#enddef
#define ELGENEFARXY
x,y={ELGENEFARX},{ELGENEFARY}#enddef

#define ARRAHXY
x,y=2,58#enddef

#define MORNXY
x,y=30,58#enddef

#define AEGISXY
x,y=30,59#enddef

#define REMOVE_OBJECT FILTER OBJECT_ID
    [remove_object]
      {FILTER}
      object_id={OBJECT_ID}
    [/remove_object]
#enddef

# Naga hostage villages serpent controller
#define NVJ
x,y=19,22#enddef
#
# Naga hostage villages serpent controller bridge guards
#define NVG1
x,y=19,20#enddef
#define NVG2
x,y=19,24#enddef

# SE enclave locations
#define SE_ENCLAVE_FILTER
x=66-80
y=46-60
terrain=Cvr,Kvr,Hh^Es,Mm,Re^Vyer,Rb,Re^Es
#enddef

# Units required to be in enclave to start civil war
#define SE_ENCLAVE_REQUIRED
id=Aegis,Blok,Dawn,Elgenefar,Flynn,Krag,Morn
#enddef
#
#define WITHDRAWN_CONDITION COUNT
[have_unit]
  {SE_ENCLAVE_REQUIRED}
  side=1
  [filter_location]
    {SE_ENCLAVE_FILTER}
  [/filter_location]
  count={COUNT}
[/have_unit]
#enddef
#

#define ENEMY_LEADERS
  x=30,42,47,56
  y=28,27,23,11
  radius=1
#enddef

#define SIDE7_FILTER
    x=1-17,18-27,28-31,32-45
    y=1-24, 1-18, 1-16, 1-13
    terrain=!,W*^*
#enddef

#define SIDE7_AVOID
    x=13,21
    y=10,8
    radius=2
#enddef



[scenario]
  id=28_Solstice
  name=_"Solstice"
  next_scenario=29_Epilogue
  map_data="{~add-ons/AfterEI/maps/28_Solstice.map}"
  turns=-1 # i.e. unlimited
  victory_when_enemies_defeated=no

  {INTRO_AND_SCENARIO_MUSIC traveling_minstrels.ogg into_the_shadows.ogg}
  {EXTRA_SCENARIO_MUSIC onethousandsuns.ogg}

  [story]
    [part]
      title= _ "Errand Ended"
      music=traveling_minstrels.ogg
      story= _ "Morn arrived at Parthyn and surrendered the Null Stone to Gweddry.
 
Mission finally accomplished, they prepared to go their separate ways:
- The Mages would return to Alduin.
- Aegis and his riders were keen to add their tale to their clan's sagas.
- Jackery's folk eagerly anticipated resuming their rural lives.
 
They retired to an inn for a combined victory and farewell celebration.  Dawn asked a few locals if anyone had news concerning Flynn and was dismayed to hear he had very recently crossed the ford to do battle with the orcish horde.  They all swiftly changed their plans..."
      {MAPTRAX_28_BLUE}
    [/part]
    [part]
      show_title=no
      music=TravelstotheEast.ogg
      story= _ "Flynn reached the southern edge of the orc heartlands unchallenged."
      {MAPTRAX_28_FLYNN}
    [/part]
    [part]
      show_title=no
      story= _ "As his strategy neared fruition Flynn hoped his allies had overcome whatever perils had crossed their path and would be ready and waiting, or nearly so.  Hopefully the dwarves and ogres lay northwest of his own forces and the elves to the northeast.
 
If not then the coming battle would likely be brief, brutal, hopeless and unremembered."
      {MAPTRAX_28_STRATEGY}
    [/part]
    [part]
      show_title=yes
      music=silence.ogg
      story= _ "Unfortunately there was one ancient rule of warfare that he had overlooked..."
    [/part]
    [part]
      title= _ "<span color='yellow' style='italic' size='larger'>No plan survives first contact with the enemy.</span>"
      title_alignment=center
      sound=defeat2.ogg
    [/part]
  [/story]

# --- Schedule for first two turns ---
  {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
  {MORNING} {TOD_COLOR_SHIFT 5 5 0}

# Our heroes
  [side]
{FLYNN_LF}
    gold={MIN_START_GOLD_ELGENEFAR}	# *Elgenefar* starting gold (or carryover, if higher).
    {INCOME 3 2 1}
    shroud=yes
  [/side]

# Enemies
#
# Southern Warlord
  [side]
    side=2
    type=Orcish_Overlord
    id=Aknzlay
    name= _ "Aknzlay"
    [modifications]
      {TRAIT_FEARLESS}
      {TRAIT_INTELLIGENT}
      [object]				# Aknzlay wears a ring of regeneration (tracking container setup in prestart)
        name= _ "Green Ring"
        image=$ring_28.imagepath
        description= _ "This ring heals the wearer!"
        duration=forever
        [effect]
          apply_to=new_ability
          [abilities]
            {ABILITY_REGENERATES}
          [/abilities]
        [/effect]
      [/object]
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=Orcish Bladethrash, Orcish Bladestorm	# Force first unit recruited to be berserker type
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      [avoid]
{SIDE7_AVOID}
      [/avoid]
    [/ai]
    [ai]			# More aggressive out of daylight
      time_of_day=dusk,midnight,dawn,morning_shadowed,midday_shadowed,afternoon_shadowed
      aggression=0.9
      grouping=offensive
    [/ai]
    [ai]			# More cautious in daylight
      time_of_day=morning,midday,afternoon
      aggression=0.4
      grouping=defensive
    [/ai]
    color=black
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD 400 500 600}
#ifdef NO_FREE_UNIT_SPAWNS
    {INCOME 25 30 35} # ifdef-ed out because, instead of extra income, free units are spawned
#endif
    [unit]			# Shaman (controls serpents)
      type=aei_oshe
      id=serpent_controller
      {NVJ}
      moves=0
      generate_name=yes
      random_traits=yes
      random_gender=yes
      placement=map
      animate=no
      {IS_HERO}
    [/unit]
    [unit]			# Bridge guard 1
      type=Orcish Nightblade
      id=serpent_controller_guard1
      {NVG1}
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
    [unit]			# Bridge guard 2
      type=Orcish Nightblade
      id=serpent_controller_guard2
      {NVG2}
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
  [/side]

# SW leader
  [side]
    side=3
    type=Orcish Sovereign
    id=Behlend
    name= _ "Behlend"
    profile=portraits/transparent/shan_taum.png
    [modifications]
      {TRAIT_RESILIENT}
      {TRAIT_STRONG}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=Orcish Archer, Orcish Crossbowman, Orcish Slurbow, Orcish Grunt, Orcish Warrior, Orcish Warlord, Orcish Bladeflail, Orcish Bladethrash, Orcish Bladestorm, Orcish Leader, Orcish Ruler, Wolf Rider, Goblin Knight, Direwolf Rider
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      [avoid]
{SIDE7_AVOID}
      [/avoid]
    [/ai]
    [ai]			# More aggressive out of daylight
      time_of_day=dusk,midnight,dawn,morning_shadowed,midday_shadowed,afternoon_shadowed
      aggression=0.9
      grouping=offensive
    [/ai]
    [ai]			# More cautious in daylight
      time_of_day=morning,midday,afternoon
      aggression=0.4
      grouping=defensive
    [/ai]
    color=brown
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD 250 300 350}
#ifdef NO_FREE_UNIT_SPAWNS
    {INCOME 20 25 30} # ifdef-ed out because, instead of extra income, free units are spawned
#endif
  [/side]

# S leader
  [side]
    side=4
    type=Orcish Nightblade
    id=Noxyus
    name= _ "Noxyus"
    [modifications]
      {TRAIT_INTELLIGENT}
      {TRAIT_RESILIENT}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=Orcish Archer, Orcish Assassin, Orcish Slayer, Orcish Nightblade, Orcish Crossbowman, Orcish Slurbow, Goblin Pillager, Direwolf Rider, Giant Scorpling, Giant Scorpion
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      [avoid]
{SIDE7_AVOID}
      [/avoid]
    [/ai]
    [ai]			# More aggressive out of daylight
      time_of_day=dusk,midnight,dawn,morning_shadowed,midday_shadowed,afternoon_shadowed
      aggression=0.9
      grouping=offensive
    [/ai]
    [ai]			# More cautious in daylight
      time_of_day=morning,midday,afternoon
      aggression=0.4
      grouping=defensive
    [/ai]
    color=orange
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD 250 300 350}
#ifdef NO_FREE_UNIT_SPAWNS
    {INCOME 20 25 30} # ifdef-ed out because, instead of extra income, free units are spawned
#endif
  [/side]

# SE leader
  [side]
    side=5
    type=Orcish Warlord
    id=Znottiyanki
    name= _ "Znottiyanki"
    [modifications]
      {TRAIT_QUICK}
      {TRAIT_STRONG}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=Wolf Rider, Goblin Knight, Goblin Pillager, Direwolf Rider, Goblin Spearman, Goblin Impaler, Goblin Rouser, Orcish Ruler, Orcish Assassin, Orcish Archer, Orcish Crossbowman, Orcish Grunt, Orcish Warrior, Orcish Bladeflail, Orcish Bladethrash, Orcish Bladestorm
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      [avoid]
{SIDE7_AVOID}
      [/avoid]
    [/ai]
    [ai]			# More aggressive out of daylight
      time_of_day=dusk,midnight,dawn,morning_shadowed,midday_shadowed,afternoon_shadowed
      aggression=0.9
      grouping=offensive
    [/ai]
    [ai]			# More cautious in daylight
      time_of_day=morning,midday,afternoon
      aggression=0.4
      grouping=defensive
    [/ai]
    color=purple
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD 300 350 400}	# Bit extra to offset spiders
#ifdef NO_FREE_UNIT_SPAWNS
    {INCOME 27 30 33}	# Bit extra to offset spiders
#endif
  [/side]

  [side]
    side=6
    type=Naga Myrmidon
    id=Paddel
    name= _ "Paddel"
    [modifications]
      {TRAIT_RESILIENT}
      {TRAIT_STRONG}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=Naga Fighter, Naga Warrior, Naga Myrmidon, Naga Hunter, Naga Marksman, Naga Guardian, Naga Warden, Naga Sentinel
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      [avoid]
{SIDE7_AVOID}
      [/avoid]
    [/ai]
    {GOLD 150 200 250}
    color=blue
  [/side]

# Shaman defenders
  [side]
    side=7
    no_leader=yes		# Not present at start
    team_name=Orcs
    user_team_name= _ "Orcs"
    recruit=aei_oshn, aei_osh, Vampire Bat, Blood Bat, Dread Bat, AEI_Dire_Bat, Orcish Bladeflail, Orcish Bladethrash, Orcish Bladestorm, Orcish Ruler, Goblin Knight, Direwolf Rider
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
    [/ai]
    [ai]			# More aggressive out of daylight
      time_of_day=dusk,midnight,dawn,morning_shadowed,midday_shadowed,afternoon_shadowed
      aggression=0.9
      grouping=offensive
    [/ai]
    [ai]			# More cautious in daylight, but less so
      time_of_day=morning,midday,afternoon
      aggression=0.6
      grouping=defensive
    [/ai]
    color=teal
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    gold=0			# Inert at start
    income=-2			# Inert at start
  [/side]

# Yellow spiders in SE enclave (inert at first)
  [side]
    side=8
    no_leader=yes
    team_name=Spiders
    user_team_name= _ "Spiders"
    recruit=Yellow_Spider, Yellow_Spider_Large, Yellow_Spider_Huge
    controller=ai
    hidden=yes
    [ai]
      passive_leader=yes
      grouping=no
      [avoid]
{SIDE7_AVOID}
[or]
{ENEMY_LEADERS}
[/or]
      [/avoid]
    [/ai]
    color=gold
    {GOLD 280 290 300}
  [/side]

# Controlled serpents
# Will go feral and attack anyone (but preferentially orcs) if controlling shaman is killed
  [side]
    side=9
    no_leader=yes
    team_name=Orcs
    user_team_name= _ "Serpents"
    recruit=
    controller=ai
    [ai]
      caution=0.1		# Less concened about unfavourable terrain
      grouping=no
      [avoid]
{SIDE7_AVOID}
[or]
{ENEMY_LEADERS}
[/or]
      [/avoid]
    [/ai]
    hidden=yes
    color=green
    gold=0
    income=-2
    [unit]
      type=AEI_Shallows_Serpent
      x,y=13,25
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
    [unit]
      type=AEI_Shallows_Serpent
      x,y=14,24
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
    [unit]
      type=AEI_River_Serpent
#ifndef HARD
      x,y=21,21
#else
      x,y=21,22
#endif
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
    [unit]
      type=AEI_River_Serpent
      x,y=16,22
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
#ifndef EASY
    [unit]
      type=AEI_Shallows_Serpent
      x,y=17,21
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
#endif
#ifdef HARD
    [unit]
      type=AEI_Shallows_Serpent
      x,y=21,20
      generate_name=yes
      random_traits=yes
      random_gender=yes
      ai_special=guardian
      placement=map
      animate=no
    [/unit]
#endif
  [/side]


# --- Events ---

# Add Weak-Willed trait to Orc and Goblin recruitment (Wolf Riders have race=wolf)
# Here: 25% weak-willed and if so penalty is 40,50,60 or 70
{ADD_TRAIT_WW_ONLY race=goblin,orc,wolf 0,0,0,40,0,0,0,50,0,0,0,60,0,0,0,70}


# Amulet and Ring pickup and drop logic
{AEI_PICKDROP_AMULET}
{AEI_PICKDROP_RING}

# Extra strike (turquoise) ring pickup and drop logic
{AEI_PICKDROP_RING_ES}

# Gold band pickup and drop logic
{AEI_PICKDROP_GB}

# Regeneration (green) ring pickup and drop logic
{AEI_PICKDROP_RING_REGEN}

#ifdef __UNUSED__
    {AEI_PICKDROP_TEST_IF_UNAVAILABLE ring_02b}  # --- not needed
    {AEI_PICKDROP_TEST_IF_UNAVAILABLE amulet_03} # --- not needed
#endif


# Race-dependent dialogue
  [event]
    name=rspeak
    first_time_only=no
    [switch]
      variable=rspeak.r
      [case]
        value=bats	# Blok translates
        [message]
          speaker=Blok
          message= _ "Says bat: <i>$rspeak.o</i>"
         [/message]
      [/case]
      [case]
        value=dwarf
        [message]
          x,y=$rspeak.x,$rspeak.y
          message= _ "$rspeak.d"
        [/message]
      [/case]
      [case]
        value=elf,aei_wose
        [message]
          x,y=$rspeak.x,$rspeak.y
          message= _ "$rspeak.e"
        [/message]
      [/case]
      [case]
        value=human,naga
        [message]
          x,y=$rspeak.x,$rspeak.y
          message= _ "$rspeak.h"
        [/message]
      [/case]
      [case]
        value=ogre
        [message]
          x,y=$rspeak.x,$rspeak.y
          message= _ "$rspeak.o"
        [/message]
      [/case]
      [else]		# Default is lizard (least likely)
        [message]
          x,y=$rspeak.x,$rspeak.y
          message= _ "$rspeak.l"
        [/message]
      [/else]
    [/switch]
    [clear_variable]
      name=rspeak
    [/clear_variable]
  [/event]


# Dialogue spoken by Aknzlay or Behlend, depending upon who is alive
  [event]		
    name=dbyaorb_e
    first_time_only=no
    [if]
      [have_unit]		# Aknzlay alive
        id=Aknzlay
      [/have_unit]
    [then]
      [message]
        speaker=Aknzlay
        message= _ "$dbyaorb"
      [/message]
    [/then]
    [else]
      [message]		# If Aknzlay dead and shaman(s) alive, Behlend must also be alive (=defeat otherwise)
        speaker=Behlend
        message= _ "$dbyaorb"
      [/message]
    [/else]
    [/if]
    [clear_variable]
      name=dbyaorb
    [/clear_variable]
  [/event]


# Add role to recruited unit
  [event]
    name=prerecruit
    first_time_only=no
    [filter_second]
      side=1
    [/filter_second]
    [if]
      [variable]
        name=second_unit.id
        equals=Blok
      [/variable]
    [then]
    [modify_unit]
      [filter]
        x,y=$x1,$y1
      [/filter]
      side=1
      role=Krag
    [/modify_unit]
    [/then]
    [else]
    [modify_unit]
      [filter]
        x,y=$x1,$y1
      [/filter]
      side=1
      role=$second_unit.name
    [/modify_unit]
    [/else]
    [/if]
  [/event]


# --- First player unit to encounter Aknzlay events ---
#
# "Unpassive" Aknzlay and "unguardian" surviving borderguards
  [event]
    name=Aknzlay_not_passive
    [modify_side]
      side=2
      [ai]
        passive_leader=no	# Aknzlay now not passive
      [/ai]
    [/modify_side]
    [if]			# Any border guards still alive?
      [have_unit]
        side=2,3,4,5
        status=guardian
      [/have_unit]
    [then]			# Yes: "unguardian" border guards
      [modify_unit]
        [filter]
          side=2,3,4,5
           status=guardian
        [/filter]
        [status]
          guardian=no
        [/status]
      [/modify_unit]
      [set_variable]		# Append to Aknzlay's dialogue
        name=bg_attack_d
        value="  Borderguards, attack!"
      [/set_variable]
    [/then]
    [/if]
  [/event]
#
# First time dialogue non-invulnerable unit moves adjacent to Aknzlay
  [event]
    name=moveto
    [filter]
      side=1
      [filter_adjacent]
        canrecruit=yes
        side=2
      [/filter_adjacent]
    [/filter]
    [filter_condition]
      [have_unit]		# Unit is not invulnerable
        [not]
          status=invulnerable
        [/not]
        x,y=$x1,$y1
      [/have_unit]
    [/filter_condition]
    [set_variable]		# Changed if event below fires
      name=bg_attack_d
      value=""
    [/set_variable]
    [fire_event]
      name=Aknzlay_not_passive
    [/fire_event]
    [message]
      speaker=Aknzlay
      message= _ "You <i>dare</i> face me?  Fool!$bg_attack_d"
    [/message]
    [clear_variable]
      name=bg_attack_d
    [/clear_variable]
  [/event]
#
# First time dialogue invulnerable unit moves adjacent to Aknzlay
  [event]
    name=moveto
    [filter]
      side=1
      [filter_adjacent]
        canrecruit=yes
        side=2
      [/filter_adjacent]
    [/filter]
    [filter_condition]
      [have_unit]		# Unit is invulnerable
        status=invulnerable
        x,y=$x1,$y1
      [/have_unit]
    [/filter_condition]
    [set_variable]		# Changed if event below fires
      name=bg_attack_d
      value=""
    [/set_variable]
    [fire_event]
      name=Aknzlay_not_passive
    [/fire_event]
    [message]
      speaker=Aknzlay
      message= _ "Cowardly cheat, that potion won't last forever!  Flee <i>now</i> or fall, in the end, to the horde!  $bg_attack_d"
    [/message]
    [message]
      x,y=$x1,$y1
      message= _ "P'raps, but first ah'll be rid o' <i><b>yeh</b></i>, yeh mucklebucket o' orc-stools!"
    [/message]
    [clear_variable]
      name=bg_attack_d
    [/clear_variable]
  [/event]


# ----------------------------------------------------------------------------------------
# These items only available if player captured the orc treasure chest in 25_The_Caveguard
#
# Invulnerability potion logic
# (single use; no "AEI_PICKDROP_DROP" macro for this item)
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y=$28_inv.x,$28_inv.y
      side=1
    [/filter]
    [filter_condition]
      [variable]
        name=28_inv.bearer
        equals={AEI_AVAILABLE}
      [/variable]
    [/filter_condition]
    [if]
      [have_unit]
        x,y=$28_inv.x,$28_inv.y
        [not]
          race=dwarf
        [/not]
        side=1
      [/have_unit]
    [then]
      [set_variables]			# Remind player of label
        name=rspeak
        [value]
          d="Ooops!  This dialogue should never be issued.  Please report it as a bug (reference: ""28 potion moveto"").  Thanks!"
          e="The legible remainder of the label reads: ""... rock skin ... <b><span foreground='#ffff00'>FOR DWARVES ONLY</span></b> ..."".  Dwarves are many things, but they rarely commit deception to print."
          h="Hmmm, what's left of the label says: ""... rock skin ... <b><span foreground='#ffff00'>FOR DWARVES ONLY</span></b> ..."".  Dwarves rarely write false."
          l="Worn dwarf-sscript mosstly missssing but ssurviving sscrap doess ssay: ""... rock sskin ... <b><span foreground='#ffff00'>FOR DWARVESS ONLY</span></b> ..."".  Dwarvess ussually insscribe honesstly: I would trusst thiss sscript..."
          o="Label say broken: ""... skin rock ... <b><span foreground='#ffff00'>DWARVES ONLY FOR</span></b> ...""  Not dwarf me!"
          x=$28_inv.x
          y=$28_inv.y
          r=$unit.race
        [/value]
      [/set_variables]
      [fire_event]
        name=rspeak
      [/fire_event]
    [/then]
    [/if]
    [message]
      speaker=narrator
      message= _"Should $unit.name drink this potion?"
      image=$28_inv.imagepath
      [option]
        label= _"Yes"
        [command]
          [sound]
            name=potion.ogg
          [/sound]
          [set_variables]
            name=rspeak
            [value]
              d="Aargh!  It burns!"
              e="Aargh!  It burns!"
              h="Aargh!  It burns!"
              l="Aargh!  It burnss!"
              o="Aargh!  Burns it!"
              x=$28_inv.x
              y=$28_inv.y
              r=$unit.race
            [/value]
          [/set_variables]
          [fire_event]
            name=rspeak
          [/fire_event]
          [if]
            [have_unit]			# Only dwarves can survive drinking this potion
              x,y=$28_inv.x,$28_inv.y
              race=dwarf
              side=1
            [/have_unit]
          [then]
            [store_unit]
              variable=aei_temp_potion_gray
              [filter]
                x,y=$28_inv.x,$28_inv.y
              [/filter]
              kill=no
              mode=always_clear
            [/store_unit]
            [set_variable]
              name=potion_gray_damage
              value=$aei_temp_potion_gray.hitpoints
            [/set_variable]
            [set_variable]
              name=potion_gray_damage
              sub=1
            [/set_variable]
            [set_variable]
              name=potion_gray_end_turn
              value=$turn_number
            [/set_variable]
            [set_variable]
              name=potion_gray_end_turn
              add={POTION_INV_TURNS}
            [/set_variable]
            [harm_unit]
              [filter]
                x,y=$28_inv.x,$28_inv.y
              [/filter]
              animate=defender
              damage_type=fire
              amount=$potion_gray_damage
            [/harm_unit]
            [clear_variable]
              name=aei_temp_potion_gray,potion_gray_damage
            [/clear_variable]
            [object]
              take_only_once=yes
              id=aei_potion_inv
              name= _ "Gray Potion"
              image=$28_inv.imagepath
              description= _ "This potion confers invulnerability for {POTION_INV_TURNS} turns!"
              duration=scenario
              [effect]
                apply_to=status
                add=invulnerable
              [/effect]
            [/object]
            [sound]
              name=dwarf-laugh.wav
            [/sound]
            [unit_overlay]
              x,y=$x1,$y1
              image=items/potion-grey-overlay.png
            [/unit_overlay]
            [set_variable]
              name=28_inv.bearer
              to_variable=unit.id		# Record unit (makes potion unavailable)
            [/set_variable]
          [/then]
          [else]				# Player *was* warned (twice!)...
            [kill]
              x,y=$28_inv.x,$28_inv.y
              animate=yes
              fire_event=yes			# Defeat if drunk by leader or hero (i.e. Blok, Dawn et al)
            [/kill]
          [/else]
          [/if]
          [remove_item]
            x,y=$28_inv.x,$28_inv.y
            image=$28_inv.imagepath
          [/remove_item]
        [/command]
      [/option]
      [option]
        label= _"No"
        [command]
          [allow_undo]
          [/allow_undo]
        [/command]
      [/option]
    [/message]
  [/event]
#
# Invulnerability warning (start of last turn)
  [event]
    name=side 1 turn
    [filter_condition]
      [variable]
        name=turn_number
        equals=$potion_gray_end_turn
      [/variable]
      [have_unit]
        id=$28_inv.bearer
      [/have_unit]
    [/filter_condition]
    [message]
      speaker=$28_inv.bearer
      message=_"Mah potion's wearin' off!"
    [/message]
  [/event]
#
# Remove Invulnerability (end of last turn)
  [event]
    name=side 1 turn end
    [filter_condition]
      [variable]
        name=turn_number
        equals=$potion_gray_end_turn
      [/variable]
      [have_unit]
        id=$28_inv.bearer
      [/have_unit]
    [/filter_condition]
    [sound]
      name=magic-faeriefire-miss.ogg
    [/sound]
    {REMOVE_OBJECT id=$28_inv.bearer aei_potion_inv}
    [modify_unit]				# Remove status=unpoisonable
      [filter]
        id=$28_inv.bearer
      [/filter]
      [effect]
        apply_to=status
        remove=invulnerable
      [/effect]
    [/modify_unit]
    [remove_unit_overlay]
      id=$28_inv.bearer
      image=items/potion-grey-overlay.png
    [/remove_unit_overlay]
    [message]
      speaker=$28_inv.bearer
      message=_"Ach, it were guid while it lasted!"
    [/message]
    {AEI_PICKDROP_SETUP_UNAVAILABLE 28_inv}	# Make potion unavailable
  [/event]
#
# Axe pickup logic
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y=$28_axe.x,$28_axe.y
      side=1
    [/filter]
    [filter_condition]
      [variable]
        name=28_axe.bearer
        equals={AEI_AVAILABLE}
      [/variable]
    [/filter_condition]
    [if]
      [have_unit]
        x,y=$28_axe.x,$28_axe.y
        type_adv_tree=Dwarvish Fighter,Dwarvish Ulfserker
        side=1
      [/have_unit]
    [then]
      [message]
        speaker=narrator
        message= _"Should $unit.name pick up this axe?"
        image=$28_axe.imagepath
        [option]
          label= _"Aye, it has a braw heft!"
          [command]
            [object]
              name= _ "Dwarf Axe"
              image=$28_axe.imagepath
              description= _ "This axe greatly improves melee!"
              duration=forever
              [effect]
                apply_to=attack
                range=melee
                [set_specials]
                  mode=append
                  {WEAPON_SPECIAL_MAGICAL}
                  {WEAPON_SPECIAL_DRAIN}
                [/set_specials]
              [/effect]
              [effect]
                apply_to=attack
                increase_damage=2
              [/effect]
            [/object]
            [unit_overlay]
              x,y=$28_axe.x,$28_axe.y
              image=items/axe-overlay.png
            [/unit_overlay]
            [remove_item]
              x,y=$28_axe.x,$28_axe.y
              image=$28_axe.imagepath
            [/remove_item]
            [set_variable]
              name=28_axe.bearer
              to_variable=unit.id	# Record unit with item
            [/set_variable]
          [/command]
        [/option]
        [option]
          label= _"Nae, ah'm guid."
          [command]
            [allow_undo]
            [/allow_undo]
          [/command]
        [/option]
      [/message]
      [/then]
      [else]
        [set_variables]
          name=rspeak
          [value]
            d="This axe is nae guid tae me; a dwarf more skilled with axes would be a better wielder of it."
            e="This weapon is unsuitable: it is heavy, unrefined and inelegant "+{ASIDE _"just like its makers..."}
            h="Hmm, well-made but balanced for dwarves.  No use to me."
            l="Uss Ssaurianss sshun axess."
            o="Dwarves for axe made.  Not dwarf me!"
            x=$28_axe.x
            y=$28_axe.y
            r=$unit.race
          [/value]
        [/set_variables]
        [fire_event]
          name=rspeak
        [/fire_event]
        [allow_undo]
        [/allow_undo]
      [/else]
    [/if]
  [/event]
# If unit with axe killed, drop it (i.e. is pickuppable again)
{AEI_PICKDROP_DROP 28_axe}
#
# Thunderdust pickup logic
# (may explode, single use; no "AEI_PICKDROP_DROP" macro for this item)
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y=$28_dust.x,$28_dust.y
      side=1
    [/filter]
    [filter_condition]
      [variable]
        name=28_dust.bearer
        equals={AEI_AVAILABLE}
      [/variable]
    [/filter_condition]
    [if]
      [have_unit]
        x,y=$28_dust.x,$28_dust.y
        side=1
        type_adv_tree=Dwarvish Thunderer
      [/have_unit]
    [then]
      [message]
        speaker=narrator
        message= _"Should $unit.name pick up the thunderdust?"
        image=$28_dust.imagepath
        [option]
          label= _"Aye, ah'm feelin' lucky!"
          [command]
            [object]
              name= _ "Thunderdust"
              image=$28_dust.imagepath
              description= _ "This dust enhances ranged attacks!"
              duration=forever
              [effect]
                apply_to=attack
                range=ranged
                [set_specials]
                  {WEAPON_SPECIAL_MAGICAL}
                [/set_specials]
              [/effect]
              [effect]
                apply_to=attack
                range=ranged
                increase_damage=10
              [/effect]
            [/object]
            [unit_overlay]
              x,y=$28_dust.x,$28_dust.y
              image=items/leather-pack-overlay.png
            [/unit_overlay]
            [remove_item]
              x,y=$28_dust.x,$28_dust.y
              image=$28_dust.imagepath
            [/remove_item]
            [set_variable]
              name=28_dust.bearer
              to_variable=unit.id	# Record unit with item
            [/set_variable]
          [/command]
        [/option]
        [option]
          label= _"Nae, ah dinna want tae blow mehself up!"
          [command]
            [allow_undo]
            [/allow_undo]
          [/command]
        [/option]
      [/message]
      [/then]
      [else]
        [set_variables]
          name=rspeak
          [value]
            d="Ah cannae use this Thunderdust!"
            e="Dwarves may be happy to lug explosives around.  I am not!"
            h="Do I look like a dwarf?"
            l="Thiss dusst is unsstable, unssafe and thuss usselessss to uss ssaurianss."
            o="Not dwarf me!"
            x=$28_dust.x
            y=$28_dust.y
            r=$unit.race
          [/value]
        [/set_variables]
        [fire_event]
          name=rspeak
        [/fire_event]
        [allow_undo]
        [/allow_undo]
      [/else]
    [/if]
  [/event]
#
# Thunderdust failure (4%) check events (fires whenever an attacks misses)
  [event]			# Attack misses
    name=attacker misses
    first_time_only=no
    [filter]
      id=28_dust.bearer
    [/filter]
    [filter_condition]
      [variable]		# Ranged attack
        name=weapon.range
        equals=ranged
      [/variable]
    [/filter_condition]
    [set_variable]
      name=28_dust_missed_count	# Increment (missed) attack count
      add=1
    [/set_variable]
    [fire_event]
      name=28_dust_fail_check
    [/fire_event]
  [/event]
#
  [event]			# Can also happen when defending...
    name=defender misses
    first_time_only=no
    [filter_second]
      id=28_dust.bearer
    [/filter_second]
    [filter_condition]
      [variable]		# Ranged attack
        name=weapon.range
        equals=ranged
      [/variable]
    [/filter_condition]
    [set_variable]
      name=28_dust_missed_count	# Increment (missed) attack count
      add=1
    [/set_variable]
    [fire_event]
      name=28_dust_fail_check
    [/fire_event]
  [/event]
#
  [event]
    name=28_dust_fail_check
    first_time_only=no
    [filter_condition]
      [variable]		# Safe attack count exceeded
        name=28_dust_missed_count
        greater_than={DUST_SAFE_ATTACKS}
      [/variable]
      [variable]		# Unit not invulnerable
        name=28_dust.bearer
        not_equals=$28_inv.bearer
      [/variable]
    [/filter_condition]
    [store_unit]
      variable=aei_temp_dust
      [filter]
        id=$28_dust.bearer
      [/filter]
      kill=no
      mode=always_clear
    [/store_unit]
    [set_variable]		# Fail chance =5% (1 in 20)
      name=28_dust_fail_chance
      rand=1..20
    [/set_variable]
    [if]
      [variable]		# Unlucky
        name=28_dust_fail_chance
        equals=1
      [/variable]
    [then]
      [sound]
        name=flame-big.ogg
      [/sound]
      [for]
        variable=i
        start=1
        end=16
        step=1
        [do]
          [set_variable]
            name=28_dust_fail_sequence
            formula='projectiles/fireball-impact-'..'"$i"'..'.png'
          [/set_variable]
          [item]
            halo=$28_dust_fail_sequence
            x,y=$aei_temp_dust.x,$aei_temp_dust.y
          [/item]
          [delay]
            time=200
          [/delay]
          [remove_item]
            halo=$28_dust_fail_sequence
            x,y=$aei_temp_dust.x,$aei_temp_dust.y
          [/remove_item]
        [/do]
      [/for]
      [clear_variable]
        name=28_dust_fail_sequence
      [/clear_variable]
      [kill]
        id=$28_dust.bearer
        animate=yes
        fire_event=yes		# Shouldn't do anything but =yes in case I change something...
      [/kill]
    [/then]
    [else]
      [if]
        [variable]		# Dialogue if disaster barely avoided...
          name=28_dust_fail_chance
          less_than=5
        [/variable]
      [then]
        [message]
          speaker=$28_dust.bearer
          message= _ "Fregglegrit!  That were close... almost blew mehself up!"
        [/message]
      [/then]
      [/if]
    [/else]
    [/if]
    [clear_variable]
      name=28_dust_fail_chance,aei_temp_dust
    [/clear_variable]
  [/event]
# ----------------------------------------------------------------------------------------


# Create guardians of random type
  [event]
    name=cgort
    first_time_only=no
    [for]
      array=cgort_locations
      variable=i
      [do]
        [set_variable]
          name=cgort_type
          rand=$cgort_tlist
        [/set_variable]
        [set_variable]		# 40% chance of being weak-willed
          name=ww_penalty
          rand=0,0,0,0,0,0,40,50,60,70
        [/set_variable]
        [switch]
          variable=ww_penalty
          [case]
            value=40,50,60,70
            [unit]
              side=$cgort_side
              type=$cgort_type
              x,y=$cgort_locations[$i].x,$cgort_locations[$i].y
              generate_name=yes
              [modifications]
                [trait]
                  id="weakwilled$ww_penalty"
                  male_name= _ "weak-willed"
                  female_name= _ "female^weak-willed"
                  description= _ "Suffers increased damage from magic"
                  [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                      fire=$ww_penalty
                      arcane=$ww_penalty
                   [/resistance]
                 [/effect]
               [/trait]
              [/modifications]
              random_traits=yes
              random_gender=yes
              ai_special=guardian
              placement=map
              animate=yes
            [/unit]
          [/case]
          [else]
            [unit]
              side=$cgort_side
              type=$cgort_type
              x,y=$cgort_locations[$i].x,$cgort_locations[$i].y
              generate_name=yes
              random_traits=yes
              random_gender=yes
              ai_special=guardian
              placement=map
              animate=yes
            [/unit]
          [/else]
        [/switch]
        [clear_variable]
          name=cgort_type,ww_penalty
        [/clear_variable]
      [/do]
    [/for]
    [clear_variable]
      name=cgort_tlist,cgort_side,cgort_locations
    [/clear_variable]
  [/event]


# Dialogue first time a berserker type is recruited
  [event]
    name=recruit
    [filter]
      type=Orcish Bladeflail, Orcish Bladethrash, Orcish Bladestorm
    [/filter]
    [allow_recruit]
      side=2
      type=Orcish Slurbow, Orcish Warlord, Orcish Slayer, Orcish Nightblade, Orcish Sovereign, aei_osh, aei_oshe, Goblin Knight, Goblin Pillager, Direwolf Rider, Blood Bat, Dread Bat, AEI_Dire_Bat
    [/allow_recruit]
    [message]
      speaker=unit
      message= _ "Warbeersh make me shtrong!  Now to kill shomething!"
    [/message]
    [message]
      speaker=Dirk
      message= _ "Sire, these orcs appear to have warriors akin to berserkers!"
    [/message]
  [/event]

# Tent villages destroyed if captured by orc or goblin
  [event]
    name=capture
    first_time_only=no
    [filter]
      race=goblin,orc,wolf
      [filter_location]
        terrain=Gg^Vct
      [/filter_location]
    [/filter]
    [sound]
      name=torch.ogg
    [/sound]
    [delay]
      time=200
    [/delay]
    [sound]
      name=cave-in.ogg
    [/sound]
    [terrain]
      x,y=$x1,$y1
      terrain=Rb
    [/terrain]
    [redraw]
    [/redraw]
  [/event]
#
  [event]
    name=capture
    [filter]
      race=goblin,orc,wolf
      [filter_location]
        terrain=Gg^Vct
      [/filter_location]
    [/filter]
    [message]
      x,y=$x1,$y1
      message = _ "Burn!  Haha!"
    [/message]
  [/event]


# First non-bat/elf/aquatic unit to cross stepping stones drowns
  [event]
    name=enter_hex
    [filter]
      x,y=61,56
      [not]
        race=bats,elf,merman,naga
      [/not]
      [not]
        type=AEI_River_Serpent,AEI_Shallows_Serpent
      [/not]
    [/filter]
    [cancel_action]		# Interrupt movement if necessary
    [/cancel_action]
    [message]
      # TODO: make this race-dependent dialogue:
      speaker=unit
      message=_"Aieee! These stepping stones are crumbling!"
    [/message]
    [sound]
      name=water-blast.wav
    [/sound]
    [remove_item]
      image=scenery/castle-ruins3.png
      x,y=61,56
    [/remove_item]
    [terrain]
      x,y=61,56
      terrain=Wo
    [/terrain]
    [remove_item]
      image=scenery/castle-ruins2.png
      x,y=60,56
    [/remove_item]
    [remove_item]
      image=scenery/castle-ruins.png
      x,y=62,55
    [/remove_item]
    [terrain]
      x=60,62
      y=56,55
      terrain=Ww
    [/terrain]
    [kill]
      x,y=61,56
      animate=yes
      fire_event=yes
    [/kill]
  [/event]


# SE enclave moveto
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
        {SE_ENCLAVE_FILTER}
      [/filter_location]
    [/filter]
    [set_variable]		# Switch off spider leader respawn
      name=ysl_respawn
      value=no
    [/set_variable]
    [remove_shroud]		# Unshroud enclave
      side=1
      x=66-81
      y=46-61
      terrain=Cvr,Kvr,Hh^Es,Mm,Re^Vyer,Rb,Re^Es
    [/remove_shroud]
    [fire_event]
      name=ysl_create
    [/fire_event]
    [gold]
      side=8
#ifdef EASY
      amount=340
#endif
#ifdef NORMAL
      amount=400
#endif
#ifdef HARD
      amount=460
#endif
    [/gold]
  [/event]
#
# Create spider leader
  [event]
    name=ysl_create
    [unit]
      side=8
      type=Yellow_Spider_Huge
      name= _ "Huge Yellow Spider"
      x,y=77,59
      canrecruit=yes
      [modifications]
        {TRAIT_RESILIENT}
        {TRAIT_STRONG}
      [/modifications]
      generate_name=yes
      random_traits=no
      random_gender=yes
      animate=yes
    [/unit]
  [/event]


#
# --- Wolf recruitment fail events ---
# --- WILL ONLY BE USED IF FROM 23a2_Southern_Wolfpacks ---
#
# *** Superceded: now use return guardian micro_ai ***
#
#ifdef FREEZE_WOLVES_MANUALLY
# Alpha and beta wolves stay put until Aknzlay killed
  [event]
    name=side 5 turn refresh
    first_time_only=no
    [filter_condition]
      [have_unit]
        id=Aknzlay,Znottiyanki
        count=2
      [/have_unit]
    [/filter_condition]
    [modify_unit]
      [filter]
        id=side5_alpha,side5_beta
      [/filter]
      moves=0
    [/modify_unit]
  [/event]
#endif

  [event]		# First time dialogue for recruit fail
    name=rfw_ftd
    [if]
      [variable]
        name=rwf_leader
        equals=Znottiyanki
      [/variable]
    [then]		# Alternative dialogue for side 5 (very unlikely, but possible!)
      [message]
        speaker=$rwf_leader
        message= _ "Oh no... we have run out of wolves!"
      [/message]
    [/then]
    [else]
      [message]
        speaker=$rwf_leader
        message= _ "Maggot!  Why are you wolf-less?"
      [/message]
      [message]
        x,y=$rwf_rx,$rwf_ry
        message= _ "-Gulp- ... Humans attack.  Lots wolfs gone.  Please not kill me!"
      [/message]
      [message]
        speaker=$rwf_leader
        message= _ "Then begone from my sight!  Fight!  Die quickly, useless bootcrud!"
      [/message]
      [message]
        speaker=Znottiyanki
        message= _ {ASIDE _"Hah!  I have my own supply of wolves."}
      [/message]
    [/else]
    [/if]
  [/event]
#
# Spawn enemy unit
  [event]
    name=spawn_enemy_unit
    first_time_only=no
    [set_variable]		# 40% chance of being weak-willed
      name=ww_penalty
      rand=0,0,0,0,0,0,40,50,60,70
    [/set_variable]
    [switch]			# Replace with Goblin Spearman
      variable=ww_penalty
      [case]
        value=40,50,60,70
        [unit]
          x,y=$spawn_eu.x,$spawn_eu.y
          side=$spawn_eu.s
          type=$spawn_eu.t
          generate_name=yes
          [modifications]
            [trait]
              id="weakwilled$ww_penalty"
              male_name= _ "weak-willed"
              female_name= _ "female^weak-willed"
              description= _ "Suffers increased damage from magic"
              [effect]
                apply_to=resistance
                replace=no
                [resistance]
                  fire=$ww_penalty
                  arcane=$ww_penalty
                [/resistance]
              [/effect]
            [/trait]
          [/modifications]
          random_traits=yes
          random_gender=yes
          placement=map
          moves=0
          placement=map
          passable=yes
          animate=yes
        [/unit]
      [/case]
      [else]
        [unit]
          x,y=$spawn_eu.x,$spawn_eu.y
          side=$spawn_eu.s
          type=$spawn_eu.t
          generate_name=yes
          random_traits=yes
          random_gender=yes
          placement=map
          moves=0
          placement=map
          passable=yes
          animate=yes
        [/unit]
      [/else]
    [/switch]
    [clear_variable]
      name=ww_penalty,spawn_eu
    [/clear_variable]
  [/event]
#
  [event]
    name=recruit
    first_time_only=no
    [filter]
      type_adv_tree=Wolf Rider
    [/filter]
    [filter_condition]
      [variable]
        name=recruit_fail_wolf
        greater_than=0
      [/variable]
      [and]
        [variable]
           name=side_number
           not_equals=5
        [/variable]
        [or]
          [have_unit]		# Side 5 only affected once both alpha and beta wolves dead
            id=side5_alpha,side5_beta
            count=0
          [/have_unit]
        [/or]
      [/and]
    [/filter_condition]
    [set_variable]
      name=rfw_chance
      rand=1..10
    [/set_variable]
    [if]
      [variable]		# Recruitment fail
        name=rfw_chance
        less_than_equal_to=$recruit_fail_wolf
      [/variable]
    [then]
      [kill]
        x,y=$x1,$y1
        animate=yes
      [/kill]
      [set_variables]
        name=spawn_eu
        [value]
          x=$x1
          y=$y1
          s=$second_unit.side
          t="Goblin Spearman"
        [/value]
      [/set_variables]
      [fire_event]		# Spawn goblin spearman
        name=spawn_enemy_unit
      [/fire_event]
      [set_variable]		# First time dialogue
        name=rwf_leader
        value=$second_unit.id
      [/set_variable]
      [set_variable]
        name=rwf_rx
        value=$x1
      [/set_variable]
      [set_variable]
        name=rwf_ry
        value=$y1
      [/set_variable]
      [fire_event]
        name=rfw_ftd
      [/fire_event]
      [clear_variable]
        name=rwf_leader,rwf_rx,rwf_ry
      [/clear_variable]
    [/then]
    [/if]
    [clear_variable]
      name=rfw_chance
    [/clear_variable]
  [/event]


# --- Random spawn events ---
#
# The horde gathering is manifested as additional units being spawned
#
# Spawn unit first time dialogue
# Possible (but unlikely) that Dirk is already dead
  [event]
    name=rs_ftd
    [delay]	# Focus should be on spawned unit so wait a short while
      time=250
    [/delay]
    [if]
      [have_unit]
        id=Dirk
      [/have_unit]
    [then]		# Dirk alive (very likely)
      [message]
        speaker=Dirk
        message= _ "Sire!  Ever more enemies appear!  The horde musters!"
      [/message]
      [message]
        speaker=Flynn
        message= _ "Their numbers preclude victory through battle: even if we kill every enemy now before us, they will be replaced ten-fold and more.  Sowing discord between them is our only hope!"
      [/message]
    [/then]
    [else]		# No Dirk; Flynn issues alternative dialogue
      [message]
        speaker=Flynn
        message= _ "The horde musters.  Their numbers preclude victory through battle: even if we kill every enemy now before us, they will be replaced ten-fold and more.  Sowing discord between them is our only hope!"
      [/message]
    [/else]
    [/if]
  [/event]
#
# While Aknzlay alive they join side 2.
# Otherwise they are on side 3,4,5 as indicated in the code.
# Spawn rate increases when:
# 1 - All player leaders arrived
# 2 - As 1 + Aknzlay or all shamans dead
# 3 - As 1 + withdrawal
#
# Note: until all player leaders arrive, spawn rate will be at lowest setting
#
  [event]
    name=rs
    first_time_only=no
    [if]
      [have_unit]			# Aknzlay alive so...
        id=Aknzlay
      [/have_unit]
    [then]
      [set_variable]			# ...units all side 2
        name=rs.s
        value=2
      [/set_variable]
    [/then]
    [/if]
    [if]				# Specify spawn rate
      [have_unit]
        id=Arrah, Elgenefar, Krag, Morn
        count=4
      [/have_unit]
    [then]				# All player leaders arrived
      [if]
        [variable]			# Withdraw begun (Aknzlay and all shamans dead)
          name=28_withdraw
          equals=yes
        [/variable]
      [then]
        [set_variable]			# **** Highest spawn rate: get outta there! ****
          name=rs_num_units
#ifdef EASY				# 1+, average: 2.00
          rand=1,2,3
#endif
#ifdef NORMAL				# 2+, average: 2.50
          rand=2,3
#endif
#ifdef HARD				# 2+, average: 3.00
          rand=2,3,4
#endif
        [/set_variable]
      [/then]
      [else]
        [if]
          [have_unit]			# Aknzlay dead -OR-
            id=Aknzlay
            count=0
          [/have_unit]
          [or]
          [have_unit]			# All orc shamans slain...
            type=aei_oshn,aei_osh,aei_oshe
            count=0
          [/have_unit]
          [have_location]		# ...and all bat caves revealed
            {CE_ALL_XY}
            terrain=Mm^Xm
            count=0
          [/have_location]
          [/or]
        [then]
          [set_variable]		# *** Second highest spawn rate: annoying ***
            name=rs_num_units
#ifdef EASY				# 0: 25%, average: 1.25
        rand=0,1,2,2
#endif
#ifdef NORMAL				# 0: 25%, average: 1.50
        rand=0,1,2,3
#endif
#ifdef HARD				# 0: 25%, average: 1.75
        rand=0,0,1,2,2,3,3,3
#endif
          [/set_variable]
        [/then]
        [else]				# Aknzlay and 1+ shaman alive, all player leaders arrived
          [set_variable]		# ** Third highest spawn rate: becoming irritating **
            name=rs_num_units
#ifdef EASY				# 0: 40%, average: 0.80
            rand=0,0,1,1,2
#endif
#ifdef NORMAL				# 0: 40%, average: 0.90
            rand=0,0,0,0,1,1,1,2,2,2
#endif
#ifdef HARD				# 0: 40%, average: 1.00
            rand=0,0,1,2,2
#endif
          [/set_variable]
        [/else]
        [/if]
      [/else]
      [/if]
    [/then]
    [else]				# Not all player leaders yet arrived
      [set_variable]			# * Lowest spawn rate: nuisance value *
        name=rs_num_units
#ifdef EASY				# 0: 60%, average: 0.50
          rand=0,0,0,0,0,0,1,1,1,2
#endif
#ifdef NORMAL				# 0: 60%, average: 0.60
          rand=0,0,0,1,2
#endif
#ifdef HARD				# 0: 50%, average: 0.70
          rand=0,0,0,0,0,1,1,1,2,2
#endif
      [/set_variable]
    [/else]
    [/if]
    [if]
      [variable]			# Now maybe spawn something...
        name=rs_num_units
        greater_than=0
      [/variable]
    [then]
      [for]
        variable=i
        start=1
        end=$rs_num_units
        step=1
        [do]
          [if]
            [variable]
              name=i
              equals=2
            [/variable]
          [then]
            [set_variable]		# Append unaccompanied units, if any
              name=rs.t
              value="$rs.t|$rs.t2"
            [/set_variable]
          [/then]
          [/if]
          [set_variable]		# Determine unittype
            name=rs_unittype
            rand=$rs.t
          [/set_variable]
          [switch]			# $recruit_fail_wolf logic applies to spawned units too :-)
            variable=rs_unittype
            [case]
              value="Wolf Rider","Goblin Knight","Goblin Pillager","Direwolf Rider"
              [set_variable]
                name=rfw_chance
                rand=1..10
              [/set_variable]
              [if]
                [variable]		# Recruitment fail
                  name=rfw_chance
                  less_than_equal_to=$recruit_fail_wolf
                [/variable]
              [then]
                [set_variable]
                  name=rs_unittype
                  value="Goblin Spearman"
                [/set_variable]
              [/then]
              [/if]
              [clear_variable]
                name=rfw_chance
              [/clear_variable]
            [/case]
          [/switch]
          [switch]			# Assign alternate x,y for wolves and goblins
            variable=rs_unittype
            [case]
              value="Wolf Rider","Goblin Knight","Goblin Pillager","Direwolf Rider","Goblin Spearman","Goblin Impaler","Goblin Rouser","Goblin Spearman","Goblin_Spearling"
              [set_variables]
                name=spawn_eu
                [value]
                  x=$rs.x_g
                  y=$rs.y_g
                  s=$rs.s
                  t=$rs_unittype
                [/value]
              [/set_variables]
            [/case]
            [else]
              [set_variables]
                name=spawn_eu
                [value]
                  x=$rs.x
                  y=$rs.y
                  s=$rs.s
                  t=$rs_unittype
                [/value]
              [/set_variables]
            [/else]
          [/switch]
          [fire_event]		# Create enemy unit
            name=spawn_enemy_unit
          [/fire_event]
          [fire_event]		# First time dialogue
            name=rs_ftd
          [/fire_event]
          [clear_variable]
            name=rs_unittype
          [/clear_variable]
       [/do]
      [/for]
    [/then]
    [/if]
    [clear_variable]
      name=rs,rs_num_units
    [/clear_variable]
  [/event]
#
  [event]
    name=side 3 turn end
    first_time_only=no
    [set_variables]
      name=rs
      [value]
        x=1
        y=27
        s=3
        t="Orcish Archer,Orcish Archer,Orcish Grunt,Orcish Leader,Orcish Ruler,Orcish Crossbowman,Orcish Warrior,Orcish Slurbow"
        t2=""
      [/value]
    [/set_variables]
    [fire_event]
      name=rs
    [/fire_event]
  [/event]
#
  [event]
    name=side 4 turn end
    first_time_only=no
    [set_variables]
      name=rs
      [value]
        x=42
        y=1
        s=4
        t="Orcish Archer,Orcish Assassin,Orcish Crossbowman,Orcish Slayer,Orcish Nightblade"
        t2=",Giant Scorpling,Giant Scorpion"
      [/value]
    [/set_variables]
    [fire_event]
      name=rs
    [/fire_event]
  [/event]
#
  [event]
    name=side 5 turn end
    first_time_only=no
    [set_variables]
      name=rs
      [value]		# Wolves and goblins appear in different places
        x_g=80		# Goblin and wolf x co-ordinate
        y_g=11		# Goblin and wolf y co-ordinate
        x=53		# Orc x co-ordinate
        y=1		# Orc y co-ordinate
        s=5
        t="Orcish Archer,Orcish Archer,Orcish Crossbowman,Orcish Grunt,Orcish Grunt,Orcish Warrior,Orcish Warlord,Orcish Bladeflail,Orcish Bladeflail,Orcish Bladeflail,Orcish Bladethrash,Orcish Bladethrash,Orcish Bladestorm,Goblin Impaler,Goblin Rouser,Wolf Rider,Goblin Knight,Goblin Pillager,Direwolf Rider,Goblin Spearman,Goblin_Spearling"
        t2=""
      [/value]
    [/set_variables]
    [fire_event]
      name=rs
    [/fire_event]
  [/event]

# --- End random spawn events ---


#
# --- Antidote potion events ---
# --- WILL ONLY BE USED IF FROM 23b2_Southern_Assassins ---
#
# Moveto antidote potion (if any) - human location
{POTION_MOVETO {POTIONX_H} {POTIONY_H} antidotes_saved_h Flynn}
#
# Moveto antidote potion (if any) - dwarf location
{POTION_MOVETO {POTIONX_D} {POTIONY_D} antidotes_saved_d Krag}
#
# Moveto antidote potion (if any) - elf location
{POTION_MOVETO {POTIONX_E} {POTIONY_E} antidotes_saved_e Elgenefar}


#
# --- Messenger events (also see die events section) ---
#
# Remove gohere at MD_SOUTHXY
  [event]
    name=remove_md_southxy
    [remove_item]
      {MD_SOUTHXY}
      image=items/gohere.png
    [/remove_item]
  [/event]
#
  [event]			# Dwarf reaches gohere at MD_SOUTHXY
    name=moveto
    [filter]
      id=m_d
      {MD_SOUTHXY}
    [/filter]
    [fire_event]
      name=remove_md_southxy
    [/fire_event]
  [/event]
#
# Remove both goheres (KRAGXY and MD_SOUTHXY)
  [event]
    name=md_cleanup
    [remove_item]
      {KRAGXY}
    [/remove_item]
    [fire_event]
      name=remove_md_southxy
    [/fire_event]
  [/event]
#
# Remove Dwarf messenger mountain hides ability
  [event]
    name=md_unhide
    {REMOVE_OBJECT id=m_d aei_mountain_hide}
  [/event]
#
  [event]			# Dwarf loses [hides] if not in mountains
    name=moveto
    [filter]
      id=m_d
      [filter_location]
        terrain=!,Mm
      [/filter_location]
    [/filter]
    [fire_event]
      name=md_unhide
    [/fire_event]
    [modify_unit]
      [filter]
        id=m_d
      [/filter]
      role=Krag
    [/modify_unit]
  [/event]
#
  [event]			# Dwarf reaches destination
    name=moveto
    [filter]
      id=m_d
      {KRAGXY}
    [/filter]
    [fire_event]
      name=md_cleanup
    [/fire_event]
    [fire_event]
      name=md_unhide
    [/fire_event]
    [redraw]
    [/redraw]
    [modify_unit]
      [filter]
        id=m_d
      [/filter]
      role=Krag
    [/modify_unit]
    [heal_unit]
      [filter]
        id=m_d
      [/filter]
      amount=full
      animate=no
      restore_statuses=yes
    [/heal_unit]
    [store_unit]
      variable=aei_temp_messenger
      [filter]
        id=m_d
      [/filter]
      kill=no			# Kill separately to ensure die event doesn't fire?
      mode=always_clear
    [/store_unit]
    [kill]
      id=m_d
      animate=no
      fire_event=no		# Do not lose potions (if any)
    [/kill]
    [unstore_unit]
      variable=aei_temp_messenger
      x,y=recall,recall		# Add to Krag's recall (role=Krag)
    [/unstore_unit]
    {CLEAR_VARIABLE aei_temp_messenger}
  [/event]
#
# Remove gohere at ELGENEFARXY
  [event]
    name=me_cleanup
    [remove_item]
      {ELGENEFARXY}
    [/remove_item]
  [/event]
#
# Remove Elf messenger ambush ability
  [event]
    name=me_unhide
    {REMOVE_OBJECT id=m_e aei_ambush}
  [/event]
#
  [event]			# Elf loses ambush if not in forest
    name=moveto
    [filter]
      id=m_e
      [filter_location]
        [not]
          terrain=*^F*
        [/not]
      [/filter_location]
    [/filter]
    [fire_event]
      name=me_unhide
    [/fire_event]
  [/event]
#
  [event]			# Elf reaches destination
    name=moveto
    [filter]
      id=m_e
      {ELGENEFARXY}
    [/filter]
    [fire_event]
      name=me_cleanup
    [/fire_event]
    [fire_event]
      name=me_unhide
    [/fire_event]
    [redraw]
    [/redraw]
    [heal_unit]
      [filter]
        id=m_e
      [/filter]
      amount=full
      animate=no
      restore_statuses=yes
    [/heal_unit]
    [store_unit]
      variable=aei_temp_messenger
      [filter]
        id=m_e
      [/filter]
      kill=no			# Kill separately to ensure die event doesn't fire?
      mode=always_clear
    [/store_unit]
    [kill]
      id=m_e
      animate=no
      fire_event=no		# Do not lose potions (if any)
    [/kill]
    [unstore_unit]
      variable=aei_temp_messenger
      x,y=recall,recall		# Add to Elgenefar's recall (role=Elgenefar)
    [/unstore_unit]
    {CLEAR_VARIABLE aei_temp_messenger}
  [/event]


#
# --- Bat/Shaman events ---
#
# Shaman in cave village stays put
  [event]
    name=side 7 turn refresh
    first_time_only=no
    [modify_unit]
      [filter]
        id=colony1_shaman,colony2_shaman,colony3_shaman
      [/filter]
      moves=0
    [/modify_unit]
  [/event]
#
# Create colony controller (Elder Shaman)
  [event]
    name=create_colony_controller
    first_time_only=no
    [unit]
      side=7
      type=aei_oshe
      id=$ces.id
      x,y=$ces.x,$ces.y
      name=$ces.n
      moves=0
      generate_name=no
      random_traits=yes
      random_gender=yes
      placement=map
      animate=no
      {IS_HERO}
    [/unit]
    [clear_variable]
      name=ces
    [/clear_variable]
  [/event]
#
# Create Shaman defenders
  [event]
    name=create_shaman_defenders
    [unit]
      side=7
      type=aei_oshe
      id=Sputuhm
      name="Sputuhm"
      x,y=13,10
      canrecruit=yes
      generate_name=yes
      placement=map
      animate=yes
    [/unit]
    [allow_extra_recruit]
      id=Sputuhm
      extra_recruit=aei_oshe, Goblin Pillager, Orcish Slayer
    [/allow_extra_recruit]
    [modify_side]
      side=7
      {GOLD 250 300 350}
      {INCOME 20 25 30}
    [/modify_side]
    [modify_ai]			# Clear existing avoids
      [filter_side]
        side=2-9
      [/filter_side]
      action=try_delete
      path=aspect[avoid].facet[*]
    [/modify_ai]
    [modify_side]
      [filter_side]
        side=8,9
      [/filter_side]
      [ai]
        [avoid]
{ENEMY_LEADERS}
        [/avoid]
      [/ai]
    [/modify_side]
    [message]
      speaker=Sputuhm
      message= _ "Mhucus you drunken sot, asleep again?  Wake up!  Intruders!"
    [/message]
    [unit]
      side=7
      type=aei_osh
      id=Mhucus
      name="Mhucus"
      profile="portraits/transparent/orcish-shaman.png"
      x,y=21,8
      canrecruit=yes
      placement=map
      animate=yes
    [/unit]
    [allow_extra_recruit]
      id=Mhucus
      extra_recruit=Orcish Crossbowman, Wolf Rider, Orcish Assassin
    [/allow_extra_recruit]
    [message]
      speaker=Mhucus
     message= _ "Aw shuttit gobby, <i><b>you</b></i> are on watch.  <i><b>I</b></i> am off duty so am allowed an ale "+{ASIDE _"or ten"}+ "."
    [/message]
  [/event]
#
# Create shaman defenders if (visible) player unit moves into their territory
# (Also created when the dwarves arrive)
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
{SIDE7_FILTER}
        [not]			# Allow unit to retreat from Krag/Morn tunnel
          {TKM_KRAGXY}
          radius=1
        [/not]
      [/filter_location]
      [not]			# Exclude dwarf scout *if* can still hide in mountains
        role=mhides		# Event to check if dwarf loses mountain hides fires earlier
      [/not]
    [/filter]
    [fire_event]
      name=create_shaman_defenders
    [/fire_event]
    [allow_undo]
    [/allow_undo]
  [/event]
#
# Colony shaman bat spawn events
#
# Spawn random bat(s) - mostly Vampire bats (probably)
# $spawn_data.n contains the number of "levels" of bat to be spawned
# "Costs" are Vampire Bat=1, Blood Bat=2, Dire/Dread Bat=3
# If possible, bats appear in chasm hexes adjacent to the shaman controller
  [event]
    name=spawn_bat
    first_time_only=no
    [filter_condition]
      [have_unit]			# Count bats in cave
        x=$spawn_data.rx		# - Include any that wander in from elsewhere
        y=$spawn_data.ry		# - Exclude any that exit the cave
        race=bats
        [filter_location]
          terrain=U*^*,Q*^*
        [/filter_location]
        [not]				# Exclude player's bats, if any
          side=1
        [/not]
#ifdef EASY
        count=0-4			# Limits maximum number of bats in cave
#endif
#ifdef NORMAL
        count=0-5			# Limits maximum number of bats in cave
#endif
#ifdef HARD
        count=0-6			# Limits maximum number of bats in cave
#endif
      [/have_unit]
    [/filter_condition]
    [while]
      [variable]
        name=spawn_data.n
        greater_than=0
      [/variable]
      [do]
        [store_locations]
          variable=spawn_locs		# Chasm hexes adjacent to shaman
          [and]
            x,y=$spawn_data.ex,$spawn_data.ey
            radius=1
          [/and]
          terrain=Qxe			# Chasm
          [not]				# Exclude occupied hexes
            [filter]
            [/filter]
          [/not]
        [/store_locations]
        [if]
          [variable]			# No unoccupied chasm hexes adjacent to shaman
            name=spawn_locs.length
            equals=0
          [/variable]
        [then]
          [store_locations]		# See if any chasm hex available in cave
            variable=spawn_locs
            mode=always_clear
            x=$spawn_data.rx		# x co-ordinate range
            y=$spawn_data.ry		# y co-ordinate range
            terrain=Qxe			# Chasm
            [not]			# Exclude occupied hexes
              [filter]
              [/filter]
            [/not]
          [/store_locations]
          [set_variable]		# Spawn a single vampire bat
            name=spawn_data.n
            value=1
          [/set_variable]
        [/then]
        [/if]
        [if]				# No spaces available, do not spawn (should never happen!)
          [variable]
            name=spawn_locs.length
            equals=0
          [/variable]
        [then]
          [set_variable]
            name=spawn_data.n
            value=0
          [/set_variable]
        [/then]
        [else]
          [set_variable]		# Randomly select available hex
            name=spawn_i
            rand=1..$spawn_locs.length
          [/set_variable]
          [set_variable]
            name=spawn_i
            sub=1
          [/set_variable]
          [switch]			# Randomly select "affordable" bat type
            variable=spawn_data.n
            [case]
              value=1
              [set_variable]		# Can only "afford" Vampire Bat
                name=spawn_type
                value="Vampire Bat"
              [/set_variable]
            [/case]
            [case]
              value=2
              [set_variable]		# Can "afford" Vampire Bat or Blood Bat
                name=spawn_type
                rand="Vampire Bat,Blood Bat"
              [/set_variable]
            [/case]
            [else]
            [set_variable]		# All types available
              name=spawn_type
              rand="Vampire Bat,Blood Bat,Dread Bat,AEI_Dire_Bat"
            [/set_variable]
            [/else]
          [/switch]
          [unit]
            side=7
            type=$spawn_type
            x,y=$spawn_locs[$spawn_i].x,$spawn_locs[$spawn_i].y
            generate_name=yes
            random_traits=yes
            random_gender=yes
            placement=map
            moves=0			# Does not move at first (like recruited unit)
            animate=yes
          [/unit]
          [switch]			# Now "pay" for bat
            variable=spawn_type
            [case]
              value="Vampire Bat"
              [set_variable]
                name=spawn_data.n
                sub=1
              [/set_variable]
            [/case]
            [case]
              value="Blood Bat"
              [set_variable]
                name=spawn_data.n
                sub=2
              [/set_variable]
            [/case]
            [else]
              [set_variable]
                name=spawn_data.n
                sub=3
              [/set_variable]
            [/else]
          [/switch]
          [clear_variable]
            name=spawn_i, spawn_type
          [/clear_variable]
        [/else]
        [/if]
        [clear_variable]
          name=spawn_locs
        [/clear_variable]
      [/do]
    [/while]
    [clear_variable]
      name=spawn_data
    [/clear_variable]
  [/event]
#
  [event]				# Colony 1 spawn bats
    name=side 7 turn refresh
    first_time_only=no
    [filter_condition]
      [have_unit]			# Only spawn if shaman present...
        id=colony1_shaman
      [/have_unit]
      [have_unit]			# ...and player unit in cave
        x={C1_RX}
        y={C1_RY}
        side=1
        [filter_location]
          terrain=U*^*,Q*^*
        [/filter_location]
      [/have_unit]
    [/filter_condition]
    [set_variables]			# Colony 1 random locations spawn
      name=spawn_data
      mode=replace
      [value]
        rx={C1_RX}
        ry={C1_RY}
        n ={C1_SPAM}			# Amount to "spend" on spawning bats
        ex={C1S_X}
        ey={C1S_Y}
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_bat
    [/fire_event]
  [/event]
#
  [event]				# Colony 2 spawn bats (spawns "cost"=4)
    name= side 7 turn refresh
    first_time_only=no
    [filter_condition]
      [have_unit]			# Only spawn if shaman present...
        id=colony2_shaman
      [/have_unit]
      [have_unit]			# ...and player unit in cave
        x={C2_RX}
        y={C2_RY}
        side=1
        [filter_location]
          terrain=U*^*,Q*^*
        [/filter_location]
      [/have_unit]
    [/filter_condition]
    [set_variables]			# Colony 2 random locations spawn
      name=spawn_data
      mode=replace
      [value]
        rx={C2_RX}
        ry={C2_RY}
        n ={C2_SPAM}			# Amount to "spend" on spawning bats
        ex={C2S_X}
        ey={C2S_Y}
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_bat
    [/fire_event]
  [/event]
#
  [event]				# Colony 3 spawn bats (spawns "cost"=3)
    name= side 7 turn refresh
    first_time_only=no
    [filter_condition]
      [have_unit]			# Only spawn if shaman present...
        id=colony3_shaman
      [/have_unit]
      [have_unit]			# ...and player unit in cave
        x={C3_RX}
        y={C3_RY}
        side=1
        [filter_location]
          terrain=U*^*,Q*^*
        [/filter_location]
      [/have_unit]
    [/filter_condition]
    [set_variables]			# Colony 3 random locations spawn
      name=spawn_data
      [value]
        rx={C3_RX}
        ry={C3_RY}
        n ={C3_SPAM}			# Amount to "spend" on spawning bats
        ex={C3S_X}
        ey={C3S_Y}
      [/value]
      mode=replace
    [/set_variables]
    [fire_event]
      name=spawn_bat
    [/fire_event]
  [/event]
#
#
# Cave reveal movetos
#
# Cave entrance reveal first time dialogue
  [event]
    name=found_tunnel_entrace_ftd
    [set_variables]
      name=rspeak
      [value]
        d="Ahead's a hidden way!"
        e="Though cunningly cloaked, the pathway continues underground."
        h="There's a concealed entrance here!"
        l="Lookss like a ssecret accessss to cavess of ssome ssort ahead!"
        o="Cave here hidden!"
      [/value]
      mode=merge
    [/set_variables]
    [fire_event]
      name=rspeak
    [/fire_event]
  [/event]
#
# Colony1
  [event]
    name=moveto
    [filter]
      side=1
      x,y={C1_XY}
    [/filter]
    [place_shroud]		# Hide cave area
      side=1
      find_in=colony1_caves
    [/place_shroud]
    [for]			# Restore saved terrain
      array=colony1_caves
      variable=i
      [do]
        [terrain]
          x,y=$colony1_caves[$i].x,$colony1_caves[$i].y
          terrain=$colony1_caves[$i].terrain
        [/terrain]
      [/do]
    [/for]
    [time_area]
      find_in=colony1_caves
      {UNDERGROUND}
    [/time_area]
    [capture_village]
      side=7
      terrain=*^V*
      find_in=colony1_caves
    [/capture_village]
    [set_variables]
      name=ces
      [value]
        x={C1S_X}
        y={C1S_Y}
        id="colony1_shaman"
        n="Colony 1 controller"
      [/value]
    [/set_variables]		# Create elder shaman
    [fire_event]
      name=create_colony_controller
    [/fire_event]
    [terrain]			# Create entrance
      x,y={C1E_XY}
      terrain=Uue
    [/terrain]
    [remove_shroud]		# Reveal entrance
      side=1
      x,y={C1E_XY}
    [/remove_shroud]
    [clear_variable]
      name=colony1_caves
    [/clear_variable]
    [redraw]
    [/redraw]
    [set_variables]
      name=rspeak
      [value]
        x=$x1
        y=$y1
        r=$unit.race
      [/value]
    [/set_variables]
    [fire_event]
      name=found_tunnel_entrace_ftd
    [/fire_event]
  [/event]
#
# Colony2
  [event]
    name=moveto
    [filter]
      side=1
      x,y={C2_XY}
    [/filter]
    [place_shroud]		# Hide cave area
      side=1
      find_in=colony2_caves
    [/place_shroud]
    [for]			# Restore saved terrain
      array=colony2_caves
      variable=i
      [do]
        [terrain]
          x,y=$colony2_caves[$i].x,$colony2_caves[$i].y
          terrain=$colony2_caves[$i].terrain
        [/terrain]
      [/do]
    [/for]
    [time_area]
      find_in=colony2_caves
      {UNDERGROUND}
    [/time_area]
    [capture_village]
      side=7
      terrain=*^V*
      find_in=colony2_caves
    [/capture_village]
    [set_variables]
      name=ces
      [value]
        x={C2S_X}
        y={C2S_Y}
        id="colony2_shaman"
        n="Colony 2 controller"
      [/value]
    [/set_variables]		# Create elder shaman
    [fire_event]
      name=create_colony_controller
    [/fire_event]
    [terrain]			# Create entrance
      x,y={C2E_XY}
      terrain=Uue
    [/terrain]
    [remove_shroud]		# Reveal entrance
      side=1
      x,y={C2E_XY}
    [/remove_shroud]
    [clear_variable]
      name=colony2_caves
    [/clear_variable]
    [redraw]
    [/redraw]
    [set_variables]
      name=rspeak
      [value]
        x=$x1
        y=$y1
        r=$unit.race
      [/value]
    [/set_variables]
    [fire_event]
      name=found_tunnel_entrace_ftd
    [/fire_event]
  [/event]
#
# Colony3
  [event]
    name=moveto
    [filter]
      side=1
      x,y={C3_XY}
    [/filter]
    [place_shroud]		# Hide cave area
      side=1
      find_in=colony3_caves
    [/place_shroud]
    [for]			# Restore saved terrain
      array=colony3_caves
      variable=i
      [do]
        [terrain]
          x,y=$colony3_caves[$i].x,$colony3_caves[$i].y
          terrain=$colony3_caves[$i].terrain
        [/terrain]
      [/do]
    [/for]
    [time_area]
      find_in=colony3_caves
      {UNDERGROUND}
    [/time_area]
    [capture_village]
      side=7
      terrain=*^V*
      find_in=colony3_caves
    [/capture_village]
    [set_variables]
      name=ces
      [value]
        x={C3S_X}
        y={C3S_Y}
        id="colony3_shaman"
        n="Colony 3 controller"
      [/value]
    [/set_variables]		# Create elder shaman
    [fire_event]
      name=create_colony_controller
    [/fire_event]
    [terrain]			# Create entrance
      x,y={C3E_XY}
      terrain=Uue
    [/terrain]
    [remove_shroud]		# Reveal entrance
      side=1
      x,y={C3E_XY}
    [/remove_shroud]
    [redraw]
    [/redraw]
    [clear_variable]
      name=colony3_caves
    [/clear_variable]
    [set_variables]
      name=rspeak
      [value]
        x=$x1
        y=$y1
        r=$unit.race
      [/value]
    [/set_variables]
    [fire_event]
      name=found_tunnel_entrace_ftd
    [/fire_event]
  [/event]
#
#
# Change schedule events
#
# Change schedule after any bat controller (Orc Shaman) dies.
#  Can die any time but need to change schedule at specific time
#   of day, otherwise schedule will probably not change smoothly
#
# Used to modify schedule
# 0: No shadow (all bats grounded, normal daylight)
# 1: Only midday in shadow
# 2: Midday+morning in shadow
# 3: Midday+afternoon in shadow
# 4: Do nothing
#
# Some or all of these events may never fire...
#
# Morning unshadow event ($shadow_status=3)
  [event]
    name=turn end
    [filter_condition]
      [variable]
        name=shadow_status
        equals=3
      [/variable]
    [/filter_condition]
    [filter_location]
      {KRAGXY}			# Exclude {UNDERGROUND}
      time_of_day_id=dawn
    [/filter_location]
    [replace_schedule]
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
      {MORNING} {TOD_COLOR_SHIFT 5 5 0}
      {MIDDAY_SHADOWED}
      {AFTERNOON_SHADOWED}
      {DUSK}
      {MIDNIGHT_SS}
    [/replace_schedule]
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
  [/event]
#
# Afternoon unshadow event ($shadow_status=2)
  [event]
    name=turn end
    [filter_condition]
      [variable]
        name=shadow_status
        equals=2
      [/variable]
    [/filter_condition]
    [filter_location]
      {KRAGXY}			# Exclude {UNDERGROUND}
      time_of_day_id=midday_shadowed
    [/filter_location]
    [replace_schedule]
      {MIDDAY_SHADOWED}
      {AFTERNOON} {TOD_COLOR_SHIFT 5 5 0}
      {DUSK}
      {MIDNIGHT_SS}
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
      {MORNING_SHADOWED}
    [/replace_schedule]
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
  [/event]
#
# Midday only shadow event ($shadow_status=1)
# Two possibilities: second shaman died in morning or afternoon
# Fire whichever of the events below happens first
# 1: Apply at dawn (second shaman died afternoon-dawn)
  [event]
    name=turn end
    [filter_condition]
      [variable]
        name=shadow_status
        equals=1
      [/variable]
    [/filter_condition]
    [filter_location]
      {KRAGXY}			# Exclude {UNDERGROUND}
      time_of_day_id=dawn
    [/filter_location]
    [replace_schedule]
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
      {MORNING} {TOD_COLOR_SHIFT 5 5 0}
      {MIDDAY_SHADOWED}
      {AFTERNOON} {TOD_COLOR_SHIFT 5 5 0}
      {DUSK}
      {MIDNIGHT_SS}
    [/replace_schedule]
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
  [/event]
#
# 2: Apply at midday (second shaman died morning-noon)
  [event]
    name=turn end
    [filter_condition]
      [variable]
        name=shadow_status
        equals=1
      [/variable]
    [/filter_condition]
    [filter_location]
      {KRAGXY}			# Exclude {UNDERGROUND}
      time_of_day_id=midday_shadowed
    [/filter_location]
    [replace_schedule]
      {MIDDAY_SHADOWED}
      {AFTERNOON} {TOD_COLOR_SHIFT 5 5 0}
      {DUSK}
      {MIDNIGHT_SS}
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
      {MORNING} {TOD_COLOR_SHIFT 5 5 0}
    [/replace_schedule]
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
  [/event]
#
# No shadow ($shadow_status=0) - always apply in morning
  [event]
    name=turn end
    [filter_condition]
      [variable]
        name=shadow_status
        equals=0
      [/variable]
    [/filter_condition]
    [filter_location]
      {KRAGXY}			# Exclude {UNDERGROUND}
      time_of_day_id=morning
    [/filter_location]
    [replace_schedule]
      {MORNING} {TOD_COLOR_SHIFT 5 5 0}
      {MIDDAY_SS}
      {AFTERNOON} {TOD_COLOR_SHIFT 5 5 0}
      {DUSK}
      {MIDNIGHT_SS}
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
    [/replace_schedule]
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
  [/event]


#
# Naga hostage village related events
#
# Shaman serpent controller stays put
# (Guards have status=guardian)
  [event]
    name=side 2 turn refresh
    first_time_only=no
    [modify_unit]
      [filter]
        id=serpent_controller
      [/filter]
      moves=0
    [/modify_unit]
  [/event]
#
# Nagas join player
# Note: if Paddel dead, any surviving nagas will have fled and nothing happens here
  [event]
    name=naga_change_sides
    [filter_condition]
      [have_unit]
        id=Paddel
      [/have_unit]
    [/filter_condition]
    [modify_unit]		# Transfer Paddel's troops (if any) to player
      [filter]
        side=6
      [/filter]
      side=1
    [/modify_unit]
    [floating_text]
      x,y=56,11
      text= _ "<span color='red'>Side 1</span>"
    [/floating_text]
    [set_extra_recruit]
      id=Paddel
      extra_recruit=Naga Fighter, Naga Warrior, Naga Myrmidon, Naga Hunter, Naga Marksman, Naga Guardian, Naga Warden, Naga Sentinel
    [/set_extra_recruit]
    [modify_unit]		# Filter Paddel recall to exclude all land based units
      [filter]
        id=Paddel
      [/filter]
      [filter_recall]
        role=Paddel
      [/filter_recall]
    [/modify_unit]
    {TRANSFER_VILLAGE_OWNERSHIP 6 1} 
    [message]
      speaker=Paddel
      message= _ "We are free!  Deep thanks, drywalkers."
    [/message]
    [store_gold]		# Very unlikely Paddel will have >100 gold!
      side=6
      variable=Paddel_gold
    [/store_gold]
    [if]			# Paddel hands over at least 100..150 gold
      [variable]
        name=Paddel_gold
        less_than=100
      [/variable]
    [then]
      [set_variable]		# Higher chance of midrange values
        name=Paddel_gold
        rand=100..150,120..130
      [/set_variable]
    [/then]
    [/if]
    [set_variable]
      name=arrival_gold
      value=$Paddel_gold
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value=$Paddel_gold
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Paddel hands over $Paddel_gold gold!"
    [/message]
    [clear_variable]
      name=Paddel_gold
    [/clear_variable]
  [/event]
#
# Player captures hostage village
  [event]
    name=capture
    first_time_only=no
    [filter]
      side=1
      [filter_location]
        terrain=Wwg^Vm
      [/filter_location]
    [/filter]
    [remove_item]
      x,y=$x1,$y1
      image=items/cage.png
    [/remove_item]
    [terrain]
      x,y=$x1,$y1
      terrain=Ww^Vm		# Flag village as liberated
    [/terrain]
    [if]			# Get small gold bonus if capturing unit *NOT* a bat
      [variable]
        name=unit.race
        not_equals=bats
      [/variable]
    [then]
      [set_variable]
        name=arrival_gold
        rand=20..50
      [/set_variable]
      [set_variable]
        name=min_arrival_gold
        value=$arrival_gold
      [/set_variable]
      [set_variables]
        name=rspeak
        [value]
          x=$x1
          y=$y1
          r=$unit.race
          d="There's $arrival_gold gold here!"
          e="There is $arrival_gold gold here!"
          h="I've found $arrival_gold gold here!"
          l="There iss $arrival_gold gold here."
          o="$arrival_gold here there's gold!"
        [/value]
      [/set_variables]
      [fire_event]
        name=rspeak
      [/fire_event]
      [sound]
        name=gold.ogg
      [/sound]
      [fire_event]
        name=gold_set_or_add
      [/fire_event]
    [/then]
    [/if]
    [fire_event]
      name=nvc_ftd		# First time dialogue
    [/fire_event]
    [scroll_to]			# To make any ambush notifications occur in right place
      x,y=$x1,$y1
    [/scroll_to]
    [if]
      [have_location]		# All villages liberated?
        terrain=Wwg^Vm
        count=0
      [/have_location]
    [then]
      [if]
        [have_unit]		# If Aknzlay dead will always change sides, regardless of $27_naga_defensive
          side=2
          canrecruit=yes
          count=0
        [/have_unit]
        [or]
          [variable]		# Change sides if $27_naga_defensive not "no"
            name=27_naga_defensive
            not_equals=no
          [/variable]
        [/or]
      [then]
        [fire_event]
          name=naga_change_sides
        [/fire_event]
      [/then]
      [/if]
    [/then]
    [/if]
  [/event]
#
# Player captures hostage village first time dialogue
# Nothing happens if Paddel dead
  [event]
    name=nvc_ftd
    first_time_only=yes
    [if]
      [variable]
        name=27_naga_defensive
        equals=no
      [/variable]
      [have_unit]
        id=Aknzlay
      [/have_unit]
    [then]
      [message]
        speaker=Paddel
        message= _ {WHISPER _"Deep thanks for liberating some of my people!  Once all are freed and Aknzlay slain, I can persuade my soldiers to rebel against the orcs!"}
      [/message]
    [/then]
    [else]
      [message]
        speaker=Paddel
        message= _ {WHISPER _"Deep thanks for liberating some of my people!  Once all are freed I can persuade my soldiers to rebel against the orcs!"}
      [/message]
    [/else]
    [/if]
  [/event]


#
# --- Tunnel moveto events ---
#
# North end of dwarf messenger tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {MD_NORTHXY} {MD_SOUTHXY} }
#
# South end of dwarf messenger tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {MD_SOUTHXY} {MD_NORTHXY} }
#
#
# North end of western north-south tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {TW_NORTHXY} {TW_SOUTHXY} }
#
# South end of western north-south tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {TW_SOUTHXY} {TW_NORTHXY} }
#
#
# East end of east-west tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {T_EASTXY} {T_WESTXY} }
#
# West end of east-west tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {T_WESTXY} {T_EASTXY} }
#
#
# North end of eastern north-south tunnel
{TUNNEL_TELEPORT_ALL {TE_NORTHXY} {TE_SOUTHXY} }
#
# South end of eastern north-south tunnel
{TUNNEL_TELEPORT_ALL {TE_SOUTHXY} {TE_NORTHXY} }
#
#
# North end of far east north-south tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {TFE_NORTHXY} {TFE_SOUTHXY} }
#
# South end of far east north-south tunnel (dwarves only)
{TUNNEL_TELEPORT_DWARF {TFE_SOUTHXY} {TFE_NORTHXY} }
#
#
# East end of east-west tunnel
{TUNNEL_TELEPORT_ALL {TA_EASTXY} {TA_WESTXY} }
#
# West end of east-west tunnel
{TUNNEL_TELEPORT_ALL {TA_WESTXY} {TA_EASTXY} }
#
#
# North end of boss tunnel
{TUNNEL_TELEPORT_ALL {TB_NORTHXY} {TB_SOUTHXY} }
#
# South end of boss tunnel
{TUNNEL_TELEPORT_ALL {TB_SOUTHXY} {TB_NORTHXY} }
#
#
# Arrah end of Arrah-Elgenefar tunnel
{TUNNEL_TELEPORT_ALL {TAE_ARRAHXY} {TAE_ELGENEFARXY} }
#
# Elgenefar end of Arrah-Elgenefar tunnel
{TUNNEL_TELEPORT_ALL {TAE_ELGENEFARXY} {TAE_ARRAHXY} }
#
#
# Krag end of Krag-Morn tunnel
{TUNNEL_TELEPORT_ALL {TKM_KRAGXY} {TKM_MORNXY} }
#
# Morn end of Krag-Morn tunnel
{TUNNEL_TELEPORT_ALL {TKM_MORNXY} {TKM_KRAGXY} }


#
# --- Arrival events ---
#
# Add arriving leader gold if Flynn's gold >0, else set Flynn gold to arrival gold
  [event]
    name=gold_set_or_add
    first_time_only=no
    [gold]			# Add gold
      side=1
      amount=$arrival_gold
    [/gold]
    [store_gold]		# Store gold
      side=1
    [/store_gold]
    [if]
      [variable]
        name=gold
        less_than=$min_arrival_gold
      [/variable]
    [then]
      [modify_side]
        side=1
        gold=$min_arrival_gold
      [/modify_side]
    [/then]
    [/if]
    [clear_variable]
      name=gold,arrival_gold,min_arrival_gold
    [/clear_variable]
  [/event]
#
# Arrah arrival event
  [event]
    name=Arrive_Arrah
    {ARRAH_MUSIC}
    [set_variable]		# Setup Arrah
      name=Arrah_save.side
      value=1
    [/set_variable]
    [unstore_unit]
      variable=Arrah_save
      {ARRAHXY}
    [/unstore_unit]
    {CLEAR_VARIABLE Arrah_save}
    [set_extra_recruit]
      id=Arrah
#ifdef EASY
      extra_recruit="Cavalryman,Dragoon,Bowman,Longbowman,Spearman,Javelineer,Pikeman,Swordsman,Fencer,Heavy Infantryman"
#else
      extra_recruit="Cavalryman,Bowman,Longbowman,Spearman,Javelineer,Pikeman,Swordsman,Peasant,Woodsman,Sergeant"
#endif
    [/set_extra_recruit]
    [terrain]
      {ARRAHXY}
      radius=1
      terrain=Ce
    [/terrain]
    [terrain]
      {ARRAHXY}
      terrain=Ke
    [/terrain]
    [redraw]
    [/redraw]
    [unit]			# Put a few handy units in recall
      side=1
#ifdef HARD
      type=Iron Mauler		# Ugrade to Iron Mauler on HARD
#else
      type=Shock Trooper
#endif
      x,y=recall,recall
      [modifications]
        {TRAIT_FEARLESS}
        {TRAIT_QUICK}
      [/modifications]
      random_traits=no
      generate_name=yes
      random_gender=yes
      animate=no
      role=Arrah
    [/unit]
    [unit]
      side=1
      type=Shock Trooper
      x,y=recall,recall
      generate_name=yes
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=Arrah
    [/unit]
    [unit]
      side=1
#ifdef HARD
      type=Master at Arms	# Ugrade to Master at Arms on HARD
#else
      type=Duelist
#endif
      x,y=recall,recall
      generate_name=yes
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=Arrah
    [/unit]
    [unit]
      side=1
      type=Duelist
      x,y=recall,recall
      generate_name=yes
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_STRONG}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=Arrah
    [/unit]
    [unit]			# Just in case Flynn was low on healers (or has lost most of them!)
      side=1
      type=White Mage
      x,y=recall,recall
      generate_name=yes
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=Arrah
    [/unit]
    [modify_unit]		# Filter Arrah recall
      [filter]
        id=Arrah
      [/filter]
      [filter_recall]
        role=Arrah
      [/filter_recall]
    [/modify_unit]
    [message]
      speaker=Arrah
      message= _ "Hail, Earl Flynn!  At last have I found you.  Lord Gweddry finally allowed me leave to cross the river.  Methinks he feared you slain and wanted confirmation.  Yet I am allowed to assist if it be not hopeless.  I deem the battle undecided: my gold and troops are yours!"
    [/message]
    [set_variable]
      name=arrival_gold
      value={START_GOLD_ARRAH}
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value={START_GOLD_ARRAH}
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    [message]
      speaker=Flynn
      message= _ "Hail and well met, stalwart Arrah!"
    [/message]
    [if]
      [have_unit]
        id=Aknzlay
      [/have_unit]
    [then]
      [message]
        speaker=Aknzlay
        message= _ "More dread-dark fodder to chew on!  Behlend: I authorise use of your reserve gold!"
      [/message]
    [/then]
    [else]
      [message]
        speaker=Behlend
        message= _ "What's this?  A dismal diversity of dread-darks?  Open the gold reserve!"
      [/message]
    [/else]
    [/if]
    [sound]
      name=gold.ogg
    [/sound]
    [modify_side]		# Set gold to {300 400 500}
      side=3
#ifdef EASY
      gold=300
#endif
#ifdef NORMAL
      gold=400
#endif
#ifdef HARD
      gold=500
#endif
    [/modify_side]
  [/event]
#
# Elgenefar arrival event
  [event]
    name=Arrive_Elgenefar
    {ELGENEFAR_MUSIC}
    [recall]
      id=Elgenefar
      {ELGENEFARXY}
    [/recall]
    [terrain]
      {ELGENEFARXY}
      radius=1
      layer=base
      terrain=Ce
    [/terrain]
    [terrain]
      {ELGENEFARXY}
      layer=base
      terrain=Ke
    [/terrain]
    [redraw]
    [/redraw]
    [recall]
      id=Boughspright
      x,y=73,3
    [/recall]
    [recall]
      id=Elfeothof
      x,y=74,2
    [/recall]
    [recall]
      id=m_e
      x,y=72,2
    [/recall]
    [if]			# Elgenefar's potion(s), if any
      [variable]
        name=antidotes_saved_e
        greater_than=0
      [/variable]
    [then]
      [item]
        image=items/potion-red.png
        x,y={POTIONX_E},{POTIONY_E}
      [/item]
      [label]
        x,y={POTIONX_E},{POTIONY_E}
        {POTION_LABEL_COLOUR}
        text= _ "$antidotes_saved_e"
      [/label]
    [/then]
    [/if]
    [set_extra_recruit]
      id=Elgenefar
      extra_recruit="$AEI_Elgenefar_recruit"
    [/set_extra_recruit]
    {CLEAR_VARIABLE AEI_Elgenefar_recruit}
    [set_variable]
      name=arrival_gold
      value=$AEI_Elgenefar_gold_save
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value={MIN_START_GOLD_ELGENEFAR}
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    {CLEAR_VARIABLE AEI_Elgenefar_gold_save}
    [message]
      speaker=Elgenefar
      message= _ "Gallant Earl Flynn, greetings and salutations!  We will cleanse the forest of orcish stain and stench!"
    [/message]
    [message]
      speaker=Flynn
      message= _ "Welcome indeed to you, fair Elgenefar, and your greenfolk!"
    [/message]
    [if]
      [have_unit]
        id=Aknzlay
      [/have_unit]
    [then]
      [message]
        speaker=Aknzlay
        message= _ "Oho!  Side salad to accompany the fodder!  Znottiyanki, take this extra gold!"
      [/message]
    [/then]
    [else]
      [message]
        speaker=Znottiyanki
        message= _ "Elves?  Best use my gold reserves!"
      [/message]
    [/else]
    [/if]
    [sound]
      name=gold.ogg
    [/sound]
    [modify_side]		# Set gold to {350 425 500}
      side=5
#ifdef EASY
      gold=350
#endif
#ifdef NORMAL
      gold=425
#endif
#ifdef HARD
      gold=500
#endif
    [/modify_side]
  [/event]
#
# Krag & Blok arrival event
  [event]
    name=Arrive_Krag
    {KRAG_MUSIC}
    [recall]
      id=Krag
      {KRAGXY}
    [/recall]
    [terrain]
      x=19,19,20,20,20,20,21,21
      y= 3, 4, 1, 2, 3, 4, 3, 4
      terrain=Cud
    [/terrain]
    [terrain]
      {KRAGXY}
      terrain=Kud
    [/terrain]
    [terrain]
      {BLOKXY}
      terrain=Kud
    [/terrain]
    [redraw]
    [/redraw]
    [recall]
      id=Blok
      {BLOKXY}
    [/recall]
    [recall]
      x,y=17,1
      id=rb
    [/recall]
    [recall]
      id=m_d
      x,y=17,2
    [/recall]
    [recall]
      id=Ssoothz
      x,y=19,1
    [/recall]
    [recall]
      id=Sstingz
      x,y=21,1
    [/recall]
    [if]			# Krag's potion(s), if any
      [variable]
        name=antidotes_saved_d
        greater_than=0
      [/variable]
    [then]
      [item]
        image=items/potion-red.png
        x,y={POTIONX_D},{POTIONY_D}
      [/item]
      [label]
        x,y={POTIONX_D},{POTIONY_D}
        {POTION_LABEL_COLOUR}
        text= _ "$antidotes_saved_d"
      [/label]
    [/then]
    [/if]
    [set_extra_recruit]
      id=Krag
      extra_recruit="Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Thunderer,Dwarvish Ulfserker,Young Ogre"
    [/set_extra_recruit]
    [set_extra_recruit]
      id=Blok
      extra_recruit="Dwarvish Scout,Young Ogre,Ogre"
    [/set_extra_recruit]
    [if]
      [variable]			# =yes if Blok gained bat recruitment
        name=bbrecruit
        equals=yes
      [/variable]
    [then]
      [allow_extra_recruit]
        id=Blok
        extra_recruit=AEI_Vampire_Bat
      [/allow_extra_recruit]
    [/then]
    [/if]
    [set_variable]
      name=arrival_gold
      value=$AEI_Krag_gold_save
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value={MIN_START_GOLD_KRAG}
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    {CLEAR_VARIABLE AEI_Krag_gold_save}
    [message]
      speaker=Krag
      message= _ "Ach, here at last.  Hoi!  Flynn!  We hear yeh need some orcs hammerin'!"
    [/message]
    [message]
      speaker=Flynn
      message= _ "Sturdy Blok and staunch Krag, pray join the fun!"
    [/message]
    [if]
      [variable]			# =yes if Krag captured locked chest in 25_The_Caveguard
        name=real_chest
        equals=yes
      [/variable]
    [then]
      [item]
        image=items/chest-plain-closed.png
        {CHEST_POTION}
      [/item]
      [message]
        speaker=Krag
        message= _ "Oor scouts managed t' open this locked chest wi'oot the key.  Let's see what's inside!"
      [/message]
      [sound]
        name=open-chest.wav
      [/sound]
      [remove_item]
        image=items/chest-plain-closed.png
        {CHEST_POTION}
      [/remove_item]
      [item]
        image=items/chest-gold.png
        {CHEST_POTION}
      [/item]
      [message]
        speaker=Krag
        message= _ "Yes!  Full o' gold!
 
... or nae so?
 
There's only a shallow layer o' coins atop a box.  Ah'd've expected more'n this.  P'raps fundin' the army to invade us has drained the coffers or the orc leader's've been dippin' their paws in?  Either way there ain't much here.  Ah well, this box has nae lock so ah'll open it..."
      [/message]
      [sound]
        name=gold.ogg
      [/sound]
      [gold]
        side=1
        amount={ON_DIFFICULTY 190 170 150}
      [/gold]
      [if]		# Dialogue varies according to whether Flynn has any dwarf runesmiths or advancements
        [have_unit]
          type_adv_tree=AEI_Dwarvish_Runesmith
        [/have_unit]
      [then]
        [store_unit]
          variable=box_explainer
          [filter]
            type_adv_tree=AEI_Dwarvish_Runesmith
          [/filter]
          kill=no
          mode=always_clear
        [/store_unit]
        [message]
          speaker=$box_explainer[0].id
          message= _ "That's oor dead leader's stuff, taken by the orcs that killed him!  It's yours by right o' battle.  Inside should be:
- Oor fallen leader's axe, usable only by Berserkers, Warriors or their betters.
 
- Experimental thunderdust usable only by Thunderers or their betters.
  It might be unstable so use wi' caution!
 
- A potion of invulnerability of limited duration.
  <span foreground='#ffff00'>Only us Dwarves have the constitution to survive drinkin' it.</span>"
        [/message]
        [clear_variable]
          name=box_explainer
        [/clear_variable]
      [/then]
      [else]
      [message]
        speaker=Krag
        message= _ "Interestin'... inside are items that look t' be Dwarf made!  Must've been captured by the orcs.
There's an axe, a generous measure o'.. -sniff- highly volatile "+{ASIDE _"and probably unstable"} +"... thunderdust and a potion wi' a damaged label.  All ah can read is: ""... rock skin ... <b><span foreground='#ffff00'>FOR DWARVES ONLY</span></b> ..."""
      [/message]
      [/else]
      [/if]
      [remove_item]
        image=items/chest-gold.png
        {CHEST_POTION}
      [/remove_item]
{AEI_PICKDROP_SETUP 28_inv {CHEST_POTIONX} {CHEST_POTIONY} items/potion-grey.png}
{AEI_PICKDROP_SETUP 28_axe {CHEST_AXEX} {CHEST_AXEY} items/axe.png}
{AEI_PICKDROP_SETUP 28_dust {CHEST_GRITX} {CHEST_GRITY} items/leather-pack.png}
    [/then]
    [/if]
    [fire_event]
      name=create_shaman_defenders
    [/fire_event]
  [/event]
#
# Morn arrival event
  [event]
    name=Arrive_Morn
    {MORN_MUSIC}
    [recall]
      id=Morn
      {MORNXY}
    [/recall]
    [recall]
      id=Aegis
      {AEGISXY}
    [/recall]
    [terrain]
      {MORNXY}
      radius=1
      terrain=Ce
    [/terrain]
    [terrain]		# Morn's keep
      {MORNXY}
      terrain=Ke
    [/terrain]
    [terrain]		# Aegis's Keep
      {AEGISXY}
      terrain=Ke
    [/terrain]
    [terrain]		# Morn has 2 keeps and 8 castle hexes
      x=29,30,31
      y=60,60,60
      terrain=Ce
    [/terrain]
    [redraw]
    [/redraw]
    [recall]
      id=Dawn
      x,y=32,60
    [/recall]
    [recall]
      id=Jackery
      x,y=29,57
    [/recall]
    [recall]
      id=Nippa
      x,y=28,58
    [/recall]
    [recall]		# May not be present
      id=Ravel
      x,y=32,58
    [/recall]
    [set_extra_recruit]
      id=Morn
      extra_recruit="Bowman,Fencer,Mage,Spearman"
    [/set_extra_recruit]
    [set_extra_recruit]
      id=Aegis
      extra_recruit="Ostler,Horseman"
    [/set_extra_recruit]
    [set_extra_recruit]
      id=Jackery
      extra_recruit="Bowman,Fencer,Sergeant,Spearman"
    [/set_extra_recruit]
    [set_variable]
      name=arrival_gold
      value={START_GOLD_MORN}
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value={START_GOLD_MORN}
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    [message]
      speaker=Flynn
      message= _ "Friends!  Beyond hope you appear!  Beyond words are you welcome!"
    [/message]
    [message]
      speaker=Morn
      message= _ "We shall remind the orcs why they fear the light."
    [/message]
    [message]
      speaker=Nippa
      message= _ "...<b><i>and</i></b> that the dark ain't always a safe place..."
    [/message]
    [if]
      [have_unit]
        id=Aknzlay
      [/have_unit]
    [then]
      [message]
        speaker=Aknzlay
        message= _ "<i><b>More</b></i> frulking fodder?  Noxyus: repel them!  Use your stash, I know you have one..."
      [/message]
    [/then]
    [else]
      [message]
        speaker=Noxyus
        message= _ "Frelkitt, I will have to waste my stash killing these frulking fodder..."
      [/message]
    [/else]
    [/if]
    [sound]
      name=gold.ogg
    [/sound]
    [modify_side]		# Set gold to {400 500 600}
      side=4
#ifdef EASY
      gold=400
#endif
#ifdef NORMAL
      gold=500
#endif
#ifdef HARD
      gold=600
#endif
    [/modify_side]
  [/event]
#
# Chance of allies arrival every 4th turn starting from turn 12
# Will fire if at least one arrival pending (i.e. might get only 1 [option] to choose from)
# Note: Dwarves and elves only available when respective messengers reach destination or die
#
# It is possible to make this "cleverer" and compute if only 1 arrival possible and if so, just fire that arrival event
# However this way means the player is given a bit more interaction (plus it easier to code :-).
  [event]
    name=side 1 turn
    first_time_only=no
    id=aei_allies_arrive
    [filter_condition]
      [variable]
        name=turn_number
        greater_than=11
      [/variable]
      [and]
        [have_location]			# Arrah pending
          {ARRAHXY}
          terrain=Ke
          count=0
        [/have_location]
        [or]
          [have_unit]			# Morn pending (can only arrive after Arrah)
            id=Morn
            count=0
          [/have_unit]
          [have_location]		# Arrah arrived (may be dead, not an essential character)
            {ARRAHXY}
            terrain=Ke
          [/have_location]
        [/or]
        [or]
          [have_unit]			# Krag pending
            id=Krag, m_d
            count=0
          [/have_unit]
        [/or]
        [or]
          [have_unit]			# Elgenefar pending
            id=Elgenefar, m_e
            count=0
          [/have_unit]
        [/or]
      [/and]
    [/filter_condition]
    [set_variable]
      name=aei_turn_temp
      value=$turn_number
    [/set_variable]
    [set_variable]
      name=aei_turn_temp
      modulo=4
    [/set_variable]
    [if]
      [variable]			# Arrival turn (12,16,20 etc.)
        name=aei_turn_temp
        equals=0
      [/variable]
    [then]				# List possible arrival options and let player choose (may only be 1 available)
      [message]
        speaker=Flynn
        message = _ "An army approaches!"
        [option]			# Krag & Blok
          [show_if]
            [have_unit]
              id=Krag,m_d
              count=0
            [/have_unit]
          [/show_if]
          label= _ "Look north-west!  Dwarvish banners!"
          image=attacks/hammer-dwarven.png
          [command]
            [fire_event]
              name=Arrive_Krag
            [/fire_event]
          [/command]
        [/option]
        [option]			# Elgenefar
          [show_if]
            [have_unit]
              id=Elgenefar,m_e
              count=0
            [/have_unit]
          [/show_if]
          label= _ "Look north-east!  Elvish banners!"
          image=attacks/bow-elven.png
          [command]		
            [fire_event]
              name=Arrive_Elgenefar
            [/fire_event]
          [/command]
        [/option]
        [option]			# Arrah
          [show_if]
            [have_location]
              {ARRAHXY}
              terrain=Ke
              count=0
            [/have_location]
          [/show_if]
          label= _ "Look west!  Wesnothian banners!"
          image=attacks/bow.png
          [command]		
            [fire_event]
              name=Arrive_Arrah
            [/fire_event]
          [/command]
        [/option]
        [option]			# Morn (only after Arrah arrived)
          [show_if]
            [have_location]		# Arrah arrived (may be dead, not an essential character)
              {ARRAHXY}
              terrain=Ke
            [/have_location]
            [have_unit]
              id=Morn
              count=0
            [/have_unit]
          [/show_if]
          label= _ "Look west again!  Humans!"
          image=attacks/lightbeam.png
          [command]
            [fire_event]
              name=Arrive_Morn
            [/fire_event]
          [/command]
        [/option]
      [/message]
    [/then]
    [/if]
    [clear_variable]
      name=aei_turn_temp
    [/clear_variable]
  [/event]
#
# Remove ally arrival event if all allies present
  [event]
    name=side 1 turn
    [filter_condition]
      [have_unit]		# Everyone has arrived
        id=Arrah, Elgenefar, Krag, Morn
        count=4
      [/have_unit]
    [/filter_condition]
    [remove_event]
      id=aei_allies_arrive
    [/remove_event]
  [/event]


# Turn 2 end: dialogue reveals bats work in shifts
  [event]
    name=turn 2 end
    [message]
      speaker=Aknzlay
      message= _ "It's almost midday.  Launch colony two.  Colony one, return and rest."
    [/message]
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Again from the north a second colony arrived, relieving the tired (and probably rather sunburned) bats already circling overhead.  The battlefield remained in shadow."
    [/message]
    [message]
      speaker=Flynn
      message= _ "Drat!  They appear to command sufficient bats to maintain this gloom indefinitely.  Clearly they roost somewhere in those northern mountains.  Presumably that which controls them dwells there also?"
    [/message]
  [/event]


# Side 2 turn 2: launch bats and replace schedule
  [event]
    name=side 2 turn 2
    [message]
      speaker=Aknzlay
      message= _ "Ugh, sunshine... let's be rid of it.  Launch colony one.  Watch their faces everyone!"
    [/message]
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Our heroes watched as a cloud of smoke arose from the impassable northern peaks.  It did not move with the wind but instead, with ominous purpose, headed directly towards their position.
 
As it drew closer they could see what it truly was: a large colony of bats, packed together and flying fairly low.  They prepared to engage them.
 
Yet combat was not forthcoming.  The colony flew past and took up position between our heroes and the sun, enveloping the battlefield in shadow."
    [/message]
    [replace_schedule]
      {MORNING_SHADOWED}
      {MIDDAY_SHADOWED}
      {AFTERNOON_SHADOWED}
      {DUSK}
      {MIDNIGHT_SS}
      {DAWN} {TOD_COLOR_SHIFT 0 -10 -5}
    [/replace_schedule]
    [if]
      [variable]
        name=add_rock
        equals=yes
      [/variable]
    [then]
      {REPLACE_SCENARIO_MUSIC night_hunter_edit.ogg}
      {APPEND_MUSIC battle-epic.ogg}
      {APPEND_MUSIC breaking_the_siege_edit.ogg}
    [/then]
    [else]
      {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
    [/else]
    [/if]
    {APPEND_MUSIC wesnoth_song1.ogg}
    {APPEND_MUSIC Before_the_Battle.ogg}
    {APPEND_MUSIC heroism.ogg}
    {APPEND_MUSIC battle.ogg}
    {APPEND_MUSIC the_city_falls.ogg}
    {APPEND_MUSIC vengeful.ogg}
    {APPEND_MUSIC in_the_land_of_madness.ogg}
    {APPEND_MUSIC breaking_the_chains.ogg}
    {APPEND_MUSIC Flight_of_the_Drakes.ogg}
    {APPEND_MUSIC casualties_of_war.ogg}
    {APPEND_MUSIC ambuscade.ogg}
    [if]		# Possible (but unlikely) that Dirk is already dead
      [have_unit]
        id=Dirk
      [/have_unit]
    [then]		# Dirk alive (very likely)
      [message]
        speaker=Dirk
        message= _ "Sire, we have lost the advantage of daylight!  In time we could, perhaps, slay sufficient of these bothersome leatherwings to disperse this gloom - but I doubt the orcs would wait patiently whilst we did so..."
      [/message]
      [message]
        speaker=Flynn
        message= _ "I concur.  This behaviour is unnatural.  Some will commands them to fly in formation during the day.  We must find and eliminate whatever controls them!"
      [/message]
    [/then]
    [else]		# No Dirk; Flynn issues alternative dialogue
      [message]
        speaker=Flynn
        message= _ "Damnit!  We have lost the advantage of daylight!  In time we could, perhaps, slay sufficient of these bothersome leatherwings to disperse this gloom - but I doubt the orcs would wait patiently whilst we did so...
 
This behaviour is unnatural.  Some will commands them to fly in formation during the day.  We must find and eliminate whatever controls them!"
      [/message]
    [/else]
    [/if]
  [/event]


# Side 2 turn 1
# Populate villages with guards and issue some cryptic dialogue to player...
  [event]
    name=side 2 turn 1
    [message]
      speaker=Aknzlay
      message= _ "Deploy the borderguards.  Distribute warbeer to some warriors - let's see what the fodder makes of <i>them!</i>"
    [/message]
    [set_variables]			# Aknzlay's island guards (tougher)
      name=spawn_eu
      [value]
        x=31
        y=25
        s=2
        t="Orcish Slurbow"
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_enemy_unit
    [/fire_event]
    [set_variables]
      name=spawn_eu
      [value]
        x=33
        y=26
        s=2
        t="Orcish Bladestorm"
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_enemy_unit
    [/fire_event]
    [set_variables]
      name=spawn_eu
      [value]
        x=36
        y=26
        s=2
        t="Orcish Nightblade"
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_enemy_unit
    [/fire_event]
    [set_variables]
      name=spawn_eu
      [value]
        x=38
        y=25
        s=2
        t="Orcish Warlord"
      [/value]
    [/set_variables]
    [fire_event]
      name=spawn_enemy_unit
    [/fire_event]
    [modify_unit]				# Add status=guardian
      [filter]
        x=31,33,36,38
        y=25,26,26,25
      [/filter]
      ai_special=guardian
    [/modify_unit]
    [set_variable]
      name=cgort_side
      value=2
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# North bridge east: strong missile attack
      value="Orcish Slurbow,Orcish Nightblade"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
        x=32
        y=17
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
    [set_variable]
      name=cgort_side
      value=2
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# North bridge west: strong melee attack
      value="Orcish Bladestorm,Orcish Warlord"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
        x=34
        y=17
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
    [set_variable]
      name=cgort_side
      value=2
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# Aknzlay's guards (tougher)
      value="Orcish Bladethrash,Orcish Crossbowman,Orcish Slayer,Orcish Warrior"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
        x=28,30,39,41,32,34,45,45,51,51
        y=26,27,28,27,13,13, 1, 4, 2, 4
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
#
    [set_variable]
      name=cgort_side
      value=3
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# Behlend's guards
      value="Orcish Archer,Orcish Grunt,Orcish Crossbowman,Orcish Warrior,Orcish Bladeflail,Orcish Bladethrash"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
        x=33,32, 8, 9, 9,11
        y=29,30,56,58,42,42
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
#
    [set_variable]
      name=cgort_side
      value=4
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# Noxyus's guards
      value="Orcish Archer,Orcish Assassin,Orcish Slayer,Orcish Crossbowman"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
      x=36,37,43,45,23,25
      y=32,31,26,27,56,57
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
    [set_variable]
      name=cgort_side
      value=4
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# Bridge guards by Flynn not poisoners
      value="Orcish Archer,Orcish Crossbowman"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
      x=52,54
      y=51,51
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
#
    [set_variable]
      name=cgort_side
      value=5
    [/set_variable]
    [set_variable]
      name=cgort_tlist				# Znottiyanki's guards
      value="Goblin Impaler,Goblin Rouser,Orcish Archer,Orcish Crossbowman,Orcish Grunt,Orcish Warrior,Orcish Bladeflail,Orcish Bladethrash"
    [/set_variable]
    [store_locations]
      variable=cgort_locations
      x=46,48,67,68,68,71,75,74
      y=24,25, 6, 2, 7, 6,10,11
    [/store_locations]
    [fire_event]
      name=cgort
    [/fire_event]
  [/event]


# Turn 1: opening dialogue, select music options etc
  [event]
    name=turn 1
#
# Inform player what, if anything, they missed:
# - Easter egg (02b_Intermission, found if $ht_02b=yes)
# - Blok bat recruitment (24_The_Cliffguard, obtained if $bbrecruit=yes))
# - Dwarven treasure chest (25_The_Caveguard, found if $real_chest=yes)
#
    [set_variable]
      name=hidden_treasures_found
      value=0
    [/set_variable]
    [set_variable]
      name=perf_hdr_text
      value=_"Campaign performance:<i>"
    [/set_variable]
    [if]
      [variable]
        name=ht_02b
        equals=yes
      [/variable]
    [then]
      [set_variable]
        name=hidden_treasures_found
        add=1
      [/set_variable]
      [set_variable]
        name=ht_02b_text
        value=_" - Easter Egg........: <span color='green'><b>Yes!</b></span>"
      [/set_variable]
    [/then]
    [else]
      [set_variable]
        name=ht_02b_text
        value=_" - Easter Egg........: <span color='red'><b>No.</b></span>"
      [/set_variable]
    [/else]
    [/if]
#
    [if]
      [variable]
        name=real_chest
        equals=yes
      [/variable]
    [then]
      [set_variable]
        name=hidden_treasures_found
        add=1
      [/set_variable]
      [set_variable]
        name=real_chest_text
        value=_" - Hidden Treasure...: <span color='green'><b>Yes!</b></span></tt>"
      [/set_variable]
    [/then]
    [else]
      [set_variable]
        name=real_chest_text
        value=_" - Hidden Treasure...: <span color='red'><b>No.</b></span></tt>"
      [/set_variable]
    [/else]
    [/if]
#
    [if]
      [variable]			# =yes if Blok gained bat recruitment
        name=bbrecruit
        equals=yes
      [/variable]
    [then]
      [set_variable]
        name=hidden_treasures_found
        add=1
      [/set_variable]
      [set_variable]
        name=bbrecruit_text
        value=_"</i><tt> - Blok extra recruit: <span color='green'><b>Yes!</b></span>"
      [/set_variable]
    [/then]
    [else]
      [set_variable]
        name=bbrecruit_text
        value=_"</i><tt> - Blok extra recruit: <span color='red'><b>No.</b></span>"
      [/set_variable]
    [/else]
    [/if]
#
    [switch]
      variable=hidden_treasures_found
      [case]
        value=3
        [set_variable]
          name=hidden_treasures_rating
          value=_"Congratulations!"
        [/set_variable]
      [/case]
      [case]
        value=2
        [set_variable]
          name=hidden_treasures_rating
          value=_"Good, but no cigar."
        [/set_variable]
      [/case]
      [case]
        value=1
        [set_variable]
          name=hidden_treasures_rating
          value=_"Needs improvement."
        [/set_variable]
      [/case]
      [else]
        [set_variable]
          name=hidden_treasures_rating
          value=_"Oh dear, a total fail..."
        [/set_variable]
      [/else]
    [/switch]
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "$perf_hdr_text $hidden_treasures_rating
$bbrecruit_text
$ht_02b_text
$real_chest_text"
    [/message]
    [clear_variable]
      name=perf_hdr_text,hidden_treasures_found,ht_02b_text,real_chest_text,bbrecruit_text,ht_02b,hidden_treasures_rating
    [/clear_variable]
#
    [message]			# Add rock/metal music (optional)
      speaker=narrator
      image=misc/music.png
      message= _ "Would you like to include a few rock/metal tunes in the playlist?"
      [option]
        label= _ "Yes, why not?"
        [command]
          [set_variable]
            name=add_rock
            value=yes
          [/set_variable]
          {APPEND_MUSIC Imminent_Threat.ogg}
        [/command]
      [/option]
      [option]
        label= _ "No, stick to classic themes..."
        [command]
          [set_variable]
            name=add_rock
            value=no
          [/set_variable]
        [/command]
      [/option]
    [/message]
    {APPEND_MUSIC weight_of_revenge.ogg}
    {APPEND_MUSIC the_deep_path.ogg}
#
# Distribute antidotes (if any)
    [if]			# Skip logic if no antidotes picked up
      [variable]
        name=antidotes_saved
        greater_than=0
      [/variable]
    [then]
      [message]
        speaker=Flynn
        message = _ "Hmm... we have $antidotes_saved of these red potions.  What should I do?"
        [option]
          label= _ "Keep them all."
          [command]
            [set_variable]
              name=antidotes_saved_h
              value=$antidotes_saved
            [/set_variable]
          [/command]
        [/option]
        [option]
          label= _ "Give them all to Krak and Blok."
          [command]
            [set_variable]
              name=antidotes_saved_d
              value=$antidotes_saved
            [/set_variable]
          [/command]
        [/option]
        [option]
          label= _ "Give them all to Elgenefar."
          [command]
            [set_variable]
              name=antidotes_saved_e
              value=$antidotes_saved
            [/set_variable]
          [/command]
        [/option]
        [option]
          label= _ "Share them as equally as possible."
          [command]
            [set_variable]
              name=antidotes_saved_i
              value=$antidotes_saved
            [/set_variable]
            [while]
              [variable]
                name=antidotes_saved_i
                greater_than=2
              [/variable]
              [do]
                [set_variable]
                  name=antidotes_saved_d
                  add=1
                [/set_variable]
                [set_variable]
                  name=antidotes_saved_e
                  add=1
                [/set_variable]
                [set_variable]
                  name=antidotes_saved_h
                  add=1
                [/set_variable]
                [set_variable]
                  name=antidotes_saved_i
                  sub=3
                [/set_variable]
              [/do]
            [/while]
            [switch]
              variable=antidotes_saved_i
              [case]
                value=1,2
                [set_variable]
                  name=antidotes_saved_d
                  add=1
                [/set_variable]
              [/case]
              [case]
                value=2
                [set_variable]
                  name=antidotes_saved_e
                  add=1
                [/set_variable]
              [/case]
            [/switch]
            [clear_variable]
              name=antidotes_saved_i
            [/clear_variable]
          [/command]
        [/option]
      [/message]
    [/then]
    [/if]
#
    [if]			# Flynn's potion(s), if any
      [variable]
        name=antidotes_saved_h
        greater_than=0
      [/variable]
    [then]
      [item]
        image=items/potion-red.png
        x,y={POTIONX_H},{POTIONY_H}
      [/item]
      [label]
        x,y={POTIONX_H},{POTIONY_H}
        {POTION_LABEL_COLOUR}
        text= _ "$antidotes_saved_h"
      [/label]
      [if]			# Dialogue slightly different if only 1 potion
        [variable]
          name=antidotes_saved_h
          equals=1
        [/variable]
      [then]
        [message]
          speaker=Flynn
          message = _ "We have but a single potion.  I must use it wisely!"
        [/message]
      [/then]
      [else]
        [message]
          speaker=Flynn
          message = _ "We have $antidotes_saved_h potions.  I must use them wisely!"
        [/message]
      [/else]
      [/if]
    [/then]
   [/if]
#
# Reveal messenger from Krag
    [move_unit]
      x,y=52,59
      to_x,to_y=54,59
      fire_event=no
    [/move_unit]
    [message]
      speaker=m_d
      message = _ "Ahoy Flynn!  Guid tae see yeh.  Ah'm $m_d_name|, Krag sent me ahead tae bring word that oor army's on its way, just a few orc lookouts tae, er, ""quietly negotiate"" first.  The orcs ken o' yer approach, which helped me: wi' all orc eyes on the roads the mountains are underlooked...
 
Though most o' oor old underways here are flooded, collapsed or orc infested a few remain accessible.  Here, let me mark 'em on yer map.  There's two sorts:"
      [option]
        label= _ "Tunnel still in fair condition.  Usable by all."
        image=scenery/any-tunnel.png
        [command]
        [/command]
      [/option]
      [option]
        label= _ "Narrow, twisty and sharp-sided crawlspace.
Only dwarves can get through wi'oot gettin' cut tae pieces or stuck."
        image=scenery/cave-entrance.png
        [command]
        [/command]
      [/option]
    [/message]
#
    [for]			# Place tunnel entrance/exits usable by dwarves only
      array=tunnels_dwarf
      variable=i
      [do]
        [item]
          image=scenery/cave-entrance.png
          x,y=$tunnels_dwarf[$i].x,$tunnels_dwarf[$i].y
        [/item]
      [/do]
    [/for]
    [for]			# Place tunnel entrance/exits usable by anyone
      array=tunnels_any
      variable=i
      [do]
        [item]
          image=scenery/any-tunnel.png
          x,y=$tunnels_any[$i].x,$tunnels_any[$i].y
        [/item]
      [/do]
    [/for]
    [redraw]
    [/redraw]
#
# Show player tunnel exit used by dwarf messenger
    [message]
      speaker=m_d
      message = _ "Ah got here usin' yon crawlway a short step nor-west o' the ford behind me."
    [/message]
    # Vary delay and number of blinks here to make players on easier difficulties pay more attention:
    {AEI_HIGHLIGHT_IMAGE 6 51 items/gohere.png scenery/cave-entrance.png {ON_DIFFICULTY 190 170 150} {ON_DIFFICULTY 5 4 3}} # = MD_SOUTHXY
#
# Antidote potion-dependent dialogue (dwarf)
    [set_variable]
      name=dpart2
      value=""
    [/set_variable]
    [if]			# Give potion(s) to dwarves and ogres, if any
      [variable]
        name=antidotes_saved_d
        greater_than=0
      [/variable]
    [then]
      [if]			# Dialogue slightly different if only 1 potion
        [variable]
          name=antidotes_saved_d
          equals=1
        [/variable]
      [then]
        [set_variable]
          name=dpart2
          value=" I also have something for you: pray deliver this poison antidote potion to Krag or Blok. "
        [/set_variable]
      [/then]
      [else]
        [set_variable]
          name=dpart2
          value=" I also have something for you: pray deliver these $antidotes_saved_d poison antidote potions to Krag and Blok. "
        [/set_variable]
      [/else]
      [/if]
    [/then]
    [/if]
    [message]
      speaker=Flynn
      message = _ "$m_d_name|, many thanks for informing me of your tunnels.  They give us a great tactical advantage. $dpart2 Please say to worthy Krag we know he hates missing all the fun so we'll try to save him some orcs!"
    [/message]
    {CLEAR_VARIABLE dpart2}
    [message]
      speaker=m_d
      message = _ "Heh, nice one.  Yer learnin' oor ways well!  Just keep the orcs' attention so ah can return unseen.
 
Lang may yer lum reek!"
    [/message]
    [move_unit]
      x,y=54,59
      to_x,to_y=52,59
    [/move_unit]
    {AEI_HIGHLIGHT_IMAGE {KRAGX} {KRAGY} items/gohere.png scenery/cave-entrance.png 150 3}
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Whilst the orcs' attention is on Flynn, $m_d_name can effectively hide in <b>mountains</b> (only).
Moving to non-mountain terrain (including mountain villages and hills) will result in $m_d_name being seen, thus losing the ability to hide in mountains <b>permanently</b>.
To reach Krag (and safety), move $m_d_name to ({KRAGX},{KRAGY}).
 
<span foreground='#ffff00'>Note: Until $m_d_name reaches safety (or dies) Blok and Krag will <b>not</b> arrive!</span> (Probably.)"
    [/message]
#
# Reveal messenger from Elgenefar
    [move_unit]
      x,y=63,55
      to_x,to_y=56,58
    [/move_unit]
    [if]			# Tweak dialogue depending on whether or not Elgenefar has Rangers
      [have_unit]
        type=Elvish Ranger,Elvish Avenger
        role=Elgenefar
        search_recall_list=yes
      [/have_unit]
    [then]
      [set_variable]
        name=ranger_dialogue_conditional
        value="all our Rangers are engaged as forward scouts ensuring our advance remains undetected."
      [/set_variable]
    [/then]
    [else]
      [set_variable]
        name=ranger_dialogue_conditional
        value="we sadly have no Rangers hence my presence here."
      [/set_variable]
    [/else]
    [/if]
    [message]
      speaker=m_e
      message = _ "Hail and well met, Earl Flynn of Wesnoth!  Glad indeed am I, $m_e_name|, to find you unscathed and hale.
 
I heard what, ah, our dwarven friend reported and I bear similar news: Elgenefar's forces draw near.  Just as the orcs are, for now, disregarding the mountains they similarly pay scant heed to the forests.  Before you ask, $ranger_dialogue_conditional
 
I passed a secluded area largely hidden by palm forest and mountains east of here.  Mayhap it will serve as the ""small defensible region"" your plan requires?  Also, I was greatly fortunate to find stepping stones across the river, presumably revealed by the low summer waters.  They are treacherous and unstable, so whilst us lightfoot elves can, with care, cross safely, <u>I would <b><span foreground='#ffff00'>strongly</span></b> advise you <i>avoid</i> trying to cross them with anyone else.</u>
 
Finally, do you have any message for Elgenefar ere I depart with word of your arrival?"
    [/message]
    [clear_variable]
      name=ranger_dialogue_conditional
    [/clear_variable]
#
# Antidote potion-dependent dialogue (elf)
    [set_variable]
      name=dpart2
      value=""
    [/set_variable]
    [if]			# Give potion(s) to elves, if any
      [variable]
        name=antidotes_saved_e
        greater_than=0
      [/variable]
    [then]
      [if]			# Dialogue slightly different if only 1 potion
        [variable]
          name=antidotes_saved_e
          equals=1
        [/variable]
      [then]
        [set_variable]
          name=dpart2
          value=" and this poison antidote potion"
        [/set_variable]
      [/then]
      [else]
        [set_variable]
          name=dpart2
          value=" and these $antidotes_saved_e poison antidote potions"
        [/set_variable]
      [/else]
      [/if]
    [/then]
    [/if]
    [message]
      speaker=Flynn
      message = _ "$m_e_name|, please relay to gracious Elgenefar our greetings$dpart2|.  We will keep the eyes and blades of the orcs facing us.  Make them rue ignoring the forest!"
    [/message]
    {CLEAR_VARIABLE dpart2}
    [message]
      speaker=m_e
      message = _ "Most assuredly shall we fall upon their rear like a storm!  Whilst they attend to you I shall be able to return unobserved to Elgenefar.
 
Watch the eastern forest!  Not for long shall you stand alone!"
    [/message]
    [move_unit]
      x,y=56,58
      to_x,to_y=63,55
    [/move_unit]
    {AEI_HIGHLIGHT_IMAGE {ELGENEFARX} {ELGENEFARY} items/gohere.png () 150 3}
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Whilst the orcs' attention is on Flynn, $m_e_name can effectively ambush enemies.
Moving to non-forest terrain will result in $m_e_name being seen, thus losing the ability to ambush <b>permanently</b>.
To reach Elgenefar (and safety), move $m_e_name to ({ELGENEFARX},{ELGENEFARY}).
 
<span foreground='#ffff00'>Note: Until $m_e_name reaches safety (or dies) Elgenefar will <b>not</b> arrive!</span> (Probably.)"
    [/message]
#
# The orcs finally spot Flynn
    [message]
      speaker=Aknzlay
      message= _ "<b>Finally</b>, the fodder's arrived.  Everyone: down ale and don armour.  Some of you haven't had the pleasure of killing humans.  Here's your opportunity to get some practice!  Let's hope they don't die too quickly..."
    [/message]
    [message]
      speaker=Flynn
      message = _ "We have <b>plenty</b> of experience killing orcs.  We know you are massing for an assault upon our people and lands south of the Great River.  Withdraw or be cut down!"
    [/message]
    [message]
      speaker=Aknzlay
      message= _ "You talk a good fight, but have no idea whom you face: I am not some lumpen grunt or craven assassin leading a handful of pitiful rusty-blades.  I am Aknzlay, Overlord of the southern reaches, horde-master and doom bringer.  Did you <b>really</b> think we'd allow your cocksure swagger here if it wasn't what I planned?  Eitherways, it matters not: you will fight and die here.  In so doing I can evaluate the current level of human combat capabilities following your kicking by Rav'nal.  You also aid in tactics and training: the terrain here resembles what we will encounter when we over-run your northern border!"
    [/message]
    [message]
      speaker=Flynn
      message = {ASIDE _"Damnit!  I was expecting some sort of leader but this orc clearly has an iron command over his minions.  There is no chance of sowing discord whilst he lives.  Therefore our first order of business is to remove him <b>without</b> slaying the leaders that separate us from him."}+"
 
Lest you forget: Wesnoth defeated Ravanal.  I, Earl Flynn of Wesnoth, offer you this thought: <i>That which does not kill us makes us stronger</i>.  The long days and short nights greatly hamper your forces.  Soldiers of Wesnoth stand ready before you.  For the last time: disperse or be slaughtered!"
    [/message]
    [message]
      speaker=Aknzlay
      message= _ "Everyone: see how they brag and bluster?  Let's change their tune!  Attack!  No prisoners!"
    [/message]
    [if]
      [variable]
        name=27_naga_defensive
        equals=no
      [/variable]
    [then]
      [message]
        speaker=Paddel
        message= _ {WHISPER _"Please, help us!  My people fight only out of fear of the orcs!  Just west of the westernmost stone bridge are villages captured by the orcs.  Many are held hostage there.  If you gain control of these villages, even if only briefly, then those held captive can escape.  If you free them all and - somehow - kill Aknzlay then my people will join you.  But be warned: those villages are heavily guarded!"}
      [/message]
    [/then]
    [else]
      [message]
        speaker=Paddel
        message= _ {WHISPER _"Please, help us!  My people fight only out of fear of the orcs!  Just west of the westernmost stone bridge are villages captured by the orcs.  Many are held hostage there.  If you gain control of these villages, even if only briefly, then those held captive can escape.  If you free them all then my people will join you.  But be warned: those villages are heavily guarded!"}
      [/message]
    [/else]
    [/if]
    [message]
      speaker=Flynn
      message = _ {WHISPER _"I make no promise, but will try to do so.  Until then we must, sadly, be enemies..."}
    [/message]
    [message]
      speaker=Aknzlay
      message= _ "Riverslugs!  Quit muttering!  "+{ASIDE _"Probaby whingeing as usual."}
    [/message]
  [/event]


# Start of game
  [event]
    name=start
    [objectives]
      side=1
      [objective]
        description= _ "Defeat Aknzlay"
        condition=win
        [show_if]
          [have_unit]
            id=Aknzlay
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Slay <span foreground='#ffff00'><b>all</b></span> orc shamans (including any in hiding)"
        condition=win
        [show_if]
          [have_unit]
            id=Aknzlay
            count=0
          [/have_unit]
          [have_location]		# Not all bat caves revealed
            {CE_ALL_XY}
            terrain=Mm^Xm
          [/have_location]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Slay <span foreground='#ffff00'><b>all</b></span> orc shamans"
        condition=win
        [show_if]
          [have_unit]
            id=Aknzlay
            count=0
          [/have_unit]
          [have_unit]
            type=aei_oshn,aei_osh,aei_oshe
          [/have_unit]
          [have_location]		# All bat caves revealed
            {CE_ALL_XY}
            terrain=Mm^Xm
            count=0
          [/have_location]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Withdraw Dawn and all your leaders (except Arrah) into the south-east enclave"
        condition=win
        [show_if]
          [variable]			# Withdraw enabled
            name=28_withdraw
            equals=yes
          [/variable]
          [variable]			# Civil war not started
            name=28_civilwar
            equals=no
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Civil war!  Await victory (when the horde begin killing each other)"
        condition=win
        [show_if]
          [variable]			# Civil war started
            name=28_civilwar
            equals=yes
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Death of Behlend, Noxyus or Znottiyanki (!)"
        condition=lose
        [show_if]
          [variable]			# Civil war not started
            name=28_civilwar
            equals=no
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Behlend, Noxyus or Znottiyanki slain by non-horde unit (!)"
        condition=lose
        [show_if]
          [variable]			# Civil war started
            name=28_civilwar
            equals=yes
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Death of Flynn"
        condition=lose
      [/objective]
      [objective]
        description = _ "Death of Morn, Dawn or Aegis"
        condition=lose
        [show_if]
          [have_unit]
            id=Morn
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Death of Elgenefar"
        condition=lose
        [show_if]
          [have_unit]
            id=Elgenefar
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Death of Blok or Krag"
        condition=lose
        [show_if]
          [have_unit]
            id=Krag
          [/have_unit]
        [/show_if]
      [/objective]
#ifndef HARD
      [note]
#ifdef EASY
        description=_"<span foreground='#ffff00'>Hint: it might be prudent to begin planning how to withdraw to the south-east enclave...</span>"
#endif
#ifdef NORMAL
        description=_"<span foreground='#ffff00'>Hint: it might be prudent to begin thinking about the next phase of Flynn's plan...</span>"
#endif
        [show_if]
          [variable]			# Withdraw not yet started...
            name=28_withdraw
            equals=no
          [/variable]
          [and]				# ...and EITHER Aknzlay dead...
            [have_unit]
              id=Aknzlay
              count=0
            [/have_unit]
            [or]			# ...or all shamans dead and...
              [have_unit]
                type=aei_oshn,aei_osh,aei_oshe
                count=0
              [/have_unit]
              [have_location]		# ...all bat caves revealed
                {CE_ALL_XY}
                terrain=Mm^Xm
                count=0
              [/have_location]
            [/or]
          [/and]
        [/show_if]
      [/note]
#endif
      {NO_CARRYOVER}
      {IS_LAST_SCENARIO}
    [/objectives]
  [/event]


# Setup initial conditions
  [event]
    name=prestart
#
# Null stone not in play (with Gweddry)
    [clear_variable]
      name=NS_first_time_flag, ns_enabled
    [/clear_variable]
#
# Unshroud everywhere
    [remove_shroud]
      side=1
      x=0-81
      y=0-61
    [/remove_shroud]
#
# Summer stepping stones (perilous!)
    [item]
      image=scenery/castle-ruins2.png
      x,y=60,56
    [/item]
    [item]
      image=scenery/castle-ruins3.png
      x,y=61,56
    [/item]
    [item]
      image=scenery/castle-ruins.png
      x,y=62,55
    [/item]
#
# Save Elgenefar gold and units
    [store_gold]			# Minimum starting gold as defined in side 1 starting gold
      side=1
      variable=AEI_Elgenefar_gold_save
    [/store_gold]
    [modify_side]			# Set side gold to zero (Flynn's saved gold is added later)
      side=1
      gold=0
    [/modify_side]
    [modify_unit]			# Add role=Elgenefar to Elgenefar's units
      [filter]
        x,y=recall,recall
      [/filter]
      side=1
      role=Elgenefar
    [/modify_unit]
    [modify_unit]			# Filter Elgenefar recall
      [filter]
        id=Elgenefar
      [/filter]
      [filter_recall]
        role=Elgenefar
      [/filter_recall]
    [/modify_unit]
    [store_unit]
      variable=AEI_Elgenefar_Army	# Save Elgenefar for later (Flynn already on map)
      [filter]
        x,y=recall,recall
      [/filter]
      kill=yes
      mode=always_clear
    [/store_unit]
#
# Setup Morn recall
    [for]
      array=AEI_Morn_Army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Morn_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    [modify_unit]			# Add role=Morn to Morn's units
      [filter]
        x,y=recall,recall
      [/filter]
      side=1
      role=Morn
    [/modify_unit]
    [modify_unit]			# Filter Morn's recall
      [filter]
        id=Morn,Aegis,Jackery
      [/filter]
      [filter_recall]
        role=Morn
      [/filter_recall]
    [/modify_unit]
    [store_unit]
      variable=AEI_Morn_Army		# Save Morn for later (Flynn already on map)
      [filter]
        x,y=recall,recall
      [/filter]
      kill=yes
      mode=always_clear
    [/store_unit]
#
# Save Krag & Blok gold and units
    [for]
      array=AEI_Krag_Army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Krag_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    [modify_unit]			# Add role=Krag to Blok & Krag's units
      [filter]
        x,y=recall,recall
      [/filter]
      side=1
      role=Krag
    [/modify_unit]
    [modify_unit]			# Filter Blok & Krag's recall
      [filter]
        id=Blok,Krag
      [/filter]
      [filter_recall]
        role=Krag
      [/filter_recall]
    [/modify_unit]
    [store_unit]
      variable=AEI_Krag_Army		# Save Blok & Krag for later (Flynn already on map)
      [filter]
        x,y=recall,recall
      [/filter]
      kill=yes
      mode=always_clear
    [/store_unit]
#
# Only available *after* Krag arrives *IF* $real_chest=yes
    {AEI_PICKDROP_SETUP_UNAVAILABLE 28_axe}	# Axe
    {AEI_PICKDROP_SETUP_UNAVAILABLE 28_dust}	# Thunderdust
    [set_variable]				# First few attacks never fail
      name=28_dust_missed_count
      value=0
    [/set_variable]
    {AEI_PICKDROP_SETUP_UNAVAILABLE 28_inv}	# Invulnerability potion (single use!)
    [set_variable]				# Used by remove invulnerability event (disabled here)
      name=potion_gray_end_turn
      value=0
    [/set_variable]
#
# Setup Flynn
    [set_variable]
      name=arrival_gold
      value=$AEI_Flynn_gold_save
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value={MIN_START_GOLD_FLYNN}
    [/set_variable]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    {CLEAR_VARIABLE AEI_Flynn_gold_save}
    {CLEAR_VARIABLE AEI_Flynn_Army[0]}	# So stored Flynn doesn't clobber on-map Flynn...
    [for]
      array=AEI_Flynn_Army		# Reinstate Flynn's army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Flynn_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    [modify_unit]			# Add role=Flynn to Flynn's units
      [filter]
        x,y=recall,recall
        [not]
          id=Flynn
        [/not]
      [/filter]
      role=Flynn
    [/modify_unit]
    [modify_unit]			# Filter Flynn's recall
      [filter]
        id=Flynn
      [/filter]
      [filter_recall]
        role=Flynn
      [/filter_recall]
    [/modify_unit]
    {CLEAR_VARIABLE AEI_Flynn_Army}
    [recall]
      id=Dirk
      x,y=53,59
    [/recall]
    [recall]
      id=Pierce
      x,y=53,58
    [/recall]
    [recall]
      id=Zipp
      x,y=56,57
    [/recall]
    [recall]
      id=Scampa
      x,y=54,57
    [/recall]
#
# Remove unpoisonable status (may not be any)
# Note that [object] [filter] only applies to
# on-map units, hence rather lengthy process
    [modify_unit]			# Remove status=unpoisonable
      [filter]
        side=1
        status=unpoisonable
        [and]
          id=Flynn,Dirk
        [or]
          x,y=recall,recall
        [/or]
        [/and]
      [/filter]
      [effect]
        apply_to=status
        remove=unpoisonable
      [/effect]
    [/modify_unit]
#
# Populate recall list (Elgenefar)
    [for]
      array=AEI_Elgenefar_Army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Elgenefar_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    {CLEAR_VARIABLE AEI_Elgenefar_Army}
#
# Populate recall list (Morn)
    [for]
      array=AEI_Morn_Army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Morn_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    {CLEAR_VARIABLE AEI_Morn_Army}
#
# Populate recall list (Krag)
    [for]
      array=AEI_Krag_Army
      variable=i
      [do]
        [unstore_unit]
          variable=AEI_Krag_Army[$i]
          x,y=recall,recall
        [/unstore_unit]
      [/do]
    [/for]
    {CLEAR_VARIABLE AEI_Krag_Army}
#
# Setup recruitment
  [set_recruit]
    side=1
    recruit=
  [/set_recruit]
  [set_extra_recruit]
     id=Flynn
     extra_recruit="$AEI_Flynn_recruit"
  [/set_extra_recruit]
  {CLEAR_VARIABLE AEI_Flynn_recruit}
  [allow_extra_recruit]
    id=Flynn
    extra_recruit=AEI_Peasant,Yeoman
  [/allow_extra_recruit]
#
# Store bat caves terrain
    [store_locations]
      variable=colony1_caves		# Entrance at {C1E_XY}
      x=24-39
      y=0-9
      terrain=Q*^*,X*^*,U*^*
    [/store_locations]
#
    [store_locations]
      variable=colony2_caves		# Entrance at {C2E_XY}
      x=0-16
      y=0-8
      terrain=Q*^*,X*^*,U*^*
    [/store_locations]
#
    [store_locations]
      variable=colony3_caves		# Entrance at {C3E_XY}
      x=0-17
      y=10-21
      terrain=Q*^*,X*^*,U*^*
    [/store_locations]
#
# Now replace bat caves with impassable mountains
    [terrain]
      terrain=Mm^Xm
      find_in=colony1_caves
    [/terrain]
    [terrain]
      terrain=Mm^Xm
      find_in=colony2_caves
    [/terrain]
    [terrain]
      terrain=Mm^Xm
      find_in=colony3_caves
    [/terrain]
#
# Setup tunnels
    [store_locations]				# Usable by any player unit
      variable=tunnels_any
      {TUNNELS_FILTER_ALL}
    [/store_locations]
    [store_locations]				# Usable by dwarves only
      variable=tunnels_dwarf
      {TUNNELS_FILTER_DWARF}
    [/store_locations]
#
# Setup dummies
    [store_locations]
      terrain=Rd^Qov
      variable=27_dummy_locations
    [/store_locations]
    [for]
      array=27_dummy_locations
      variable=i
      [do]
        [item]
          image=items/dummy.png
          x,y=$27_dummy_locations[$i].x,$27_dummy_locations[$i].y
        [/item]
      [/do]
    [/for]
    [clear_variable]
      name=27_dummy_locations
    [/clear_variable]
#
# EASY: side 5 -1 castle hex
#ifdef EASY
    [terrain]
      x,y=46,23
      terrain=Rb
    [/terrain]
#endif
#
# HARD: side 3 +1 castle hex
#ifdef HARD
    [terrain]
      x,y=29,29
      terrain=Co
    [/terrain]
#endif
# Starting villages (total: 97)
#
# Aknzlay (21 + naga hostage villages)
    [capture_village]				# Island villages (11)
      side=2
      terrain=*^V*
      [and]
        x,y=35,21
        radius=6
      [/and]
    [/capture_village]
    [capture_village]				# Single village near side 7, far end of island bridges and northern ford
      side=2
      x=19,28,30,39,41,32,34,45,45,51,51
      y=14,26,27,28,27,13,13, 1, 4, 2, 4
    [/capture_village]
    [capture_village]				# Serpent controller village
      side=2
      {NVJ}
    [/capture_village]
    [capture_village]				# Bridge guard 1
      side=2
      {NVG1}
    [/capture_village]
    [capture_village]				# Bridge guard 2
      side=2
      {NVG2}
    [/capture_village]
#
# Behlend (12)
    [capture_village]
      side=3
      x=33,32,20,26, 1,12,15, 9,11, 2, 8, 9
      y=29,30,30,30,36,32,37,42,42,39,56,58
      terrain=*^V*
    [/capture_village]
#
# Noxyus (11)
    [capture_village]
      side=4
      x=36,37,43,45,23,25,35,34,52,54,60
      y=32,31,26,27,56,57,44,54,51,51,47
      terrain=*^V*
    [/capture_village]
#
# Znottiyanki (14)
    [capture_village]
      side=5
      x=46,48,49,67,68,68,71,75,74
      y=24,25,20, 6, 2, 7, 6,10,11
      terrain=*^V*
    [/capture_village]
    [capture_village]
      side=5
      terrain=*^Vhs
    [/capture_village]
#
# Paddel (14)
    [capture_village]
      side=6
      terrain=*^Vm
    [/capture_village]
#
# Naga hostage villages setup
    [store_locations]
      variable=nhv_locations
      terrain=Wwg^Vm
    [/store_locations]
    [capture_village]		# Re-assign to side 2 (from side 6)
      side=2
      find_in=nhv_locations
    [/capture_village]
    [for]			# Place cage image
      array=nhv_locations
      variable=i
      [do]
        [item]
          x,y=$nhv_locations[$i].x, $nhv_locations[$i].y
          image=items/cage.png
        [/item]
      [/do]
    [/for]
    {CLEAR_VARIABLE nhv_locations}
#
# Flynn
    [capture_village]		# Tent villages
      side=1
      terrain=*^Vct
    [/capture_village]
#
# Antidote potion setup
    [set_variable]		# Antidotes given to Dwarves
      name=antidotes_saved_d
      value=0
    [/set_variable]
    [set_variable]		# Antidotes given to Elves
      name=antidotes_saved_e
      value=0
    [/set_variable]
    [set_variable]		# Antidotes kept by Flynn
      name=antidotes_saved_h
      value=0
    [/set_variable]
#
# Wolf rider recruitment setup
    [if]			# Recruit fail chance > 0
      [variable]
        name=recruit_fail_wolf
        greater_than=0
      [/variable]
    [then]			# Create Alpha and Beta wolves, and extra villages
      [terrain]
        x=48,49
        y=22,22
        terrain=Rb^Vc
      [/terrain]
      [capture_village]
        side=5
        x=48,49
        y=22,22
      [/capture_village]
      [unit]
        side=5
        type=Direwolf
        x,y=49,22
        id=side5_alpha
        name="Alpha Wolf"
        [modifications]
          {TRAIT_RESILIENT}
          {TRAIT_STRONG}
          {PACK_LEADER {ON_DIFFICULTY 9 12 15} {ON_DIFFICULTY 1 2 3}}
        [/modifications]
        generate_name=no
        random_traits=no
        random_gender=yes
        animate=no
        upkeep=free
      [/unit]
      [unit]
        side=5
        type=Great Wolf
        x,y=48,22
        id=side5_beta
        name="Beta Wolf"
        [modifications]
          {TRAIT_RESILIENT}
          {TRAIT_STRONG}
          {PACK_LEADER {ON_DIFFICULTY 8 9 10} {ON_DIFFICULTY 0 1 2}}
        [/modifications]
        generate_name=no
        random_traits=no
        random_gender=yes
        animate=no
        upkeep=free
      [/unit]
      [micro_ai]		# Setup alpha as return guardian
        side=5
        ai_type=return_guardian
        action=add
        id=side5_alpha
        return_x,return_y=49,22
      [/micro_ai]
      [micro_ai]		# Setup beta as return guardian
        side=5
        ai_type=return_guardian
        action=add
        id=side5_beta
        return_x,return_y=48,22
      [/micro_ai]
    [/then]
    [/if]

# Used to modify schedule
# 0: No shadow (all bats grounded, normal daylight)
# 1: Only midday in shadow
# 2: Midday+morning in shadow
# 3: Midday+afternoon in shadow
# 4: Do nothing
    [set_variable]
      name=shadow_status
      value=4
    [/set_variable]
    [set_variable]
      name=noon_controller_id
      value="colony2_shaman"
    [/set_variable]
    [set_variable]		# Need to kill all 3
      name=colony_shaman_kill_count
      value=0
    [/set_variable]
#
# Aknzlay's green ring of regeneration setup
#  {AEI_PICKDROP_SETUP_VALUES... explicitly coded because ring is worn
    [set_variables]
      name=ring_28
      [value]
        bearer=Aknzlay
        x=1				# Worn (don't care)
        y=1				# Worn (don't care)
        imagepath="items/ring-green.png"
      [/value]
    [/set_variables]
#
# SE enclave
    [place_shroud]			# Shroud enclave
      side=1
      x=66-81
      y=46-61
      terrain=Cvr,Kvr,Hh^Es,Mm,Re^Vyer,Rb,Re^Es
    [/place_shroud]
#
# Create loyal messengers
    [unit]			# Dwarf
      side=1
      type=Dwarvish Scout
      id=m_d
      x,y=52,59
      generate_name=yes
      unrenamable=yes
      {IS_LOYAL}
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_LOYAL}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=mhides		# Changed to "Krag" if a) loses mountain hide ability or b) reaches safety
    [/unit]
    [store_unit]		# Save name
      variable=aei_temp_messenger
      [filter]
        id=m_d
      [/filter]
      kill=no
    [/store_unit]
    [set_variable]
      name=m_d_name
      value=$aei_temp_messenger.name
    [/set_variable]
    {CLEAR_VARIABLE aei_temp_messenger}
    [object]			# Add hide in mountains ability
      id=aei_mountain_hide
      take_only_once=no
      silent=yes
      duration=scenario
      [filter]
        id=m_d
      [/filter]
      [effect]
        apply_to=new_ability
        [abilities]
          [hides]
            id=rockhide
            name= _ "rockhide"
            female_name= _ "female^rockhide"
            description= _ "This unit can hide in mountains, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in mountain terrain, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
            affect_self=yes
            [filter]
              [filter_location]
                terrain=Mm*^*
              [/filter_location]
            [/filter]
          [/hides]
        [/abilities]
      [/effect]
    [/object]
#
# Dwarf messenger goto (removed when Krag arrives)
    [item]
      image=scenery/cave-entrance.png
      {KRAGXY}
    [/item]
#
    [unit]			# Elf
      side=1
      type=Elvish Archer
      id=m_e
      x,y=63,55
      generate_name=yes
      unrenamable=yes
      {IS_LOYAL}
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_LOYAL}
      [/modifications]
      random_traits=no
      random_gender=yes
      animate=no
      role=Elgenefar
    [/unit]
    [store_unit]		# Save name
      variable=aei_temp_messenger
      [filter]
        id=m_e
      [/filter]
      kill=no
    [/store_unit]
    [set_variable]
      name=m_e_name
      value=$aei_temp_messenger.name
    [/set_variable]
    {CLEAR_VARIABLE aei_temp_messenger}
    [object]			# Add ambush ability
      id=aei_ambush
      take_only_once=yes
      silent=yes
      duration=scenario
      [filter]
        id=m_e
      [/filter]
      [effect]
        apply_to=new_ability
        [abilities]
          {ABILITY_AMBUSH}
        [/abilities]
      [/effect]
    [/object]
#
# SE enclave: respawn spider leader if killed by ai and enclave shrouded
    [set_variable]
      name=ysl_respawn
      value=yes
    [/set_variable]
#
# Flag to enable evacuation moveto events
    [set_variable]
      name=28_withdraw
      value=no
    [/set_variable]
#
# Flag to indicate civil war started
    [set_variable]
      name=28_civilwar
      value=no
    [/set_variable]
  [/event]


# --- Die events ---
#
# First time something dies attracts yellow spiders
  [event]
    name=die
    [filter]
      [not]		# Not stepping stones
        x,y=61,56
      [/not]
    [/filter]
    [unit]		# East border spiders
      side=8
      type=Yellow_Spider_Huge
      x,y=79,1
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=80,2
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=80,5
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=80,12
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider
      x,y=80,18
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider
      x,y=80,21
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=80,24
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]		# West border spiders
      side=8
      type=Yellow_Spider_Huge
      x,y=1,30
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=1,33
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=1,37
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=1,42
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=1,45
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=1,49
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=1,52
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider
      x,y=1,54
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Large
      x,y=1,58
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      x,y=2,60
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
    [/unit]
    [if]			# Dialogue varies depending upon whether spider leader created yet
      [have_unit]
        side=8
        canrecruit=yes
      [/have_unit]
    [then]
      [message]
        speaker=Aknzlay
        message= _ "Everyone: the smell of fresh blood has attracted more yellow spiders!  Slay them too!"
      [/message]
    [/then]
    [else]
      [message]
        speaker=Aknzlay
        message= _ "Everyone: the smell of fresh blood has roused the yellow spiders!  Slay them too!"
      [/message]
    [/else]
    [/if]
    [fire_event]
      name=ysl_create
    [/fire_event]
    [gold]		# Not much extra gold here (more when SE enclave is entered)
      side=8
#ifdef EASY
      amount=100
#endif
#ifdef NORMAL
      amount=125
#endif
#ifdef HARD
      amount=150
#endif
    [/gold]
  [/event]
#
# Respawn spider leader if killed by ai (and player unit not yet entered enclave area)
  [event]
    name=die
    first_time_only=no
    [filter]
      side=8
      canrecruit=yes
    [/filter]
    [filter_condition]
      [variable]
        name=ysl_respawn
        equals=yes
      [/variable]
    [/filter_condition]
    [kill]
      canrecruit=yes
      side=8
      animate=no
    [/kill]
    [unit]
      side=8
      type=Yellow_Spider_Huge
      name= _ "Huge Yellow Spider"
      x,y=77,59
      canrecruit=yes
      [modifications]
        {TRAIT_RESILIENT}
        {TRAIT_STRONG}
      [/modifications]
      generate_name=yes
      random_traits=no
      random_gender=yes
      animate=no
    [/unit]
    [store_side]
      side=8
    [/store_side]
    [if]			# If gold <120, set to 120
      [variable]
        name=side.gold
        less_than=120
      [/variable]
    [then]
      [modify_side]
        side=8
        gold=120
      [/modify_side]
    [/then]
    [/if]
    [clear_variable]
      name=side
    [/clear_variable]
  [/event]


# Bat controller deaths (set $shadow_status)
# Leader will keep midday in shadow as long as possible
#
# First bat controller shaman death: dialogue hints at schedule change
  [event]
    name=last breath
    [filter]
      id=colony1_shaman,colony2_shaman,colony3_shaman
    [/filter]
    [message]
      speaker=unit
      message= _ "Youch!  My concentration is broken!  The bats will lose formation!
 
At least my wound looks superficial...  <small>uh-oh...</small>"
    [/message]
  [/event]
#
# Done in reverse order so $colony_shaman_kill_count works properly
#
# Third and last bat controller shaman death: normal daylight
# (all bat controlling shamans dead)
  [event]
    name=die
    [filter]
      id=colony1_shaman,colony2_shaman,colony3_shaman
    [/filter]
    [filter_condition]
      [variable]		# Third and final kill?
        name=colony_shaman_kill_count
        equals=2
      [/variable]
    [/filter_condition]
    [clear_variable]
      name=noon_controller_id
      value="colony2_shaman"
    [/clear_variable]
    [set_variable]
      name=shadow_status
      value=0
    [/set_variable]
    [disallow_recruit]		# Also, enemies can no longer recruit bats
      side=2,7
      type=Vampire Bat,Blood Bat,Dread Bat, AEI_Dire_Bat
    [/disallow_recruit]
  [/event]
#
# Second bat controlling shaman death: redesignate midday if necessary
  [event]
    name=die
    [filter]
      id=colony1_shaman,colony2_shaman,colony3_shaman
    [/filter]
    [filter_condition]
      [variable]		# Second kill?
        name=colony_shaman_kill_count
        equals=1
      [/variable]
    [/filter_condition]
    [set_variable]		# Set second kill value
      name=colony_shaman_kill_count
      value=2
    [/set_variable]
    [if]
      [have_unit]		# Colony 1 shaman alive (visible)
        id=colony1_shaman
        count=1
      [/have_unit]
      [or]			# Colony 1 shaman alive (hidden)
        [have_location]
          x,y={C1E_XY}
          terrain=Mm^Xm
        [/have_location]
      [/or]
    [then]
      [if]			# Noon controller still colony2_shaman so issue first controller change dialogue
        [variable]
          name=noon_controller_id
          equals="colony2_shaman"
        [/variable]
      [then]
        [set_variable]
          name=dbyaorb
          value="Morning flight: the noon sun is worse, so take over the midday flight."
        [/set_variable]
        [fire_event]		# Dialogue spoken by Aknzlay or Behlend, depending upon who is alive
          name=dbyaorb_e
        [/fire_event]
      [/then]
      [else]			# Colony3 died *this* time, so noon_controller already changed once
        [set_variable]
          name=dbyaorb
          value="Not <i><b>again</b></i>... morning flight: take over the midday flight."
        [/set_variable]
        [fire_event]		# Dialogue spoken by Aknzlay or Behlend, depending upon who is alive
          name=dbyaorb_e
        [/fire_event]
      [/else]
      [/if]
    [/then]
    [else]
      [if]
        [variable]		# Colony1 died first, colony2 this time
          name=noon_controller_id
          equals="colony2_shaman"
        [/variable]
        [and]
          [have_unit]		# Colony 3 shaman alive (visible)
            id=colony3_shaman
            count=1
          [/have_unit]
          [or]			# Colony 3 shaman alive (hidden)
            [have_location]
              x,y={C3E_XY}
              terrain=Mm^Xm
            [/have_location]
          [/or]
        [/and]
      [then]
        [set_variable]
          name=dbyaorb
          value="Afternoon flight: the noon sun is worse, so take over the midday slot."
        [/set_variable]
        [fire_event]		# Dialogue spoken by Aknzlay or Behlend, depending upon who is alive
          name=dbyaorb_e
        [/fire_event]
      [/then]
      [/if]
    [/else]
    [/if]
    [set_variable]		# Noon only in shadow
      name=shadow_status
      value=1
    [/set_variable]
  [/event]
#
# First bat controller shaman death: redesignate midday if necessary
  [event]
    name=die
    [filter]
      id=colony1_shaman,colony2_shaman,colony3_shaman
    [/filter]
    [filter_condition]
      [variable]		# First kill?
        name=colony_shaman_kill_count
        equals=0
      [/variable]
    [/filter_condition]
    [set_variable]		# Set first kill value
      name=colony_shaman_kill_count
      value=1
    [/set_variable]
    [if]			# Midday (colony2) shaman died: redesignate afternoon colony
      [variable]
        name=unit.id
        equals="colony2_shaman"
      [/variable]
    [then]
      [set_variable]
        name=dbyaorb
        value="Afternoon flight: the noon sun is worse, so take over the midday flight."
      [/set_variable]
      [fire_event]		# Dialogue spoken by Aknzlay or Behlend, depending upon who is alive
        name=dbyaorb_e
      [/fire_event]
      [set_variable]
        name=noon_controller_id
        value="colony3_shaman"
      [/set_variable]
    [/then]
    [/if]
    [if]			# Set new schedule
      [variable]		# Morning (colony1) shaman died
        name=unit.id
        equals="colony1_shaman"
      [/variable]
    [then]
      [set_variable]
        name=shadow_status
        value=3			# Midday & afternoon in shadow
      [/set_variable]
    [/then]
    [else]			# Midday or afternoon shaman died
      [set_variable]
        name=shadow_status
        value=2			# Morning & midday in shadow
      [/set_variable]
    [/else]
    [/if]
  [/event]


# Serpent controller death: serpents become independent
  [event]
    name=last breath
    [filter]
      id=serpent_controller
    [/filter]
    [filter_condition]
      [have_unit]		# Skip if all serpents killed
        side=9
      [/have_unit]
    [/filter_condition]
    [modify_side]
      side=9
      team_name=Serpents	# Will now attack spiders
      [ai]
        aggression=0.8		# Much more aggressive
        [goal]
          [criteria]		# The serpents hate their erstwhile masters
            race=goblin,orc,wolf
          [/criteria]
          value=25
        [/goal]
      [/ai]
    [/modify_side]
    [modify_unit]
      [filter]
        side=9
      [/filter]
      [status]
        guardian=no
      [/status]
    [/modify_unit]
    [message]
      speaker=serpent_controller
      message= _ "Aargh!  I cannot maintain control!  They are free!"
    [/message]
  [/event]


# Dwarf messenger last breath
  [event]
    name=last breath
    [filter]
      id=m_d
    [/filter]
    [fire_event]
      name=md_cleanup
    [/fire_event]
    [if]			# Issue dialogue only if antidote potion(s) carried
      [variable]
        name=antidotes_saved_d
        greater_than=0
      [/variable]
    [then]
      [if]			# Dialogue different for single potion
        [variable]
          name=antidotes_saved_d
          equals=1
        [/variable]
      [then]
        [message]
          speaker=m_d
          message = _ "Aargh!  Ah'm done fer...  Krag'll have ter do wi'oot this potion..."
        [/message]
      [/then]
      [else]
        [message]
          speaker=m_d
          message = _ "Aargh!  Ah'm done fer...  Krag'll have ter do wi'oot these potions..."
        [/message]
      [/else]
      [/if]
      [set_variable]
        name=antidotes_saved_d
        value=0
      [/set_variable]
    [/then]
    [/if]
  [/event]


# Elf messenger last breath
  [event]
    name=last breath
    [filter]
      id=m_e
    [/filter]
    [fire_event]
      name=me_cleanup
    [/fire_event]
    [if]			# Loses antidote potions carried (if any)
      [variable]
        name=antidotes_saved_e
        greater_than=0
      [/variable]
    [then]
    [if]			# Issue dialogue only if antidote potion(s) carried
        [variable]
          name=antidotes_saved_e
          equals=1
        [/variable]
      [then]
        [message]
          speaker=m_e
          message = _ "My potion is lost, as am I."
        [/message]
      [/then]
      [else]
        [message]
          speaker=m_e
          message = _ "My potions are lost, as am I."
        [/message]
      [/else]
      [/if]
      [set_variable]
        name=antidotes_saved_e
        value=0
      [/set_variable]
    [/then]
    [/if]
  [/event]


# Dialogue first time an elf dies (except messenger)
  [event]
    name=last breath
    [filter]
      race=elf
      [not]
        id=m_e
      [/not]
    [/filter]
    [message]
      speaker=unit
      message = _ "My leaf falls in the forest, my time is over and I enter into twilight, my-"
    [/message]
    [message]
      speaker=second_unit
      message = _ "What does it take to shut an elf up?"
    [/message]
  [/event]


# Reveal side 5 can no longer recruit wolf riders when alpha & beta wolves both dead
  [event]
    name=die
    [filter]
      id=side5_alpha,side5_beta
    [/filter]
    [filter_condition]
      [have_unit]
        id=side5_alpha,side5_beta
        count=0
      [/have_unit]
    [/filter_condition]
    [message]
      speaker=Znottiyanki
      message= _ "No!  My personal wolf supply is gone!"
    [/message]
  [/event]


# If Paddel dies, all nagas flee
  [event]
    name=die
    [filter]
      id=Paddel
    [/filter]
    [store_unit]
      [filter]
        race=naga
        canrecruit=no
      [/filter]
      variable=AEI_28_naga_flee
    [/store_unit]
    [if]
      [variable]
        name=AEI_28_naga_flee.length
        greater_than=0
      [/variable]
    [then]
      [message]
        speaker=$AEI_28_naga_flee[0].id
        message = _ "All is lost!  Save yourselves!  Flee!"
      [/message]
      [kill]
        race=naga
        animate=no
      [/kill]
    [/then]
    [/if]
    [clear_variable]
      name=AEI_28_naga_flee
    [/clear_variable]
  [/event]


# Defeat if any southern leader killed before civil war begun
  [event]
    name=die
    first_time_only=no
    [filter]
      canrecruit=yes
      side=3,4,5
    [/filter]
    [filter_condition]
      [variable]		# Civil war not started
        name=28_civilwar
        equals=no
      [/variable]
    [/filter_condition]
    [if]		# Dialogue if killed by player (highly likely)
      [variable]
        name=second_unit.side
        equals=1
      [/variable]
    [then]
      [switch]
        variable=second_unit.race
        [case]
          value=bats	# Blok translates
          [message]
            speaker=Blok
            message= _ "Says bat: <i>Ooops!</i>"
           [/message]
        [/case]
        [case]
          value=lizard
          [message]
            speaker=second_unit
            message= _ "Ooopss!"
          [/message]
        [/case]
        [else]
          [message]
            speaker=second_unit
            message= _ "Ooops!"
          [/message]
        [/else]
      [/switch]
    [/then]
    [else]
      [message]
        speaker=Flynn
        message= _ "Fortune has deserted us!  One enemy slays another!"
      [/message]
    [/else]
    [/if]
    [endlevel]
      result=defeat
    [/endlevel]
  [/event]


# Aknzlay die events
  [event]
    name=last breath
    [filter]
      canrecruit=yes
      side=2
    [/filter]
    [message]
      speaker=Aknzlay
      message= _ "Gah!  Frezz-frelkin'-git!  Done in by dross... you got lucky!
 
Here's only a talon-splinter of the horde's many claws.  It <i><b>still</b></i> gathers.  You'll <i><b>still</b></i> die here.  The horde'll <i><b>still</b></i> swarm through your lands.  All that was yours will <small><i><b>still</b></i> soon be ours-</small>"
    [/message]
  [/event]
#
# If all shamans already dead, subsequent evacuation event to enable withdrawal will fire
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=2
    [/filter]
    [if]			# Dialogue varies depending upon number and visibility of surviving orc shamans (if any)
      [have_unit]		# Visible shaman(s) alive
        type=aei_oshn,aei_osh,aei_oshe
      [/have_unit]
    [then]
      [role]
        role=morale_officer
        search_recall_list=no
        type=aei_oshn,aei_osh,aei_oshe
      [/role]
      [store_unit]		# Remove shroud (in case unit is shrouded colony controller)
        variable=aei_temp_mo
        [filter]
          role=morale_officer
        [/filter]
        kill=no
        mode=always_clear
      [/store_unit]
      [remove_shroud]
        side=1
        x,y=$aei_temp_mo.x,$aei_temp_mo.y
        radius=1
      [/remove_shroud]
      {CLEAR_VARIABLE aei_temp_mo}
      [message]
        role=morale_officer
        message = _ "Great Aknzlay is no more.  A pity.  The Great Council commands you: fight on!"
      [/message]
      [message]
        speaker=Flynn
        message = _ "Bludderit!  <i><b>Still</b></i> they maintain discipline.  Slay their shamans!"
      [/message]
    [/then]
    [else]
      [if]			# Not all bat caves revealed?
        [have_location]
          {CE_ALL_XY}
          terrain=Mm^Xm
        [/have_location]
      [then]
        [message]
          speaker=Flynn
          message = _ "Bludderit!  <i><b>Still</b></i> somehow they maintain discipline?
 
...
 
I vaguely recall that in the absence of a strong leader, orc shamans maintain order and morale - there must be at least one in hiding!"
        [/message]
      [/then]
      [/if]
    [/else]
    [/if]
#
    [if]			# If Aknzlay dead and all villages liberated...
      [have_location]		# ...nagas will always change sides...
        terrain=Wwg^Vm		# ...regardless of $27_naga_defensive
        count=0
      [/have_location]
    [then]
      [fire_event]
        name=naga_change_sides
      [/fire_event]
    [/then]
    [/if]
  [/event]


# ----------------------------------------------------------------------------------------
#
# Withdrawal and civil war events (placed here because they need to fire after die events)

# Evacuation event: enables withdrawal when:
# - Aknzlay dead
# - All shamans dead
# Note: fires after other Aknzlay and shaman die events (except start civil war below)
#
# When withdraw occurs, remove all units not in enclave
# (Saves the player having to play a rather long-winded and vaguely depressing retreat)
  [event]
    name=clear_outside_enclave
    [kill]
      side=1
      [not]
        race=bats,merman,naga
      [/not]
      [filter_location]
        [not]
          {SE_ENCLAVE_FILTER}
        [/not]
      [/filter_location]
      animate=no
    [/kill]
  [/event]
#
  [event]
    name=die
    [filter]
      id=Aknzlay
      [or]
        type=aei_oshn,aei_osh,aei_oshe
      [/or]
    [/filter]
    [filter_condition]
      [have_unit]			# Aknzlay dead
        id=Aknzlay
        count=0
      [/have_unit]
      [have_unit]			# All orc shaman(s) dead
        type=aei_oshn,aei_osh,aei_oshe
        count=0
      [/have_unit]
      [have_location]			# All bat cave(s) revealed
        {CE_ALL_XY}
        terrain=Mm^Xm
        count=0
      [/have_location]
    [/filter_condition]
    [if]
      {WITHDRAWN_CONDITION (0-6)}	# Not all required units withdrawn (highly likely)
    [then]
      [message]
        speaker=Flynn
        message = _ {ASIDE _"Good riddance!  Now must I choose which leader to weaken-"}
      [/message]
      [fire_event]
        name=discord_dialogue
      [/fire_event]
      [message]
        speaker=Flynn
        message = _ {ASIDE _"-or maybe not.  Already discord is sown!  We should withdraw."}
      [/message]
      [fire_event]		# Make sure all leaders are present
        name=Arrive_Arrah
      [/fire_event]
      [fire_event]
        name=me_cleanup
      [/fire_event]
      [fire_event]
        name=me_unhide
      [/fire_event]
      [fire_event]
        name=Arrive_Elgenefar
      [/fire_event]
      [fire_event]
        name=md_cleanup
      [/fire_event]
      [fire_event]
        name=md_unhide
      [/fire_event]
      [fire_event]
        name=Arrive_Krag
      [/fire_event]
      [fire_event]
        name=Arrive_Morn
      [/fire_event]
      [message]
        speaker=narrator
        image=wesnoth-icon.png
        message= _ "Dawn and all your leaders (except Arrah) must now withdraw into the south-east enclave.
<span foreground='#ffff00'>When the last of these units withdraw, <b>all</b> other units <b>outside</b> the south-east enclave are immediately dismissed!</span>"
      [/message]
    [/then]
    [else]
      [fire_event]
        name=discord_dialogue
      [/fire_event]
      [message]
        speaker=Flynn
        message = _ "The fates are with us!  Already are we withdrawn into our small defensible region.  Valiant soldiers: those not here retreat with honour!  "+{ASIDE _"Now to watch them kill each other..."}
      [/message]
      [fire_event]
        name=clear_outside_enclave
      [/fire_event]
    [/else]
    [/if]
    [set_variable]
      name=28_withdraw
      value=yes
    [/set_variable]
  [/event]
#
# Enemy leaders argue
  [event]
    name=discord_dialogue
    [message]
      speaker=Behlend
      message = _ "Our commanders - great Aknzlay and the shamans - are all dead.
 
We need a new boss: as Aknzlay's deputy I expect your loyalty and tribute!
In my name kill all these-"
    [/message]
    [message]
      speaker=Znottiyanki
      message = _ "And why should <i>you</i>, leads-from-behind, take charge?
 
I command the largest army <b>and</b> earned my rank in combat.
By right of strength I claim the mantle of Southern Warlord!  Now-"
    [/message]
    [message]
      speaker=Noxyus
      message = _ "Pff, neither of you would last five minutes as leader!  "+{ASIDE _"My slayers would see to that..."}+"
 
Lacking wit and guile, the complexities and intrigues of high command are beyond you both.  But not me.
However, enemies remain unslain.  We should, ah, resolve our differences later, when they are no more.  Agreed?"
    [/message]
    [message]
      speaker=Znottiyanki
      message = _ "Very well.  We fight together until the enemy are no more."
    [/message]
    [message]
      speaker=Behlend
      message = _ "So be it: we battle beside you.  "+{ASIDE _"For now."}
    [/message]
  [/event]
#
# First time any unit moves to spider's keep they find a bit of gold
# (But it will need to be used immediately, it won't last long!)
  [event]
    name=moveto
    [filter]
      x,y=77,59
      side=1
    [/filter]
    [set_variable]
      name=arrival_gold
      value=120		# 6 recalls worth
    [/set_variable]
    [set_variable]
      name=min_arrival_gold
      value=120
    [/set_variable]
    [sound]
      name=gold.ogg
    [/sound]
    [fire_event]
      name=gold_set_or_add
    [/fire_event]
    [set_variables]
      name=rspeak
      [value]
        x=$x1
        y=$y1
        r=$unit.race
        d="There's gold here!"
        e="There is some gold here!"
        h="There's some gold here!"
        l="There iss ssome gold here."
        o="Some here there's gold!"
      [/value]
    [/set_variables]
    [fire_event]
      name=rspeak
    [/fire_event]
  [/event]


# Start civil war when:
# - Aknzlay dead
# - All shamans dead
# - All player's land based units in enclave
#
# 2 possibilities:
#
# 1: Possible (but *highly* unlikely) that Aknzlay or the last shaman dies when
#     all the player's required units are already also in the se enclave
#    Hence die event check (relevant dialogue already delivered in evacuation event above)
#
# 2: Last required unit moveto enclave (requires dialogue)
#
# 1: die
  [event]
    name=die
    [filter]
      id=Aknzlay
      [or]
        type=aei_oshn,aei_osh,aei_oshe
      [/or]
    [/filter]
    [filter_condition]
      {WITHDRAWN_CONDITION 7}	# All required units withdrawn
      [variable]		# Withdraw enabled (so this *must* be Aknzlay/the last shaman)
        name=28_withdraw
        equals=yes
      [/variable]
    [/filter_condition]
    [fire_event]
      name=start_civil_war
    [/fire_event]
  [/event]
#
# 2: moveto
  [event]
    name=moveto
    [filter]
      {SE_ENCLAVE_REQUIRED}
      side=1
      [filter_location]
        {SE_ENCLAVE_FILTER}
      [/filter_location]
    [/filter]
    [filter_condition]
      {WITHDRAWN_CONDITION 7}	# All required units withdrawn
      [variable]		# Withdraw enabled
        name=28_withdraw
        equals=yes
      [/variable]
    [/filter_condition]
    [message]
      speaker=Flynn
      message = _ "Withdrawn at last!  Valiant soldiers: those not here retreat with honour!  "+{ASIDE _"Now to watch them kill each other..."}
    [/message]
    [fire_event]
      name=clear_outside_enclave
    [/fire_event]
    [fire_event]
      name=start_civil_war
    [/fire_event]
  [/event]
#
# Once withdraw started, moving any non-required unit
# to any player keep removes them from play via [kill]
  [event]
    name=moveto
    first_time_only=no
    [filter]
      side=1
      [filter_location]
        x,y=55,59		# Flynn's keep
        [or]
          {ARRAHXY}
        [/or]
        [or]
          {AEGISXY}
        [/or]
        [or]
          {BLOKXY}
        [/or]
        [or]
          {ELGENEFARXY}
        [/or]
        [or]
          {KRAGXY}
        [/or]
        [or]
          {MORNXY}
        [/or]
      [/filter_location]
      [not]
        canrecruit=yes
        [or]
          id=Dawn
        [/or]
      [/not]
    [/filter]
    [filter_condition]
      [variable]		# Withdraw enabled
        name=28_withdraw
        equals=yes
      [/variable]
    [/filter_condition]
    [kill]
      x,y=$x1,$y1
      animate=no
    [/kill]
  [/event]


#
# --- Civil war events ---
#
  [event]
    name=start_civil_war
    [if]			# If nagas not joined player, they flee
      [have_unit]
        side=6
        id=Paddel
      [/have_unit]
    [then]
      [message]
        speaker=Paddel
        message = _ "The orcs are in disarry!  This is our chance!  Flee!"
      [/message]
      [kill]
        race=naga
        animate=no
      [/kill]
    [/then]
    [/if]
    [modify_side]		# Un-ally sides 3,4,5
      side=3
      team_name=Behlend
      user_team_name= _ "Behlend"
      gold=300
      [ai]
        passive_leader=no
      [/ai]
    [/modify_side]
    [modify_side]
      side=4
      team_name=Noxyus
      user_team_name= _ "Noxyus"
      gold=450			# Noxyus fights on 2 fronts...
      [ai]
        passive_leader=no
      [/ai]
    [/modify_side]
    [modify_side]
      side=5
      team_name=Znottiyanki
      user_team_name= _ "Znottiyanki"
      gold=300
      [ai]
        passive_leader=no
      [/ai]
    [/modify_side]
    [message]
      speaker=Behlend
      message = _ "Hide and flee cowards!  When we meet again there will be no escape.
 
Battle is done.  Victory is mine.  Serve me or die!"
    [/message]
    [message]
      speaker=Znottiyanki
      message = _ "I will do neither!  <b><i>I</i></b> should be boss!"
    [/message]
    [message]
      speaker=Noxyus
      message = _ "You are both terminally mistaken."
    [/message]
    [set_variable]		# Flag civil war started
      name=28_civilwar
      value=yes
    [/set_variable]
    [modify_side]		# "Unpassive" leaders
      side=3,4,5
      [ai]
        passive_leader=no
      [/ai]
    [/modify_side]
 [/event]
#
# Once civil war started, prevent land-based units leaving enclave
  [event]
    name=moveto
    first_time_only=no
    [filter]
      side=1
      [not]
        race=bats,merman,naga
      [/not]
      [filter_location]
        [not]
          {SE_ENCLAVE_FILTER}
        [/not]
      [/filter_location]
    [/filter]
    [filter_condition]
      [variable]	# Civil war started
        name=28_civilwar
        equals=yes
      [/variable]
    [/filter_condition]
    [switch]
      variable=unit.id
      [case]		# First time dialogue for Flynn
        value=Flynn
        [fire_event]
          name=se_noexit_flynn
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Arrah
        value=Arrah
        [fire_event]
          name=se_noexit_arrah
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Aegis
        value=Aegis
        [fire_event]
          name=se_noexit_aegis
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Dawn
        value=Dawn
        [fire_event]
          name=se_noexit_dawn
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Morn
        value=Morn
        [fire_event]
          name=se_noexit_morn
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Elgenefar
        value=Elgenefar
        [fire_event]
          name=se_noexit_elgenefar
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Krag
        value=Krag
        [fire_event]
          name=se_noexit_krag
        [/fire_event]
      [/case]
      [case]		# First time dialogue for Blok
        value=Blok
        [fire_event]
          name=se_noexit_blok
        [/fire_event]
      [/case]
      [else]		# Anyone else
        [fire_event]
          name=se_noexit_other
        [/fire_event]
      [/else]
    [/switch]
    [move_unit]			# Undo move
      x,y=$x1,$y1
      to_x,to_y=$x2,$y2
    [/move_unit]
  [/event]
#
# First time dialogue when a unit leaves the enclave
  [event]
    name=se_noexit_flynn
    [message]
      speaker=Flynn
      message= _ "Let's see what's happening... excellent!  They strive with each other: the plan is working!"
    [/message]
  [/event]
  [event]
    name=se_noexit_arrah
    [message]
      speaker=Arrah
      message= _ "Wonderful: the orcs do our work for us!  Carry on, fools!"
    [/message]
  [/event]
  [event]
    name=se_noexit_aegis
    [message]
      speaker=Aegis
      message= _ "Yes!  They fight each other!"
    [/message]
  [/event]
  [event]
    name=se_noexit_dawn
    [message]
      speaker=Dawn
      message= _ "Such savagery!  And against their own kind.  Yet that is their nature.  We should pity them."
    [/message]
  [/event]
  [event]
    name=se_noexit_morn
    [message]
      speaker=Morn
      message= _ "If blood must be spilled, happy am I that it is all orcish!"
    [/message]
  [/event]
  [event]
    name=se_noexit_elgenefar
    [message]
      speaker=Elgenefar
      message= _ "Seemingly slaying is to orcs as breathing is to us: they cannot for long forswear blood-letting.  Thus with naught else to contend against, they turn on one another...  Splendid!"
    [/message]
  [/event]
  [event]
    name=se_noexit_krag
    [message]
      speaker=Krag
      message= _ "Guid!  The fightin's started.  Such a shame ah canna join in..."
    [/message]
  [/event]
  [event]
    name=se_noexit_blok
    [message]
      speaker=Blok
      message= _ "Worked plan!  Other orcs fight each!"
    [/message]
  [/event]
  [event]
    name=se_noexit_other
    [message]
      speaker=Flynn
      message= _ "Soldier!  I commend your fighting spirit, but we must not distract the orcs from killing each other.  Retreat!"
    [/message]
  [/event]


# Victory events
#
# Death dialogue if non-leader killed
  [event]
    name=last breath
    [filter]
      race=orc
      canrecruit=no
    [/filter]
    [filter_second]
      race=orc
    [/filter_second]
# +++ Only needed for debug +++
    [filter_condition]		# Only needed for debug
      [variable]		# Civil war started
        name=28_civilwar
        equals=yes
      [/variable]
    [/filter_condition]
# +++ Only needed for debug +++
    [message]
      speaker=unit
      message= _ "Ughh... avenge me!"
    [/message]
  [/event]
#
  [event]
    name=die
    [filter]
      race=orc
      canrecruit=no
    [/filter]
    [filter_second]
      race=orc
    [/filter_second]
# +++ Only needed for debug +++
    [filter_condition]		# Only needed for debug
      [variable]		# Civil war started
        name=28_civilwar
        equals=yes
      [/variable]
    [/filter_condition]
# +++ Only needed for debug +++
    [message]
      canrecruit=yes
      side=$unit.side
      message= _ "Repay our blood debt a hundred-fold!  Kill them all!"
    [/message]
    [message]
      speaker=second_unit
      message= _ "Come on then!"
    [/message]
    [fire_event]
      name=28_victory
    [/fire_event]
  [/event]
#
# Alternative dialogue if leader killed
  [event]
    name=last breath
    [filter]
      side=3,4,5
      canrecruit=yes
    [/filter]
    [filter_second]
      side=2-9			# Fire if killed by non-player unit...
    [/filter_second]
    [filter_condition]
      [variable]		# ... and civil war started
        name=28_civilwar
        equals=yes
      [/variable]
    [/filter_condition]
    [message]
      speaker=unit
      message= _ "Ughh... avenge me!  Repay our blood debt a hundred-fold!  Kill them all!"
    [/message]
  [/event]
#
  [event]
    name=die
    [filter]
      side=3,4,5
      canrecruit=yes
    [/filter]
    [filter_second]
      side=2-9			# Fire if killed by non-player unit...
    [/filter_second]
    [filter_condition]
      [variable]		# ... and civil war started
        name=28_civilwar
        equals=yes
      [/variable]
    [/filter_condition]
    [message]
      speaker=second_unit
      message= _ "Come on then!"
    [/message]
    [fire_event]
      name=28_victory
    [/fire_event]
  [/event]
#
  [event]
    name=28_victory
    [message]
      speaker=Morn
      message= _ "It is done.  The feud begins.  We should leave, swiftly and quietly..."
    [/message]
    [clear_variable]
      name=antidotes_saved, antidotes_saved_d, antidotes_saved_e, antidotes_saved_h, bbrecruit
    [/clear_variable]
    [clear_variable]
      name=m_d_name, m_e_name, tunnels_any, tunnels_dwarf, 27_naga_defensive
    [/clear_variable]
    [clear_variable]
      name=real_chest, potion_gray_end_turn, 28_dust_missed_count, ysl_respawn
    [/clear_variable]
    [clear_variable]
      name=colony_shaman_kill_count, 28_withdraw, 28_civilwar
    [/clear_variable]
    [clear_variable]
      name=28_axe,28_dust,28_inv,potion_gray_end_turn
    [/clear_variable]
    [clear_variable]
      name=add_rock,recruit_fail_wolf,shadow_status
    [/clear_variable]
    [remove_shroud]		# Reveal full map to player
      side=1
      x=0-81
      y=0-61
    [/remove_shroud]
    [endlevel]
      bonus=no
      carryover_report=no
      result=victory
    [/endlevel]
  [/event]


[event]
  name=last breath
  [filter]
    id=Flynn
  [/filter]
  [message]
    speaker=Flynn
    message= _ "So this is how it ends for me..."
  [/message]
  [endlevel]
    result=defeat
  [/endlevel]
[/event]
[event]
  name=last breath
  [filter]
    id=Morn
  [/filter]
  [message]
    speaker=Morn
    message= _ "My day is done and night falls..."
  [/message]
  [endlevel]
    result=defeat
  [/endlevel]
[/event]
[event]
  name=last breath
  [filter]
    id=Dawn
  [/filter]
  [message]
    speaker=Dawn
    message= _ "So comes my sunset..."
  [/message]
  [endlevel]
    result=defeat
  [/endlevel]
[/event]
[event]
  name=last breath
  [filter]
    id=Aegis
  [/filter]
  [message]
    speaker=Aegis
    message= _ "My lance is broken, as am I..."
  [/message]
  [endlevel]
    result=defeat
  [/endlevel]
[/event]
{AEI_PIERCE_DEATH}
{AEI_ELGENEFAR_DEATH}
{AEI_KRAG_DEATH}
{AEI_BLOK_DEATH}

[/scenario]

#undef AEI_REPLACE_MUSIC_APPEND
#undef AEI_ARRIVAL_MUSIC
#undef MORN_MUSIC
#undef ARRAH_MUSIC
#undef KRAG_MUSIC
#undef ELGENEFAR_MUSIC
#undef MIN_START_GOLD_FLYNN
#undef START_GOLD_MORN
#undef START_GOLD_ARRAH
#undef MIN_START_GOLD_KRAG
#undef MIN_START_GOLD_ELGENEFAR
#undef POTION_INV_TURNS
#undef DUST_SAFE_ATTACKS
#undef C1_XY
#undef C2_XY
#undef C3_XY
#undef C1E_XY
#undef C2E_XY
#undef C3E_XY
#undef CE_ALL_XY
#undef C1_RX
#undef C1_RY
#undef C2_RX
#undef C2_RY
#undef C3_RX
#undef C3_RY
#undef C1S_X
#undef C1S_Y
#undef C2S_X
#undef C2S_Y
#undef C3S_X
#undef C3S_Y
#undef C1_SPAM
#undef C2_SPAM
#undef C3_SPAM
#undef PACK_LEADER
#undef POTIONX_H
#undef POTIONY_H
#undef POTIONX_D
#undef POTIONY_D
#undef POTIONX_E
#undef POTIONY_E
#undef POTION_LABEL_COLOUR
#undef POTION_MOVETO
#undef MD_NORTHXY
#undef MD_SOUTHXY
#undef TE_NORTHXY
#undef TE_SOUTHXY
#undef TFE_NORTHXY
#undef TFE_SOUTHXY
#undef TW_NORTHXY
#undef TW_SOUTHXY
#undef T_EASTXY
#undef T_WESTXY
#undef TA_EASTXY
#undef TA_WESTXY
#undef TB_NORTHXY
#undef TB_SOUTHXY
#undef TAE_ARRAHXY
#undef TAE_ELGENEFARXY
#undef TKM_KRAGXY
#undef TKM_MORNXY
#undef TUNNELS_FILTER_ALL
#undef TUNNELS_FILTER_DWARF
#undef TUNNEL_TELEPORT_DWARF
#undef TUNNEL_TELEPORT_ALL
#undef KRAGX
#undef KRAGY
#undef KRAGXY
#undef BLOKXY
#undef CHEST_POTIONX
#undef CHEST_POTIONY
#undef CHEST_POTION
#undef CHEST_GRITX
#undef CHEST_GRITY
#undef CHEST_GRIT
#undef CHEST_AXEX
#undef CHEST_AXEY
#undef CHEST_AXE
#undef ELGENEFARX
#undef ELGENEFARY
#undef ELGENEFARXY
#undef ARRAHXY
#undef MORNXY
#undef AEGISXY
#undef REMOVE_OBJECT
#undef NVJ
#undef NVG1
#undef NVG2
#undef SE_ENCLAVE_FILTER
#undef SE_ENCLAVE_REQUIRED
#undef WITHDRAWN_CONDITION
#undef ENEMY_LEADERS
#undef SIDE7_FILTER
#undef SIDE7_AVOID
