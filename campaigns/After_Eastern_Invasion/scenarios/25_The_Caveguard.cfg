#textdomain wesnoth-AfterEI

# Shroud is ON

# Villages	31 in total
# Side 2	Income  8:	6 x Uu^Vo
# Side 3	Income  8:	Uh^Vo except 1,12 & 12,6
# Side 4	Income  6:	3 x Co^Vo + jailer at 27,29
# Side 5	Income  9:	5 x Ur^Vo + 12,6, 1,12
# Side 6	Income 10:	8 cave villages
#
# Note: many ai villages captured by placing [unit]s in them, not by [capture_village]

#define ROCKXY
x,y=15,3#enddef

#define BRIDGEXY
x,y=1,3#enddef

#define FIREXY
x,y=9,5#enddef

#define DECOYXY
x,y=9,1#enddef

#define REALXY
x,y=7,1#enddef

#define LEVERXY
x,y=13,4#enddef


# Filter for sighted leader event
#define SIGHTED_FILTER SIDE
    [filter]
      canrecruit=yes
      side={SIDE}
      [filter_vision]
        side=1
      [/filter_vision]
    [/filter]
    [filter_condition]
      [variable]
        name=side{SIDE}_flag
        equals=no
      [/variable]
    [/filter_condition]
#enddef
#
# Clear shroud so speaker is visible to player
#define SIGHTED_REMOVE_SHROUD
    [remove_shroud]
      side=1
      x,y=$x1,$y1
      radius=1
    [/remove_shroud]
#enddef
#
# Gold boost for side when sighted
#define SIDE_SIGHTED SIDE GOLD_EASY GOLD_NORMAL GOLD_HARD
    [gold]
      side={SIDE}
      {QUANTITY amount {GOLD_EASY} {GOLD_NORMAL} {GOLD_HARD}}
    [/gold]
    [set_variable]
      name=side{SIDE}_flag
      value=yes
    [/set_variable]
#enddef


[scenario]
  id=25_The_Caveguard
  name=_"The Caveguard"
  next_scenario=26_The_Coveguard
  map_data="{~add-ons/AfterEI/maps/25_The_Caveguard.map}"
  turns=66
  victory_when_enemies_defeated=no

  [music]
    name="the_deep_path.ogg"	# [story] music continues
    immediate=yes
  [/music]
  {APPEND_MUSIC northerners.ogg}
  {APPEND_MUSIC knalgan_theme.ogg}
  {APPEND_MUSIC legends_of_the_north.ogg}
  {APPEND_MUSIC northern_mountains.ogg}

  [story]
    [part]
      show_title=yes
      story= _ "Cautiously they followed the path north west.  It descended steeply, eventually leading underground..."
      {MAPTRAX_25}
    [/part]
  [/story]

  {UNDERGROUND}

# Our heroes
  [side]
{FLYNN}
    shroud=yes		# Restricted to underground areas
    gold=400		# Or carryover
    side_name= _ "Blok and Krag"
    color=gold
    {FLAG_VARIANT knalgan}
  [/side]


# Enemy sides
#
# Intial opponent fights alone at first to allow player to gain foothold
  [side]
    side=2		# Starting villages 6, income 8
    type=Orcish Ruler
    id=Southwarden
    profile=portraits/orcs/grunt-5.png
    name= _ "Southwarden"
    [modifications]
      {TRAIT_INTELLIGENT}
      {TRAIT_QUICK}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Southguard"
#ifdef EASY
    recruit=Orcish Archer, Orcish Grunt
#else
    recruit=Orcish Archer, Orcish Grunt, Orcish Warrior
#endif
    controller=ai
    [ai]
      passive_leader=yes
    [/ai]
    hidden=yes
    color=black
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD 50 60 70}
  [/side]

#ifdef NORMAL
{LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Orcish Warrior) 1}
#endif

#ifdef HARD
{LIMIT_CONTEMPORANEOUS_RECRUITS 2 (Orcish Warrior) 2}
#endif

# 
# Note: Sides 3,4,5 have negative starting gold but have income from villages.
# This delays recruitment (otherwise gameplay can easily become deadlocked).
# Get a gold boost when leader first sighted
  [side]
    side=3		# Starting villages=6, income=8.  Delay={5 4 4} turns
    type=Orcish Ruler
    id=Westwarden
    profile=portraits/orcs/leader-2.png
    name= _ "Westwarden"
    [modifications]
      {TRAIT_RESILIENT}
      {TRAIT_INTELLIGENT}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Westguard"
    recruit=Orcish Archer, Orcish Grunt, Orcish Warrior, Orcish Crossbowman, Orcish Assassin, Orcish Slayer
    controller=ai
    [ai]
      passive_leader=yes
    [/ai]
    hidden=yes
    color=teal
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD -40 -32 -32}
  [/side]

  [side]
    side=4		# Starting villages=4, income=6.  Delay={4 3 2} turns
    type=Orcish Ruler
    id=Eastwarden
    profile=portraits/orcs/warlord.png
    name= _ "Eastwarden"
    [modifications]
      {TRAIT_INTELLIGENT}
      {TRAIT_STRONG}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Eastguard"
    recruit=Orcish Archer, Orcish Grunt, Orcish Warrior, Orcish Crossbowman
    controller=ai
    [ai]
      passive_leader=yes
    [/ai]
    hidden=yes
    color=brown
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD -24 -18 -12}
    [unit]
      id=Jailer
      name= _ "Jailer"
      x,y=27,29
      type=Orcish Warrior
      [modifications]
        {TRAIT_RESILIENT}
        {TRAIT_STRONG}
      [/modifications]
      random_traits=no
      generate_name=no
      random_gender=yes
      upkeep=free
      animate=no
    [/unit]
  [/side]

  [side]
    side=5		# Starting villages=7, income=9.  Delay={4 4 3} turns
    type=Orcish Ruler
    id=Northwarden
    name= _ "Northwarden"
    [modifications]
      {TRAIT_STRONG}
      {TRAIT_RESILIENT}
    [/modifications]
    canrecruit=yes
    team_name= Orcs
    user_team_name= _ "Northguard"
    recruit=Orcish Archer, Orcish Grunt, Orcish Warrior, Orcish Crossbowman, Orcish Slayer
    controller=ai
    [ai]
      passive_leader=yes
    [/ai]
    hidden=yes
    color=orange
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    {GOLD -36 -36 -27}
  [/side]

# Goblins don't attack unless attacked
  [side]
    side=6
    type=Goblin Rouser
    id=Cob
    name= _ "Cob"
    [modifications]
      {TRAIT_SLOW}
    [/modifications]
    canrecruit=yes
    team_name=Orcs
    user_team_name= _ "Goblin Farmers"
    recruit=Goblin_Spearling, Goblin Spearman, Goblin Impaler
    controller=ai
    [ai]
      passive_leader=yes
    [/ai]
    hidden=yes
    color=purple
    flag=flags/ragged-flag-[1~6].png:150
    flag_icon=flags/ragged-flag-icon.png
    gold=0
  [/side]

# Saurians
  [side]
    side=7
    no_leader=yes
    team_name=Heroes
    controller=null
    hidden=yes
    color=green
    gold=0
    income=-2
    [unit]
      id=Ssoothz
      name="Ssoothz"
      x,y=31,34
      type=Saurian Augur
      [modifications]
        {TRAIT_QUICK}
      [/modifications]
      random_traits=no
      generate_name=no
      random_gender=yes
      hitpoints=3
#ifdef EASY
      experience=19
#endif
#ifdef NORMAL
      experience=15
#endif
#ifdef HARD
      experience=11
#endif
    [/unit]
    [unit]
      id=Sstingz
      name="Sstingz"
      x,y=27,34
      type=Saurian Skirmisher
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
      random_traits=no
      generate_name=no
      random_gender=yes
      hitpoints=4
#ifdef EASY
      experience=23
#endif
#ifdef NORMAL
      experience=18
#endif
#ifdef HARD
      experience=13
#endif
    [/unit]
  [/side]

# --- Events ---

# Add Weak-Willed trait to Orc and Goblin recruitment (for consistency)
# Here: 25% weak-willed and if so penalty is 40,50,60 or 70
{ADD_TRAIT_WW_ONLY race=orc,goblin 0,0,0,40,0,0,0,50,0,0,0,60,0,0,0,70}


# Limit contemporaneous assassins and slayers
# (Player will have at best 1 healer)
  [event]
    name=side turn
    first_time_only=no
    [filter_condition]
      [have_unit]
        side=$side_number
        [and]
          side=3,5
        [/and]
      [/have_unit]
    [/filter_condition]
    [if]
      [have_unit]
        side=3,5
        type=Orcish Assassin, Orcish Slayer
#ifdef EASY
        count=3-99999
#endif
#ifdef NORMAL
        count=5-99999
#endif
#ifdef HARD
        count=7-99999
#endif
      [/have_unit]
    [then]
      [disallow_recruit]
        side=$side_number
        type=Orcish Assassin, Orcish Slayer
      [/disallow_recruit]
    [/then]
    [else]
      [if]
        [variable]
          name=side_number
          value=3
        [/variable]
      [then]
        [allow_recruit]
          side=$side_number
          type=Orcish Assassin, Orcish Slayer
        [/allow_recruit]
      [/then]
      [else]
        [allow_recruit]
          side=$side_number
          type=Orcish Slayer
        [/allow_recruit]
      [/else]
      [/if]
    [/else]
    [/if]
  [/event]
#
  [event]
    name=recruit
    first_time_only=no
    [filter]
      side=3,5
      type=Orcish Assassin, Orcish Slayer
    [/filter]
    [filter_condition]
      [have_unit]
        side=3,5
#ifdef EASY
        count=3-99999
#endif
#ifdef NORMAL
        count=5-99999
#endif
#ifdef HARD
        count=7-99999
#endif
      [/have_unit]
    [/filter_condition]
    [disallow_recruit]
      side=$side_number
      type=Orcish Assassin, Orcish Slayer
    [/disallow_recruit]
  [/event]


# Race-dependent dialogue event (rdde)
  [event]
    name=rdde
    first_time_only=no
    [store_unit]
      variable=rdde_unit
      [filter]
        x,y=$rdde.x,$rdde.y
      [/filter]
      kill=no
    [/store_unit]
    [switch]
      variable=rdde_unit.race
      [case]
        value=bats	# Blok translates
        [message]
          speaker=Blok
          message= _ "Says bat: <i>$rdde.o</i>"
         [/message]
      [/case]
      [case]
        value=ogre
        [message]
          x,y=$rdde.x,$rdde.y
          message= _ "$rdde.o"
        [/message]
      [/case]
      [case]
        value=lizard
        [message]
          x,y=$rdde.x,$rdde.y
          message= _ "$rdde.s"
        [/message]
      [/case]
      [else]		# Default is dwarf
        [message]
          x,y=$rdde.x,$rdde.y
          message= _ "$rdde.d"
        [/message]
      [/else]
    [/switch]
    [clear_variable]
      name=rdde_unit, rdde
    [/clear_variable]
  [/event]


# Sides 3,4,5 leader sighted events
  [event]
    name=sighted,moveto
    {SIGHTED_FILTER 3}
    {SIGHTED_REMOVE_SHROUD}
    [message]
      x,y=$x1,$y1
      message= _ "What have we here?  Uninvited guests?  We <i><b>insist</b></i> you stay as dinner."
    [/message]
    {SIDE_SIGHTED 3 140 170 200}
    [set_variable]
      name=cu_side
      value=3
    [/set_variable]
    [set_variable]
      name=cu_x
      value=2
    [/set_variable]
    [set_variable]
      name=cu_y
      value=13
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=3
    [/set_variable]
    [set_variable]
      name=cu_y
      value=14
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=4
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [fire_event]
      name=archer_or_grunt_clear
    [/fire_event]
  [/event]
#
  [event]
    name=sighted,moveto
    {SIGHTED_FILTER 4}
    {SIGHTED_REMOVE_SHROUD}
    [message]
      x,y=$x1,$y1
      message= _ "Scum!  Your stench befouls our home!  Time to throw out the rubbish!"
    [/message]
    {SIDE_SIGHTED 4 160 200 240}
    [set_variable]
      name=cu_side
      value=4
    [/set_variable]
    [set_variable]
      name=cu_x
      value=30
    [/set_variable]
    [set_variable]
      name=cu_y
      value=24
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=29
    [/set_variable]
    [set_variable]
      name=cu_y
      value=25
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_y
      value=26
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [fire_event]
      name=archer_or_grunt_clear
    [/fire_event]
  [/event]
#
  [event]
    name=sighted,moveto
    {SIGHTED_FILTER 5}
    {SIGHTED_REMOVE_SHROUD}
    [message]
      x,y=$x1,$y1
      message= _ "This far and no further shall you go.  Welcome to your tomb..."
    [/message]
    {SIDE_SIGHTED 5 210 250 290}
    [set_variable]
      name=cu_side
      value=5
    [/set_variable]
    [set_variable]
      name=cu_x
      value=26
    [/set_variable]
    [set_variable]
      name=cu_y
      value=5
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=27
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=28
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [set_variable]
      name=cu_x
      value=29
    [/set_variable]
    [fire_event]
      name=archer_or_grunt
    [/fire_event]
    [fire_event]
      name=archer_or_grunt_clear
    [/fire_event]
  [/event]


# "Unpassive" 3,4,5 leader events
  [event]
    name=moveto
    [filter]
      side=1
      [filter_adjacent]
        canrecruit=yes
        side=3
      [/filter_adjacent]
    [/filter]
    [modify_side]
      side=3
      [ai]
        passive_leader=no	# Side 3 leader now not passive
      [/ai]
    [/modify_side]
  [/event]
#    
  [event]
    name=moveto
    [filter]
      side=1
      [filter_adjacent]
        canrecruit=yes
        side=4
      [/filter_adjacent]
    [/filter]
    [modify_side]
      side=4
      [ai]
        passive_leader=no	# Side 4 leader now not passive
      [/ai]
    [/modify_side]
  [/event]
#
  [event]
    name=moveto
    [filter]
      side=1
      [filter_adjacent]
        canrecruit=yes
        side=5
      [/filter_adjacent]
    [/filter]
    [modify_side]
      side=5
      [ai]
        passive_leader=no	# Side 5 leader now not passive
      [/ai]
    [/modify_side]
  [/event]


# Prevent side 6 (Goblins) doing anything until attacked
  [event]
    name=side 6 turn
    first_time_only=no
    [filter_condition]
      [variable]
        name=gattacked_flag
        equals=no
      [/variable]
    [/filter_condition]
    [end_turn]
    [/end_turn]
  [/event]
#
# Goblins don't attack until attacked
# Note: can prevent recruitment by occupying goblin castle hexes
  [event]
    name=attack
    [filter]
      side=6
    [/filter]
    [if]
      [have_unit]	# Goblin leader attacked
        x,y=$x2,$y2
        canrecruit=yes
      [/have_unit]
    [then]
      [message]
        x,y=$x2,$y2
        message= _ "Eeek!"
      [/message]
    [/then]
    [else]
      [message]
        x,y=$x2,$y2
        message= _ "Help!"
      [/message]
    [/else]
    [/if]
    [set_variable]
      name=gattacked_flag
      value=yes
    [/set_variable]
  [/event]


# --- Vault gate keys pickup events ---

# Generic event to pick up one of keys 1-4
  [event]
    name=keys_pickup
    first_time_only=no
    [remove_item]
      image=$keys.img
      x,y=$keys.x,$keys.y
    [/remove_item]
    [set_variables]
      name=rdde
      [value]
        x=$keys.x
        y=$keys.y
        o="Key me """+$keys.n+""" have!"
        s="Ssecured key number """+$keys.n+"""!"
        d="Got key number """+$keys.n+"""!"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
    [set_variable]
      name="vgk$keys.n"
      value=yes
    [/set_variable]
    [clear_variable]
      name=keys
    [/clear_variable]
  [/event]


# Pickup keys

# Key1
  [event]
    name=moveto
    [filter]
      x,y=12,6
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=keys
      [value]
        x=$x1
        y=$y1
        n="3"		# Key id
        img="items/key-1.png"
      [/value]
    [/set_variables]
    [fire_event]
      name=keys_pickup
    [/fire_event]
  [/event]

# Key2
  [event]
    name=moveto
    [filter]
      x,y=15,34
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=keys
      [value]
        x=$x1
        y=$y1
        n="2"		# Key id
        img="items/key-2.png"
      [/value]
    [/set_variables]
    [fire_event]
      name=keys_pickup
    [/fire_event]
  [/event]

# Key3
  [event]
    name=moveto
    [filter]
      x,y=3,10
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=keys
      [value]
        x=$x1
        y=$y1
        n="1"		# Key id
        img="items/key-3.png"
      [/value]
    [/set_variables]
    [fire_event]
      name=keys_pickup
    [/fire_event]
  [/event]

# Key4 - done as part of side 4 real stash pickup


# --- Hints related events ---

# Hints
  [event]
    name=moveto
    first_time_only=no
    [filter]
      side=1
      [filter_adjacent]
        role=yettohint
      [/filter_adjacent]
    [/filter]
    [filter_condition]		# Do nothing if all hints issued
      [variable]
        name=gf_hints.length
        greater_than=0
      [/variable]
    [/filter_condition]
    [store_unit]		# Store Goblin unit
      variable=this_gf
      [filter]
        side=6
        [filter_adjacent]
          x,y=$x1,$y1
          side=1
        [/filter_adjacent]
      [/filter]
      kill=no
    [/store_unit]
    [message]
      speaker=$this_gf.id
      message= _ "Me not want fight!  Me hear talk.  Me tell, me go?"
      [option]
        label= _ "No"
        [command]		# Change role so event only fires once per Goblin
          [modify_unit]
            [filter]
              id=$this_gf.id
            [/filter]
            role=donehinting
          [/modify_unit]
        [/command]
      [/option]
      [option]
        label= _ "Yes"
        [command]
          [if]
            [have_unit]		# If leader, issue best remaining hint
              id=$this_gf.id
              canrecruit=yes
            [/have_unit]
          [then]
            [set_variable]
              name=random_hint
              value=$gf_hints.length
            [/set_variable]
          [/then]
          [else]
            [if]
              [variable]	# First 4 hints exclude most helpful ones...
                name=gf_hints.length
                greater_than=6
              [/variable]
            [then]
              [set_variable]
                name=random_hint
                rand=1..6
              [/set_variable]
            [/then]
            [else]
              [set_variable]
                name=random_hint
                rand=1..$gf_hints.length
              [/set_variable]
            [/else]
            [/if]
          [/else]
          [/if]
          [set_variable]
            name=random_hint
            sub=1
          [/set_variable]
          [message]
            speaker=$this_gf.id
            message= _ "<i>$gf_hints[$random_hint].h</i>.
 
Me go."
          [/message]
          [set_variable]	# Hopefully =0 first time (when $p_hints undefined!)
            name=ph_next
            value=$p_hints.length
          [/set_variable]
          [set_variable]
            name=p_hints[$ph_next].h
            value=$gf_hints[$random_hint].h
          [/set_variable]
          [clear_variable]
            name=gf_hints[$random_hint]
          [/clear_variable]
          [clear_variable]
            name=random_hint, ph_next
          [/clear_variable]
          [kill]
            id=$this_gf.id
            animate=no
            fire_event=yes	# Only needed for leader
          [/kill]
          [fire_event]
            name=hint_review_howto
          [/fire_event]
        [/command]
      [/option]
    [/message]
    [clear_variable]
      name=this_gf
    [/clear_variable]
  [/event]
#
  [event]
    name=hint_review_howto
    [message]
      speaker=narrator
      image=terrain/village/cave2.png
      message= _ "To review what you've been told, move any <b>uninjured</b> unit to any cave (goblin) village.
Once stationed in the village the unit must have moves remaining."
    [/message]
  [/event]
#
  [event]
    name=moveto			# Moves=0 disables firing post-capture.  Bats OK here
    first_time_only=no
    [filter]
      side=1
      [filter_location]
        terrain=Uu^Vu
      [/filter_location]
    [/filter]
    [filter_condition]
      [variable]		# Uninjured
        name=unit.hitpoints
        numerical_equals=$unit.max_hitpoints
      [/variable]
      [variable]		# Movement remaining
        name=unit.moves
        greater_than=0
      [/variable]
      [variable]		# 1+ hints garnered
        name=p_hints.length
        greater_than=0
      [/variable]
    [/filter_condition]
    [set_variable]
      name=hint_list
      [join]
        variable=p_hints
        key=h
        separator="
"
      [/join]
    [/set_variable]
    [if]
      [variable]
        name=gf_hints.length
        greater_than=0
      [/variable]
    [then]
      [message]
        speaker=narrator
        image=items/book1.png
        message= _ "What the goblins have said:
 
<i>$hint_list</i>"
      [/message]
    [/then]
    [else]		# All hints issued
      [message]
        speaker=narrator
        image=items/book1.png
        message= _ "<i>$hint_list</i>
 
The goblins have nothing more to tell."
      [/message]
    [/else]
    [/if]
    [clear_variable]
      name=hint_list
    [/clear_variable]
  [/event]


# --- Some gold stash events (rest are leader die events) ---

# Generic event to collect gold
  [event]
    name=loot_gold
    first_time_only=no
    [set_variable]
      name=gold_stash
      rand=$loot.g
    [/set_variable]
    [set_variables]
      name=rdde
      [value]
        x=$loot.x
        y=$loot.y
        o="$loot.o1 $gold_stash $loot.o2"
        s="$loot.s1 $gold_stash $loot.s2"
        d="$loot.d1 $gold_stash $loot.d2"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
    [sound]
      name=gold.ogg
    [/sound]
    [remove_item]
      image=$loot.img
      x,y=$loot.x,$loot.y
    [/remove_item]
    [gold]
      side=1
      amount=$gold_stash
    [/gold]
    [clear_variable]
      name=loot, gold_stash
    [/clear_variable]
  [/event]


# Side 2 stash area gold pickup
  [event]
    name=moveto
    [filter]
      x,y=13,34
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="45..55"	# Random gold range
        img="items/gold-coins-small.png"
        o1="Gold here there's"
        o2="!"
        s1="There iss"
        s2="gold here!"
        d1="There's"
        d2="gold here!"
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
  [/event]
#
# Side 2 hidden alcove create (key2 only)
  [event]
    name=moveto
    [filter]
      x,y=14,34
      side=1
    [/filter]
    [terrain]
      x,y=15,34
      terrain=Uh
    [/terrain]
    [item]
      image=items/key-2.png
      x,y=15,34
    [/item]
    [redraw]
    [/redraw]
  [/event]

# Side 3 stash area gold pickup
  [event]
    name=moveto
    [filter]
      x,y=6,12
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="95..105"	# Random gold range
        img="items/gold-coins-small.png"
        o1="Gold here there's"
        o2="!"
        s1="There iss"
        s2="gold here!"
        d1="There's"
        d2="gold here!"
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
  [/event]

# Side 4 decoy stash area gold pickup
  [event]
    name=moveto
    [filter]
      x,y=32,26
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="25..35"	# Random gold range
        img="items/gold-coins-small.png"
        o1="Gold here there's"
        o2="only!"
        s1="There iss only"
        s2="gold here!"
        d1="There's only"
        d2="gold here!"
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
  [/event]
#
# Side 4 real stash area create (behind decoy stash)
  [event]
    name=moveto
    [filter]
      x,y=31,27
      side=1
    [/filter]
    [terrain]
      x,y=31,28
      terrain=Uu
    [/terrain]
    [terrain]
      x,y=32,28
      terrain=Uh
    [/terrain]
    [item]
      image=items/gold-coins-small.png
      x,y=32,28
    [/item]
    [item]
      image=items/key-4.png
      x,y=32,28
    [/item]
    [remove_shroud]	# Remove shroud
      side=1
      x,y=31,28
    [/remove_shroud]
    [redraw]
    [/redraw]
  [/event]
#
# Side 4 real stash area gold and key4 pickup
  [event]
    name=moveto
    [filter]
      x,y=32,28
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="85..95"	# Random gold range
        img="items/gold-coins-small.png"
        o1="Oho!  More it that's like!  Gold here there's"
        o2=" Must've decoy a the lot been last..."
        s1="Bonuss!  There iss"
        s2="gold here!  The lasst lot wass a decoy..."
        d1="Aha!  That's more like it!  There's"
        d2="gold here!  The last lot must've been a decoy..."
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
    [set_variables]
      name=keys
      [value]
        x=$x1
        y=$y1
        n="4"		# Key id
        img="items/key-4.png"
      [/value]
    [/set_variables]
    [fire_event]
      name=keys_pickup
    [/fire_event]
  [/event]

# Side 5 stash area gold pickup
  [event]
    name=moveto
    [filter]
      x,y=26,2
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="145..155"	# Random gold range
        img="items/gold-coins-medium.png"
        o1="Good!  Gold here there's"
        o2="!"
        s1="Ssuperb!  There iss"
        s2="gold here!"
        d1="Nice!  There's"
        d2="gold here!"
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
  [/event]
#
# Side 5 second chamber (back door)
  [event]
    name=moveto
    [filter]
      x,y=25,3
      side=1
    [/filter]
    [terrain]
      x=24,23
      y= 2, 2
      terrain=Uu
    [/terrain]
    [remove_shroud]
      side=1
      x,y=24,2
    [/remove_shroud]
    [redraw]
    [/redraw]
  [/event]

# Side 6 stash area gold pickup
  [event]
    name=moveto
    [filter]
      x,y=12,27
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=loot
      [value]
        x=$x1
        y=$y1
        g="15..25"	# Random gold range
        img="items/gold-coins-small.png"
        o1="Didn't much Goblins have.  Gold here there's"
        o2="only!"
        s1="Sscant fundss, only"
        s2="gold here..."
        d1="Goblins dinna have much.  There's only"
        d2="gold here..."
      [/value]
    [/set_variables]
    [fire_event]
      name=loot_gold
    [/fire_event]
  [/event]


# --- Unit create events---

# Create vault guard
  [event]
    name=vguard
    first_time_only=no
    [set_variable]		# 40% chance of being weak-willed
      name=ww_penalty
      rand=0,0,0,0,0,0,40,50,60,70
    [/set_variable]
    [switch]
      variable=ww_penalty
      [case]
        value=40,50,60,70
        [unit]
          side=3
          x,y=$vguard.x,$vguard.y
          type=$vguard.r
          [modifications]
            [trait]
              id="weakwilled$ww_penalty"
              male_name= _ "weak-willed"
              female_name= _ "female^weak-willed"
              description= _ "Suffers increased damage from magic"
              [effect]
                apply_to=resistance
                replace=no
                [resistance]
                  fire=$ww_penalty
                  arcane=$ww_penalty
               [/resistance]
             [/effect]
           [/trait]
          [/modifications]
          random_traits=yes
          generate_name=yes
          random_gender=yes
          role=vguard
          upkeep=free
          animate=no
        [/unit]
      [/case]
      [else]
        [unit]
          side=3
          x,y=$vguard.x,$vguard.y
          type=$vguard.r
          random_traits=yes
          generate_name=yes
          random_gender=yes
          role=vguard
          upkeep=free
          animate=no
        [/unit]
      [/else]
    [/switch]
    [clear_variable]
      name=vguard,ww_penalty
    [/clear_variable]
  [/event]

# Create random Orcish Archer or Grunt
  [event]
    name=archer_or_grunt
    first_time_only=no
    [if]
      [have_unit]
        x,y=$cu_x,$cu_y
      [/have_unit]
    [then]
      [set_variable]
        name=cu_to_y
        value=$cu_y
      [/set_variable]
      [set_variable]
        name=cu_to_y
        add=1
      [/set_variable]
      [move_unit]
        x,y=$cu_x,$cu_y
        to_x=$cu_x
        to_y=$cu_to_y
        check_passability=yes
      [/move_unit]
    [/then]
    [/if]
    [set_variable]
      name=cu_type
      rand=Orcish Archer,Orcish Grunt
    [/set_variable]
    [unit]
      side=$cu_side
      x,y=$cu_x,$cu_y
      type=$cu_type
      random_traits=yes
      generate_name=yes
      random_gender=yes
      animate=yes
    [/unit]
    [clear_variable]
      name=cu_type, cu_to_y
    [/clear_variable]
  [/event]
#
# Clear archer_or_grunt variables
  [event]
    name=archer_or_grunt_clear
    first_time_only=no
    [clear_variable]
      name=cu_x, cu_y, cu_side
    [/clear_variable]
  [/event]


# --- Vault events ---

# Reveal entrance passage moveto
  [event]
    name=moveto
    [filter]
      x= 1, 3
      y=12,10
      side=1
    [/filter]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="At the there's corridor back a!"
        s="There iss a corridor at the back!"
        d="There's a corridor at the back!"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
    [terrain]		# Shroud not removed
      x= 1, 2
      y=11,10
      terrain=Uu
    [/terrain]
    [redraw]
    [/redraw]
  [/event]

# Note: bats do not activate traps...

# Generic event to animate an item being dropped
  [event]
    name=dropitem
    first_time_only=no
    [for]
      variable=i
      start=1
      end=$di.y
      step=1
      [do]
        [remove_shroud]
          side=1
          x,y=$di.x,$i
          radius=1
        [/remove_shroud]
        [scroll_to]
          x,y=$di.x,$i
        [/scroll_to]
        [if]
          [variable]
            name=i
            numeric_equals=$di.y
          [/variable]
          [variable]
            name=di.r
            not_equals="no"
          [/variable]
        [then]
          [remove_item]
            image=$di.r
            x,y=$di.x,$di.y
          [/remove_item]
        [/then]
        [/if]
        [item]
          image=$di.i
          x,y=$di.x,$i
        [/item]
        [if]
          [variable]
            name=i
            less_than=$di.y
          [/variable]
        [then]
          [delay]
            time=250
          [/delay]
          [remove_item]
            image=$di.i
            x,y=$di.x,$i
          [/remove_item]
        [/then]
        [/if]
      [/do]
    [/for]
    [clear_variable]
      name=di
    [/clear_variable]
  [/event]

# Rubble room at {ROCKXY}
  [event]		# Dwarves will spot the falling rock trap if adjacent to it
    name=moveto
    [filter]
      x=14,15,16
      y= 2, 2, 2
      race=dwarf
      side=1
    [/filter]
    [filter_condition]	# Trap not yet sprung
      [have_location]
        {ROCKXY}
        terrain=Uu^Es
      [/have_location]
    [/filter_condition]
    [message]
      speaker=unit
      message= _ "Ach, it's a trap!  Dinna go in the middle!"
    [/message]
  [/event]
#
  [event]
    name=moveto
    [filter]
      {ROCKXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variables]
      name=di
      [value]
        x=15
        y=3
        i="scenery/rock2.png"
        r="items/chest.png"
      [/value]
    [/set_variables]
    [sound]
      name=explosion.ogg
    [/sound]
    [fire_event]
      name=dropitem
    [/fire_event]
    [terrain]
      terrain=Uu^Dr
      {ROCKXY}
    [/terrain]
    [redraw]
    [/redraw]
    {QUAKE rumble.ogg}
    [harm_unit]
      [filter]
        {ROCKXY}
      [/filter]
      animate=defender
      damage_type=impact
      amount=37
    [/harm_unit]
    [clear_variable]
      name=dr_x
    [/clear_variable]
  [/event]

# Bridge trap at {BRIDGEXY}
  [event]		# Dwarves will spot the trap once on the sw bridge section
    name=moveto
    [filter]
      x=2,3
      y=2,2
      race=dwarf
      side=1
    [/filter]
    [filter_condition]	# Trap not yet sprung
      [have_location]
        {BRIDGEXY}
        terrain=Qxu^Bp/
      [/have_location]
    [/filter_condition]
    [message]
      speaker=unit
      message= _ "Ach, the far end is trapped!  Dinna go there!"
    [/message]
  [/event]
#
  [event]
    name=moveto
    [filter]
      {BRIDGEXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [sound]
      name=explosion.ogg
    [/sound]
    [set_variables]
      name=di
      [value]
        x=1
        y=3
        i="scenery/rock2.png"
        r="items/chest.png"
      [/value]
    [/set_variables]
    [fire_event]
      name=dropitem
    [/fire_event]
    [sound]
      name=mace.ogg
    [/sound]
    [kill]
      {BRIDGEXY}
      animate=yes
      fire_event=yes
    [/kill]
    [terrain]
      terrain=Qxu
      {BRIDGEXY}
    [/terrain]
    [remove_item]
      image=scenery/rock2.png
      {BRIDGEXY}
    [/remove_item]
    [redraw]
    [/redraw]
    [item]
      image=scenery/rock2.png
      x,y=1,4
    [/item]
    [delay]
      time=250
    [/delay]
    [remove_item]
      image=scenery/rock2.png
      x,y=1,4
    [/remove_item]
    [sound]
      name=water-blast.wav
    [/sound]
  [/event]

# Fire trap at {FIREXY}
  [event]		# Dwarves will spot the fire trap if adjacent to it
    name=moveto
    [filter]
      x=8,8,9,9,10,10
      y=4,5,4,6, 4, 5
      race=dwarf
      side=1
    [/filter]
    [filter_condition]	# Trap not yet sprung
      [have_location]
        {FIREXY}
        terrain=Uu^Ebn
      [/have_location]
    [/filter_condition]
    [message]
      speaker=unit
      message= _ "Ach, it's a trap!  Dinna touch the chest!"
    [/message]
  [/event]
#
  [event]
    name=moveto
    [filter]
      {FIREXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [sound]
      name=flame-big.ogg
    [/sound]
    [for]
      variable=i
      start=1
      end=16
      step=1
      [do]
        [set_variable]
          name=fbtrap_sequence
          formula='projectiles/fireball-impact-'..'"$i"'..'.png'
        [/set_variable]
        [item]
          halo=$fbtrap_sequence
          {FIREXY}
        [/item]
        [delay]
          time=200
        [/delay]
        [remove_item]
          halo=$fbtrap_sequence
          {FIREXY}
        [/remove_item]
      [/do]
    [/for]
    [terrain]
      {FIREXY}
      terrain=Uu^Eb
    [/terrain]
    [remove_item]
      image=items/chest.png
      {FIREXY}
    [/remove_item]
    [harm_unit]
      [filter]
        {FIREXY}
      [/filter]
      animate=defender
      damage_type=fire
      amount=32
    [/harm_unit]
    [redraw]
    [/redraw]
    [clear_variable]
      name=fbtrap_sequence
    [/clear_variable]
  [/event]

# Decoy chest at {DECOYXY}
  [event]		# Dwarves will spot the decoy if adjacent to it
    name=moveto
    [filter]
      x,y=8,1
      race=dwarf
      side=1
      [filter_location]	# Trap not sprung (so $real_chest <> lost)
        terrain=Uu
      [/filter_location]
    [/filter]
    [if]	# Real treasure chest already looted
      [variable]
        name=real_chest
        equals=yes
      [/variable]
    [then]
      [message]
        speaker=unit
        message= _ "The eastern wooden flooring's setup tae collapse the western wooden section.  Guid job we already got the gold!"
      [/message]
    [/then]
    [else]
      [message]
        speaker=unit
        message= _ "Ach, the eastern wooden flooring's setup tae collapse the western wooden section.  Dinna step on it!"
      [/message]
    [/else]
    [/if]
  [/event]
#
  [event]
    name=moveto
    [filter]
      {DECOYXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [sound]
      name=ink.ogg
    [/sound]
    [terrain]
      terrain=Wwg
      x=7,8,9
      y=1,1,1
    [/terrain]
    [redraw]
    [/redraw]
    [if]
      [variable]
        name=real_chest
        equals=no
      [/variable]
    [then]
      [remove_item]
        image=items/chest.png
        {REALXY}
      [/remove_item]
      [set_variable]
        name=real_chest
        value=lost
      [/set_variable]
      [sound]
        name=mermen-die.wav
      [/sound]
    [/then]
    [/if]
    [remove_item]
      image=items/chest.png
      {DECOYXY}
    [/remove_item]
    [sound]
      name=mermen-die.wav
    [/sound]
  [/event]
#
# Real treasure at {REALXY}
  [event]
    name=moveto
    [filter]
      {REALXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [set_variable]
      name=real_chest
      value=yes
    [/set_variable]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="Locked chest.  Now take.  Later open."
        s="Chesst iss ssecurely sshut.  Will take it and sseek to open it later."
        d="Ah'll take this locked chest wi' us.  No time tae pick the lock now..."
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
    [remove_item]
      image=items/chest.png
      {REALXY}
    [/remove_item]
  [/event]


# --- Vault gate events ---

# Keys missing (so allow player to try again)
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y=14,6
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [have_location]	# Gate locked
        x,y=14,5
        terrain=Uu^Pr/
      [/have_location]
      [not]		# Missing at least one key
      [variable]
        name=vgk1
        equals=yes
      [/variable]
      [variable]
        name=vgk2
        equals=yes
      [/variable]
      [variable]
        name=vgk3
        equals=yes
      [/variable]
      [variable]
        name=vgk4
        equals=yes
      [/variable]
      [/not]
    [/filter_condition]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="Got locks gate's four.  Four we keys need."
        s="Gate'ss got four lockss.  Need four keyss..."
        d="Gate's got four locks.  We need four keys..."
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
  [/event]
#
# Using key in wrong order activates gate trap
  [event]
    name=block_gate
    [set_variables]
      name=di
      [value]
        x=14
        y=6
        i="items/anvil.png"
        r="no"
      [/value]
    [/set_variables]
    [fire_event]
      name=dropitem
    [/fire_event]
    [sound]
      name=mace.ogg
    [/sound]
    [harm_unit]
      [filter]
        x,y=14,6
      [/filter]
      animate=defender
      damage_type=impact
      amount=29
    [/harm_unit]
    [remove_shroud]
      side=1
      x,y=13,5
      radius=1
    [/remove_shroud]
    [fire_event]
      name=drop_portcullis
    [/fire_event]
    [message]
      speaker=Krag
      message= _ "Stinkshafts and scuttledseams!  A portcullis!  We cannae get through that quickly.  Flynn's expectin' us.  Give up on the gate..."
    [/message]
  [/event]
#
# Drop portcullis event (used in 2 places)
  [event]
    name=drop_portcullis
    first_time_only=no
    [scroll_to]
      x,y=13,5
    [/scroll_to]
    [sound]
      name=rumble.ogg
    [/sound]
    [item]
      x,y=13,5
      image=scenery/gate-rusty-se.png
    [/item]
    [kill]		# Any unit under portcullis is squashed
      x,y=13,5
      animate=yes
      fire_event=yes
    [/kill]
    [terrain]
      x,y=13,5
      terrain=Uu^Xo
    [/terrain]
    [remove_item]
      image=scenery/lever1.png
      {LEVERXY}
    [/remove_item]
    [item]
      image=scenery/lever2.png
      {LEVERXY}
    [/item]
    [redraw]
    [/redraw]
    [delay]
      time=1500
    [/delay]
  [/event]
#
# Portcullis open/close event
  [event]
    name=moveto
    first_time_only=no
    [filter]
      {LEVERXY}
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [if]
      [have_location]
        x,y=13,5
        terrain=Uu^Xo
      [/have_location]
    [then]
      [message]
        speaker=narrator
        image=scenery/lever2.png
        message= _ "Lever is in ""DOWN"" position.  Should $unit.name move it to the ""UP"" position?"
      [option]
        label= _ "No"
        [command]
        [/command]
      [/option]
      [option]
        label= _ "Yes"
        [command]
          [sound]
            name=rumble.ogg
          [/sound]
          [remove_item]
            x,y=13,5
            image=scenery/gate-rusty-se.png
          [/remove_item]
          [terrain]
            x,y=13,5
            terrain=Uu
          [/terrain]
          [remove_item]
            image=scenery/lever2.png
            {LEVERXY}
          [/remove_item]
          [item]
            image=scenery/lever1.png
            {LEVERXY}
          [/item]
          [if]
            [have_location]	# Also open gates if closed
              x,y=14,5
              terrain=Uu^Pr/
            [/have_location]
          [then]
            [sound]
              name=lockclick.ogg
            [/sound]
            [terrain]
              x,y=14,5
              terrain=Uu^Pr/o
            [/terrain]
          [/then]
          [/if]
          [redraw]
          [/redraw]
        [/command]
      [/option]
    [/message]
    [/then]
    [else]
      [message]
        speaker=narrator
        image=scenery/lever1.png
        message= _ "Lever is in ""UP"" position.  Should $unit.name move it to the ""DOWN"" position?"
      [option]
        label= _ "No"
        [command]
        [/command]
      [/option]
      [option]
        label= _ "Yes"
        [command]
          [if]		# Issue warning if friendly unit in harm's way
            [have_unit]
              x,y=13,5
              side=1
            [/have_unit]
          [then]
            [set_variables]
              name=rdde
              [value]
                x=13
                y=5
                o="Wait!  Move away must me!"
                s="SStop!  Firsst I musst move to ssafety!"
                d="Dinna touch that lever!  Ah need tae move tae safety!"
              [/value]
            [/set_variables]
            [fire_event]
              name=rdde
            [/fire_event]
          [/then]
          [else]
            [fire_event]
              name=drop_portcullis
            [/fire_event]
          [/else]
          [/if]
        [/command]
      [/option]
    [/message]
    [/else]
    [/if]
  [/event]
#
# Can open gate without keys from north
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x,y=13,5
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [have_location]	# Gate locked
        x,y=14,5
        terrain=Uu^Pr/
      [/have_location]
    [/filter_condition]
    [fire_event]
      name=gate_north_ftd
    [/fire_event]
    [sound]
      name=lockclick.ogg
    [/sound]
    [terrain]
      x,y=14,5
      terrain=Uu^Pr/o
    [/terrain]
  [/event]
#
  [event]		# Open gate without keys first time dialogue
    name=gate_north_ftd
    [set_variables]
      name=rdde
      [value]
        x=13
        y=5
        o="Keys need don't."
        s="No keyss needed on this sside!"
        d="Dinna need keys on this side!"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
  [/event]
#
# Have four keys (only one attempt to get this right!)
  [event]
    name=moveto
    [filter]
      x,y=14,6
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=vgk1
        equals=yes
      [/variable]
      [variable]
        name=vgk2
        equals=yes
      [/variable]
      [variable]
        name=vgk3
        equals=yes
      [/variable]
      [variable]
        name=vgk4
        equals=yes
      [/variable]
      [have_location]	# Sanity check: gate closed? (might have been opened via back door)
        x,y=14,5
        terrain=Uu^Pr/
      [/have_location]
    [/filter_condition]
    [message]
      speaker=narrator
      image=items/four-keys.png
      message= _ "You have four keys numbered ""1"", ""2"", ""3"" and ""4"".
The gate has four locks labelled ""I"",""II"",""III"","IIII".
 
Which key do you want to put into lock I?"
      [option]
        label= _ "Key 1"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Key 2"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Key 3"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Key 4"
        [command]
          [sound]
            name=lockclick.ogg
          [/sound]
        [/command]
      [/option]
    [/message]
    [message]
      speaker=narrator
      image=items/three-keys.png
      message= _ "Which key do you want to put into lock II?"
      [show_if]
        [have_location]
          x,y=13,5
          terrain=Uu
        [/have_location]
      [/show_if]
      [option]
        label= _ "Key 1"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Key 2"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Key 3"
        [command]
          [sound]
            name=lockclick.ogg
          [/sound]
        [/command]
      [/option]
    [/message]
    [message]
      speaker=narrator
      image=items/two-keys.png
      message= _ "Last two keys:"
      [show_if]
        [have_location]
          x,y=13,5
          terrain=Uu
        [/have_location]
      [/show_if]
      [option]
        label= _ "Put key 2 in lock III and key 1 in lock IIII"
        [command]
          [sound]
            name=lockclick.ogg
          [/sound]
          [terrain]
            x,y=14,5
            terrain=Uu^Pr/o
          [/terrain]
          [redraw]
          [/redraw]
        [/command]
      [/option]
      [option]
        label= _ "Put key 2 in lock IIII and key 1 in lock III"
        [command]
          [fire_event]
            name=block_gate
          [/fire_event]
        [/command]
      [/option]
    [/message]
  [/event]


# --- Back door events ---

# Requires player unit reaches (23,1)

  [event]		# First time dialogue if found by non-dwarf
    name=moveto
    [filter]
      x,y=23,1
      side=1
      [not]
        race=dwarf
      [/not]
    [/filter]
    [filter_condition]
      [have_location]	# Back of backdoor not yet revealed
        x,y=11,1
        terrain=Xu
      [/have_location]
    [/filter_condition]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="And twisty small hole.  Sided-sharp.  Like not."
        s="Thiss cralwsspace iss ssharp-ssided, ssmall and twissty.  Would sshred batss wingss and our ssaurian sskin.  Too resstricted for ogress.  Sshould ssuit dwarfss."
        d="Scenario error: this dialogue should never happen!  Please report it (id=""23,1 moveto ftd"")"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
  [/event]
#
  [event]		# Setup (dwarf only)
    name=moveto
    [filter]
      x,y=23,1
      race=dwarf
      side=1
    [/filter]
    [message]
      speaker=unit
      message= _ "This cralwspace's sharp-sided, narrow 'n' winding.  Ogres're too, er, big-boned tae fit.  Bats 'n saurians're too fragile; they'd get cut tae pieces.  Only a dwarf could safely enter.  Probably.
 
Let's see where it leads..."
    [/message]
    [terrain]
      x,y=11,1
      terrain=Uh
    [/terrain]
    [item]	# Back of backdoor
      image=scenery/cave-entrance-wall.png
      x,y=11,1
    [/item]
    [redraw]
    [/redraw]
  [/event]
#
# Back door moveto (Dwarves only)
  [event]
    name=moveto
    first_time_only=no
    [filter]
      x=11,23
      y= 1, 1
      race=dwarf
    [/filter]
    [set_variable]
      name=bd_to_x
      value=11
    [/set_variable]
    [if]
      [variable]
        name=x1
        equals=$bd_to_x
      [/variable]
    [then]
      [set_variable]
        name=bd_to_x
        value=23
      [/set_variable]
    [/then]
    [/if]
    [if]
      [have_unit]
        x,y=$bd_to_x,1    
      [/have_unit]
    [then]
      [message]
        speaker=unit
        message= _ "Ah cannae get through, the way oot's blocked!"
      [/message]
    [/then]
    [else]
      [fire_event]
        name=bds_ft
      [/fire_event]
      [teleport]
        [filter]
          x,y=$x1,1
        [/filter]
        x,y=$bd_to_x,1
      [/teleport]
      [scroll_to_unit]
        x,y=$bd_to_x,1
        highlight=yes
      [/scroll_to_unit]
    [/else]
    [/if]
    [clear_variable]
      name=bd_to_x
    [/clear_variable]
  [/event]
#
# Remove shroud first time backdoor traversed (may not be necessary)
  [event]
    name=bds_ft
    [remove_shroud]
      side=1
      x,y=11,1
      radius=1
    [/remove_shroud]
  [/event]


# --- Jail events (except jailer death) ---

# "Shortcut" between villages at (24,28) and (27,29)
  [event]
    name=moveto
    [filter]
      x=24,27
      y=28,29
      side=1
    [/filter]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="At the there's corridor back a!"
        s="There iss a corridor at the back!"
        d="There's a corridor at the back!"
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
    [terrain]
      x=25,26
      y=29,28
      terrain=Uh
    [/terrain]
  [/event]

# Jailer's village moveto garners key (also fires on capture)
  [event]
    name=moveto
    [filter]
      x,y=27,29
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [remove_item]
      image=items/key.png
      x,y=27,29
    [/remove_item]
    [set_variable]
      name=key_jail
      value=yes
    [/set_variable]
    [message]
      speaker=narrator
      image=items/key.png
      message= _ "You have the Jailer's master key.  To open a cell, move a dwarf or ogre adjacent to it."
    [/message]
  [/event]

# Open jail cells sound effect
  [event]
    name=lockclick
    first_time_only=no
    [sound]
      name=lockclick.ogg    
    [/sound]
    [delay]
      time=200
    [/delay]
  [/event]

# Open jail cells
  [event]
    name=moveto
    [filter]
      x,y=27,30
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=key_jail
        equals=yes
      [/variable]
      [have_location]
        x,y=26,30
        terrain=Uu^Pr\
      [/have_location]
    [/filter_condition]
    [fire_event]
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=26,30
      terrain=Uu^Pr\o
    [/terrain]
    [redraw]
    [/redraw]
  [/event]

  [event]
    name=moveto
    [filter]
      x,y=28,31
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=key_jail
        equals=yes
      [/variable]
      [have_location]
        x,y=27,32
        terrain=Uu^Pr\
      [/have_location]
    [/filter_condition]
    [fire_event]
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=27,32
      terrain=Uu^Pr\o
    [/terrain]
    [redraw]
    [/redraw]
  [/event]

# Prisoners dialogue (here because needs to fire before next event if both fire)
  [event]
    name=moveto
    [filter]
      x,y=29,33
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [remove_shroud]
      side=1
      x=27,31
      y=34,34
      radius=1
    [/remove_shroud]
    [message]
      speaker=Sstingz
      message= _ "Help!  Orcss came from easst.  Ssought to ensslave uss.  Wanted healerss and sskirmissherss.  Mosst esscaped but ssome sseized.  Only uss two sstill ssurvive.  Releasse me and I will sserve you!"
    [/message]
    [message]
      speaker=Ssoothz
      message= _ "Ass will I!"
    [/message]
  [/event]
#
  [event]
    name=moveto
    [filter]
      x,y=29,33
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=key_jail
        equals=yes
      [/variable]
      [have_location]
        x,y=28,33
        terrain=Uu^Pr\
      [/have_location]
    [/filter_condition]
    [fire_event]		# Open cells
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=28,33
      terrain=Uu^Pr\o
    [/terrain]
    [fire_event]
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=30,33
      terrain=Uu^Pr/o
    [/terrain]
    [redraw]
    [/redraw]
    [modify_unit]		# Release prisoners
      [filter]
        id=Ssoothz
      [/filter]
      side=1
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_LOYAL}
      [/modifications]
      {IS_LOYAL}
    [/modify_unit]
    [modify_unit]
      [filter]
        id=Sstingz
      [/filter]
      side=1
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_LOYAL}
      [/modifications]
      {IS_LOYAL}
    [/modify_unit]
  [/event]

  [event]
    name=moveto
    [filter]
      x,y=30,29
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=key_jail
        equals=yes
      [/variable]
      [have_location]
        x,y=31,30
        terrain=Uu^Pr/
      [/have_location]
    [/filter_condition]
    [fire_event]
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=31,30
      terrain=Uu^Pr/o
    [/terrain]
    [redraw]
    [/redraw]
  [/event]

  [event]
    name=moveto
    [filter]
      x,y=30,31
      side=1
      [not]
        race=bats
      [/not]
    [/filter]
    [filter_condition]
      [variable]
        name=key_jail
        equals=yes
      [/variable]
      [have_location]
        x,y=31,32
        terrain=Uu^Pr/
      [/have_location]
    [/filter_condition]
    [fire_event]
      name=lockclick
    [/fire_event]
    [terrain]
      x,y=31,32
      terrain=Uu^Pr/o
    [/terrain]
    [redraw]
    [/redraw]
  [/event]

# Empty jail cells (bats OK here)
  [event]
    first_time_only=no
    name=moveto
    [filter]
      x=25,26,32,32
      y=31,32,30,32
      side=1
    [/filter]
    [set_variables]
      name=rdde
      [value]
        x=$x1
        y=$y1
        o="Treasure no... rubbish just."
        s="Only ragss and remainss..."
        d="Nowt of value here."
      [/value]
    [/set_variables]
    [fire_event]
      name=rdde
    [/fire_event]
  [/event]


# --- Turn events ---

# Force vault guards and jailer to stay put
  [event]
    name=turn refresh
    first_time_only=no
    [modify_unit]
      [filter]
        role=vguard
        [or]
          id=Jailer
        [/or]
      [/filter]
      moves=0
    [/modify_unit]
  [/event]


# Force farmers to stay put
  [event]
    name=side 6 turn refresh
    first_time_only=no
    [modify_unit]
      [filter]		# Side 6 otherwise would affect player units!
        side=6
        [filter_terrain]
          terrain=Uu^Vu
        [/filter_terrain]
      [/filter]
      moves=0
    [/modify_unit]
  [/event]


# Turn 1 Dialogue
  [event]
    name=turn 1
    [remove_shroud]
      side=1
      x,y=12,32
      radius=1
    [/remove_shroud]
    [message]
      speaker=Southwarden
      message= _ "Hoy!  Lard-axes! So you peaheads might, just possibly, understand: <i>die here you all will!</i>"
    [/message]
  [/event]


# Start of game
  [event]
    name=start
    [if]
      [variable]	# =yes if Blok gained bat recruitment
        name=bbrecruit
        equals=yes
      [/variable]
    [then]
      [message]
        speaker=narrator
        image=misc/bat-anvil.png
        message= _ "Note: bats <i>cannot</i> pick up or carry things, <b>including</b> gold..."
      [/message]
    [/then]
    [/if]
#
    [objectives]
      side=1
      [objective]
        description= _ "Kill all Orc leaders"
        condition=win
        [show_if]
          [have_unit]	# Can finish if jail and/or vault areas not discovered
            race=orc
            canrecruit=yes
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Move any unit through the north exit into the outdoors"
        condition=win
        [show_if]
          [have_unit]	# Can finish if vault area not discovered
            race=orc
            canrecruit=yes
            count=0
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Death of Krag"
        condition=lose
      [/objective]
      [objective]
        description = _ "Death of Blok"
        condition=lose
      [/objective]
      [objective]
        description= _ "Time runs out"
        condition=lose
        show_turn_counter=yes
      [/objective]
      {CARRYOVER 80}
    [/objectives]
  [/event]


# Setup initial conditions
  [event]
    name=prestart
#
# Reinstate Krag & co, remove Flynn
  [recall]
    id=Krag
    x,y=5,33
  [/recall]
  [kill]
    id=Flynn
    animate=no
  [/kill]
  [recall]
    id=Blok
    x,y=6,33
  [/recall]
  [recall]	# Nothing happens if bat unavailable
    id=rb
    side=1
    x,y=1,34
  [/recall]
#
# Outdoor time (for appearance only)
  [store_locations]
    terrain=Ce,Gg,Ke,Hh,Mm,Rb,Re
    variable=25_outdoor_locations
  [/store_locations]
  [time_area]
    find_in=25_outdoor_locations
    {MORNING}
    {AFTERNOON}
    {DUSK}
    {FIRST_WATCH}
    {SECOND_WATCH}
    {DAWN}
  [/time_area]
#
# Setup shroud
    [remove_shroud]
      side=1
      terrain=Ce,Ke,Hh,Mm,Re
      x=0-9
      y=31-35
      radius=1
    [/remove_shroud]
#
# Starting villages
    [capture_village]
      side=2
      terrain=Uu^Vo
    [/capture_village]
#    [capture_village]
#      side=3
#      terrain=Uh^Vo
#    [/capture_village]
    [capture_village]
      side=4
      terrain=Co^Vo
    [/capture_village]
    [capture_village]
      side=5
      terrain=Ur^Vo
    [/capture_village]
#    [capture_village]
#      side=6
#      terrain=Uu^Vu
#    [/capture_village]
#    [capture_village]
#      side=5		# Keys 1,2 and 3 (key 4 in hidden side 4 stash)
#      x= 1, 3,12
#      y=12,10, 6
#    [/capture_village]
    [capture_village]
      side=4
      x,y=27,29		# Jailer
    [/capture_village]
#
# Vault guards
    [set_variables]
      name=vguard
      [value]
        x=3
        y=10
        r="Orcish Slayer"
      [/value]
    [/set_variables]
    [fire_event]
      name=vguard
    [/fire_event]
#
    [set_variables]
      name=vguard
      [value]
        x=2
        y=6
        r="Orcish Grunt"
      [/value]
    [/set_variables]
    [fire_event]
      name=vguard
    [/fire_event]
#
    [set_variables]
      name=vguard
      [value]
        x=4
        y=6
        r="Orcish Assassin"
      [/value]
    [/set_variables]
    [fire_event]
      name=vguard
    [/fire_event]
#
    [set_variables]
      name=vguard
      [value]
        x=7
        y=9
        r="Orcish Crossbowman"
      [/value]
    [/set_variables]
    [fire_event]
      name=vguard
    [/fire_event]
#
    [set_variables]
      name=vguard
      [value]
        x=9
        y=9
        r="Orcish Warrior"
      [/value]
    [/set_variables]
    [fire_event]
      name=vguard
    [/fire_event]
#
    [unit]		# Side 5, has key 1
      side=5
      x,y=12,6
      type=Orcish Slayer
#ifdef HARD
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=no
#endif
#ifdef NORMAL
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
      random_traits=yes
#endif
#ifdef EASY
      random_traits=yes
#endif
      generate_name=yes
      random_gender=yes
      role=vguard
      upkeep=free
    [/unit]
#
    [unit]		# Always {STRONG}
      side=3
      x,y=13,8
      type=Orcish Warrior
#ifdef HARD
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=no
#else
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
      random_traits=yes
#endif
      generate_name=yes
      random_gender=yes
      role=vguard
      upkeep=free
    [/unit]
#
    [unit]
      side=5
      x,y=1,12
      type=Orcish Slayer
#ifdef HARD
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
#endif
#ifdef EASY
      [modifications]
        {TRAIT_QUICK}
      [/modifications]
#endif
      random_traits=yes
      generate_name=yes
      random_gender=yes
      role=vguard
      upkeep=free
    [/unit]
#
# Vault area - fake/decoy treasure chests
    [item]		# Falling rock trap
      image=items/chest.png
      {ROCKXY}
    [/item]
    [item]		# Bridge trap
      image=items/chest.png
      {BRIDGEXY}
    [/item]
    [item]		# Fire trap
      image=items/chest.png
      {FIREXY}
    [/item]
    [item]		# Decoy chest
      image=items/chest.png
      {DECOYXY}
    [/item]
#
# Open gate and raise portcullis lever
    [item]
      image=scenery/lever1.png
      {LEVERXY}
    [/item]
#
# Vault area - real treasure chest
    [item]
      image=items/chest.png
      {REALXY}
    [/item]
#
# Create goblin farmer in each goblin village
    [store_locations]
      terrain=Uu^Vu
      variable=25_goblin_villages
    [/store_locations]
    [for]
      array=25_goblin_villages
      variable=i
      [do]
        [set_variable]	# Trait
          name=gfarmer_trait
          rand=0,0,0,1	# If =1 then Weak-willed 60
        [/set_variable]
        [if]
          [variable]
            name=gfarmer_trait
            equals=1
          [/variable]
        [then]
          [unit]
            side=6
            x,y=$25_goblin_villages[$i].x,$25_goblin_villages[$i].y
            type=Goblin_Spearling
            random_traits=no
            [modifications]
              {TRAIT_WEAKWILLED 60}
            [/modifications]
            generate_name=yes
            random_gender=yes
            role=yettohint
          [/unit]
        [/then]
        [else]
          [unit]
            side=6
            x,y=$25_goblin_villages[$i].x,$25_goblin_villages[$i].y
            type=Goblin_Spearling
            random_traits=yes
            generate_name=yes
            random_gender=yes
            role=yettohint
          [/unit]
        [/else]
        [/if]
        [clear_variable]
          name=gfarmer_trait
        [/clear_variable]
      [/do]
    [/for]
#
# Array of 9 hints (the Goblins don't know about the back door)
# Need to use every available hinting Goblin to get them all
    [set_variables]
      name=gf_hints
      [value]
        h="All bosses have gold stash."
      [/value]
      [value]
        h="Big Orc treasure north west.  Much guards and traps."
      [/value]
      [value]
        h="Bridge is trap."
      [/value]
      [value]
        h="Rubble cave is trap."
      [/value]
      [value]
        h="Lit cave is trap."
      [/value]
      [value]
        h="Big Orc treasure on less good wood floor."
      [/value]
      [value]
        h="Big Orc treasure near water."
      [/value]
      [value]
        h="Big Orc treasure gate need four keys."
      [/value]
      [value]
        h="Big Orc treasure gate keys work backwards."
      [/value]
    [/set_variables]
    [modify_unit]	# Goblin leader also offers hint
      [filter]
        canrecruit=yes
        side=6
      [/filter]
      role=yettohint
    [/modify_unit]
#
# Flag if Goblins attacked (changes behaviour)
    [set_variable]
      name=gattacked_flag
      value=no
    [/set_variable]
#
# Sides 3,4,5 on/off switches
    [set_variable]
      name=side3_flag
      value=no
    [/set_variable]
#
    [set_variable]
      name=side4_flag
      value=no
    [/set_variable]
#
    [set_variable]
      name=side5_flag
      value=no
    [/set_variable]
#
# Vault gate key flags
    [set_variable]
      name=vgk1
      value=no
    [/set_variable]
    [set_variable]
      name=vgk2
      value=no
    [/set_variable]
    [set_variable]
      name=vgk3
      value=no
    [/set_variable]
    [set_variable]
      name=vgk4
      value=no
    [/set_variable]
#
# Real treasure obtained (or lost) flag
    [set_variable]
      name=real_chest
      value=no
    [/set_variable]
#
# Setup dummies
    [store_locations]
      terrain=Co^Qov
      variable=25_dummy_locations
    [/store_locations]
    [for]
      array=25_dummy_locations
      variable=i
      [do]
        [item]
          image=items/dummy.png
          x,y=$25_dummy_locations[$i].x,$25_dummy_locations[$i].y
        [/item]
      [/do]
    [/for]
    [clear_variable]
      name=25_dummy_locations
    [/clear_variable]
#
# Jailer's key to the cells
    [set_variable]
      name=key_jail
      value=no
    [/set_variable]
#
# Jail decoration
    [item]
      image=items/bonesh.png
      x,y=25,31
    [/item]
    [item]
      image=items/bones2.png
      x,y=32,30
    [/item]
    [item]
      image=items/bones3h.png
      x,y=26,32
    [/item]
    [item]
      image=items/bones.png
      x,y=32,32
    [/item]
#
# Front of backdoor
    [item]
      image=scenery/cave-entrance-wall.png
      x,y=23,1
    [/item]
#
# Label north path
    [label]
      x,y=31,3
      color=255,255,0
      text= _ "North Exit"
    [/label]
  [/event]


# --- Death events ---

{AEI_KRAG_DEATH}
{AEI_BLOK_DEATH}

# Slayer at 12,6 (side 5) drops key 1
  [event]
    name=die
    [filter]
      x,y=12,6
    [/filter]
    [item]
      image=items/key-1.png
      x,y=$x1,$y1
    [/item]
  [/event]
#
# Slayer at 3,10 drops key 3
  [event]
    name=die
    [filter]
      x,y=3,10
    [/filter]
    [item]
      image=items/key-3.png
      x,y=$x1,$y1
    [/item]
  [/event]

# Jailer death drops key
  [event]
    name=die
    [filter]
      id=Jailer
    [/filter]
    [item]
      image=items/key.png
      x,y=27,29
    [/item]
  [/event]

# Leader deaths reveal stash areas
# Side 2 stash area create
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=2
    [/filter]
    [terrain]
      x=12,13
      y=33,34
      terrain=Uu
    [/terrain]
    [terrain]
      x,y=14,34
      terrain=Uh
    [/terrain]
    [redraw]
    [/redraw]
    [item]		# Not at end of tunnel
      image=items/gold-coins-small.png
      x,y=13,34
    [/item]
# Do not remove shroud, player must move unit to see this
#    [remove_shroud]
#      side=1
#      x,y=12,33
#    [/remove_shroud]
  [/event]
#
# Side 3 stash area create
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=3
    [/filter]
    [terrain]
      x= 4, 5
      y=12,12
      terrain=Uu
    [/terrain]
    [terrain]
      x,y=6,12
      terrain=Uh
    [/terrain]
    [redraw]
    [/redraw]
    [item]
      image=items/gold-coins-small.png
      x,y=6,12
    [/item]
# Do not remove shroud, player must move unit to see this
#    [remove_shroud]
#      side=1
#      x,y=4,12
#    [/remove_shroud]
  [/event]
#
# Side 4 stash area create (decoy)
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=4
    [/filter]
    [terrain]
      x=31,31
      y=26,27
      terrain=Uu
    [/terrain]
    [terrain]
      x,y=32,26
      terrain=Uh
    [/terrain]
    [redraw]
    [/redraw]
    [item]
      image=items/gold-coins-small.png
      x,y=32,26
    [/item]
# Do not remove shroud, player must move unit to see this
#    [remove_shroud]
#      side=1
#      x,y=31,26
#    [/remove_shroud]
  [/event]
#
# Side 5 stash area create
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=5
    [/filter]
    [terrain]
      x=27,28
      y= 3, 3
      terrain=Uu
    [/terrain]
    [terrain]
      x=25,26		# 25,3 leads to (and activates) back door
      y= 3, 2
      terrain=Uh
    [/terrain]
    [redraw]
    [/redraw]
    [item]
      image=items/gold-coins-medium.png
      x,y=26,2
    [/item]
# Do not remove shroud, player must move unit to see this
#    [remove_shroud]
#      side=1
#      x,y=28,3
#    [/remove_shroud]
  [/event]
#
# Side 6 stash area create
  [event]
    name=die
    [filter]
      canrecruit=yes
      side=6
    [/filter]
    [terrain]
      x=12,12
      y=25,26
      terrain=Uu
    [/terrain]
    [terrain]
      x,y=12,27
      terrain=Uh
    [/terrain]
    [redraw]
    [/redraw]
    [item]
      image=items/gold-coins-small.png
      x,y=12,27
    [/item]
# Do not remove shroud, player must move unit to see this
#    [remove_shroud]
#      side=1
#      x,y=12,25
#    [/remove_shroud]
  [/event]


# Defeat due to time out
  [event]
    name=time over
    [message]
      speaker=Krag
      message= _ "Ach, we're too slow!  We cannae meet up wi' Flynn in time..."
    [/message]
    [endlevel]
      result=defeat
    [/endlevel]
  [/event]


# Victory: all Orcs dead and a unit has left via the north exit
# Can finish if vault area not discovered
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
        y=1-3
        terrain=Gg,Hh,Rb
      [/filter_location]
    [/filter]
    [filter_condition]
      [have_unit]	
        race=orc
        canrecruit=yes
        count=0
      [/have_unit]
    [/filter_condition]
    [message]
      speaker=Krag
      message= _ "Flynn's waitin'.  We need tae push on north at best speed!"
    [/message]
#
# Do not clear $real_chest as it indicates whether or not the dwarves are due a large gold bonus
#
    [clear_variable]
      name=25_outdoor_locations, 25_goblin_villages
    [/clear_variable]
    [clear_variable]
      name=gf_hints, p_hints
    [/clear_variable]
    [clear_variable]
      name=vgk1, vgk2, vgk3, vgk4, key_jail
    [/clear_variable]
    [clear_variable]
      name=side3_flag, side4_flag, side5_flag, gattacked_flag
    [/clear_variable]
#
# === Not in play ===
#    {AEI_PICKDROP_TEST_IF_UNAVAILABLE ring_02b}
#    {AEI_PICKDROP_TEST_IF_UNAVAILABLE amulet_03}
#
    {UNSTORE_FLYNN_TO_RECALL}
    {ENDLEVEL 80}
  [/event]
[/scenario]

#undef ROCKXY
#undef BRIDGEXY
#undef FIREXY
#undef DECOYXY
#undef REALXY
#undef LEVERXY
#undef SIDE3START
#undef SIDE4START
#undef SIDE5START
#undef SIDE_SIGHTED
#undef SIGHTED_FILTER SIDE
#undef SIGHTED_REMOVE_SHROUD
