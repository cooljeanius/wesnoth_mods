#textdomain wesnoth-AfterEI

# Ensure no ai crosses the ford to capture villages (=defeat if player does this)
#define 15BAVOIDXY
        x= 1-24
        y=17-25
#enddef
#define 15BAVOID
    [ai]
      [avoid]
{15BAVOIDXY}
      [/avoid]
    [/ai]
#enddef

[scenario]
  id=15b_Aitsward_North_Gate
  name=_"Aitsward North Gate"
  next_scenario=15b2_Aitsward_Civil_War
  map_data="{~add-ons/AfterEI/maps/15b_Aitsward_North_Gate.map}"
  {TURNS 34 32 30}
  victory_when_enemies_defeated=no

  {SCENARIO_MUSIC exploration.ogg}


# --- Very late spring ---
  {AFTERNOON}
  {DUSK}
  {FIRST_WATCH}
  {SECOND_WATCH}
  {DAWN}
  {MORNING}


# Our heroes
  [side]
{FLYNN}
{SIDE_PART_TWO Jackery}
    gold=100				# Or +100% carryover
    shroud=yes
    shroud_data="|0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0
|1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,1,1,1,1
|1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1
|0,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,1,1,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
|0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0"
  [/side]

  [side]
    side=2
    controller=null
    color=green
    team_name=Heroes
    user_team_name= _ "Peasants"
    hidden=yes
    gold=0				# No recruitment by ai
  [/side]

  [side]
    side=3
    controller=null
    team_name=militia
    user_team_name= _ "Escort"
    color=red
    {FLAG_VARIANT loyalist}
    {15BAVOID}
    gold=0
    hidden=yes
  [/side]

# Does nothing
  [side]
    side=4
    team_name=militia			
    user_team_name= _ "Militia"
    id=Wudhed				# Wudhed's recruits are not the best
    type=Spearman_i
    name= _ "Wudhed"
    unrenamable=yes
    profile=portraits/transparent/Wudhed.png
    ai_algorithm=idle_ai		# Wudhed does nothing
    canrecruit=yes
    recruit=Bowman_i, Spearman_i
    [modifications]
      {TRAIT_DIM}
      {TRAIT_STRONG}
      [object]
        duration=forever
        [effect]			# Apply irregular penalty (Wudhed is less useless than most irregulars)
          apply_to=attack
          [set_specials]
            mode=append
            {AEIWS_IRREGULAR 0.95}
          [/set_specials]
        [/effect]
      [/object]
    [/modifications]
    experience=58
    controller=ai
    color=lightred
    {FLAG_VARIANT loyalist}
    gold=0
    income=-5
    hidden=yes
  [/side]

  [side]				# Rat leader on keep overlay at 29,2 (also hole.png)
    side=5
    team_name=rats
    user_team_name= _ "Rats"
    controller=null
    color=brown
    gold=0
    hidden=yes
    {15BAVOID}
  [/side]

  [side]				# Used so caravan will be attacked by side 2 once sighted
    side=6
    team_name=Caravan
    user_team_name= _ "Caravan"
    controller=null
    color=lightred
    {FLAG_VARIANT loyalist}
    gold=0
    income=-2
    hidden=yes
  [/side]


# Move to rat hole (once rat leader defeated)
  [event]
    name=moveto
    [filter]
      side=1
      x,y=29,2
    [/filter]
    [message]
      speaker=unit
      message= _ "This hole's far too small for humans.  Yeuck!  Rat droppings!  It <i>stinks</i> down there!  I'll block it up..."
    [/message]
    [remove_item]
      x,y=29,2
      image=scenery/hole.png
    [/remove_item]
    [item]
      x,y=29,2
      image=scenery/rubble.png
    [/item]
    [redraw]
    [/redraw]
  [/event]


# Victory event
  [event]
    name=15b_victory
    [clear_variable]
      name=Peasants_sighted, Caravan_Commander_sighted, Caravan_static_sighted
    [/clear_variable]
    [set_variable]
      name=15b_palive
      value=" "
    [/set_variable]
    [if]
      [have_unit]
        role=new_15b
        side=1
      [/have_unit]
    [then]
      [set_variable]
        name=15b_palive
        value=" and peasants"
      [/set_variable]
    [/then]
    [/if]
    [message]
      speaker=narrator
      image=wesnoth-icon.png
      message= _ "Eagerly the outlaws$15b_palive ransacked the caravan.
Dolefully they surveyed their loot: supplies, equipment and papers.
 
Happily, their spirits again soared when hidden under a pile of blankets was revealed a sturdy metal chest of enticing heaviness that emitted a muffled jingling when jostled.
Sadly it was locked and resisted all attempts at opening by brute force, lockpick or unmaking."
    [/message]
    [clear_variable]
      name=15b_palive
    [/clear_variable]
    [message]
      speaker=Jackery
       message= _ "Friends!  While you've been, uh, appraising our spoils of war, I have perused the papers we discovered.
In brief, this caravan holds the Earl's gold reserves, hidden here as a precaution whilst ""the mages and rebels"" - our comrades - ""were dealt with"".  Intentionally, no key accompanied it here."
    [/message]
    [message]
      role=new_15b
      message= _ "Well, let's hope a way to open that chest can be found.  We could all use the gold!  At least until then, we'll stick around."
    [/message]
    [message]
      speaker=Nippa
      message= _ "Sooner or later more of the Earl's goons'll come for this gold.  Hangin' around here ain't healthy.
But unless we open that dwarfbutt of a chest we're no better off.  We should leg it!"
    [/message]
    [message]
      speaker=Jackery
      message= _ "Hmmm... not so fast.  If we have this gold, the Earl hasn't.  How will he maintain his armies?
The militia and outlaws are neither loyal nor trusty.  If not paid they will likely rebel, or at least desert.  Perhaps some veterans will do likewise?
Moreover we have seen no love lost between veterans, militia and outlaws.  Mayhap lack of pay, mutual loathing and the inevitable rumour of betrayal will set them at each other's throats?
 
So, we need to move this Caravan and await our opportunity.  Pray our friends remain unharmed!  I propose we return to the South Gate.  There, if anywhere, will we meet with any forces the Crown despatches."
    [/message]
    [message]
      speaker=Nippa
      message= _ "If they're ever sent.  I wouldn't lay all your hopes on Weldyn.  They're far away and have many worries much nearer home.
Also I wouldn't hang around here too long, there'll be  price on our heads now " + {ASIDE _"if there ain't already..."}
    [/message]
    [set_extra_recruit]		# Restore Jackery recruitment
      id=Jackery
      extra_recruit=Fencer, Sergeant, Bowman, Spearman
    [/set_extra_recruit]
    [store_unit]
      variable=Jackery_Nippa
      [filter]			# Save Nippa
        id=Nippa
        side=1
      [/filter]
      kill=yes
    [/store_unit]
    [store_unit]
      variable=Jackery_Caravan
      [filter]			# Save Caravan_static
        id=Caravan_static
        side=1
      [/filter]
      kill=yes
    [/store_unit]
    [store_unit]		# Everyone else
      variable=Jackery_army
      [filter]
        side=1
        canrecruit=no
        [not]
          x,y=recall,recall
        [/not]
      [/filter]
      kill=yes
    [/store_unit]
    [remove_shroud]		# Reveal full map to player
      side=1
      x=0-31
      y=0-26
    [/remove_shroud]
    {AEI_PICKDROP_TEST_IF_UNAVAILABLE ring_11}
    {UNSTORE_FLYNN_TO_RECALL}
    {ENDLEVEL 100}
  [/event]


#ifdef HARD
[event]				# Make Javelineer stay put until Caravan sighted
  name=side 3 turn refresh
  first_time_only=no
  [if]
    [variable]
      name=Caravan_static_sighted
      equals=no
    [/variable]
  [then]
    [modify_unit]
      [filter]
        x,y=30,20
      [/filter]
      moves=0
    [/modify_unit]
  [/then]
  [/if]
[/event]
#endif


# Player sights infantryman and rat
  [event]
    name=sighted,moveto
    [filter]
      id=hi_nv,cr_nv
      side=3,5
      [filter_vision]
        side=1
      [/filter_vision]
    [/filter]
    [unit]				# Just to keep things interesting
      side=5
      id=cr_nv
      type=corneredrat
      x,y=25,8
      generate_name=yes
      random_traits=yes
      upkeep=free
    [/unit]
    [move_unit]
      id=cr_nv
      to_x,to_y=19,5
    [/move_unit]
  [/event]


# Activate sides 3 (caravan) and 5 (rats) when any side 1 unit crosses northenmost ford
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
        x=12-30
      [/filter_location]
    [/filter]
    [modify_side]			# No outlaw recruitment until sighted by player
      side=3
      controller=ai
      [ai]
        passive_leader=yes
      [/ai]
      {GOLD 75 100 125}
      recruit=Bowman, Fencer, Heavy Infantryman, Spearman
    [/modify_side]
    [unit]
      id=Caravan_Commander
      type=Duelist
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
      [/modifications]
      side=3
      x,y=29,15
      canrecruit=yes
      random_traits=no
      random_gender=yes
      experience=63
      animate=yes
    [/unit]
    [capture_village]
      side=3
      terrain="*^Vdt"
    [/capture_village]
    [modify_side]
      side=5
      controller=ai
      [ai]
        passive_leader=yes
      [/ai]
      {GOLD 80 90 100}			# Also begins with a fully loaded keep
      {INCOME 30 33 36}
      recruit=corneredrat, hugerat
    [/modify_side]
    [unit]
      id=Bossrat
      type=hugerat
      [modifications]
        {TRAIT_STRONG}
        {TRAIT_RESILIENT}
      [/modifications]
      side=5
      x,y=29,2
      canrecruit=yes
      random_traits=no
      random_gender=yes
      experience={ON_DIFFICULTY 21 24 27} # out of 30
      animate=yes
    [/unit]
    [unit]
      side=5
      type=corneredrat
      x,y=29,3
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=5
      type=hugerat
      x,y=28,2
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=5
      type=hugerat
      x,y=30,2
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=5
      type=corneredrat
      x,y=28,1
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=5
      type=corneredrat
      x,y=30,1
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=5
      type=hugerat
      x,y=29,1
      generate_name=yes
      random_traits=yes
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
  [/event]


# Events to create two peasantry units (called from more than one place)
  [event]		# Create peasant follower (pf)
    name=create_pf
    [unit]
      type=AEI_Peasant
      side=1
      x,y=4,4
      role=new_15b
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
      generate_name=yes
      random_traits=yes
      random_gender=yes
      animate=yes
      experience=$pf_xp
    [/unit]
    [clear_variable]
      name=pf_xp
    [/clear_variable]
  [/event]
  [event]
    name=create_loyaly
    [unit]
      id=loyaly_15b
      type=Yeoman
      role=new_15b
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_LOYAL}
      [/modifications]
      {IS_LOYAL}
      side=1
      x,y=1,5
      generate_name=yes
      random_traits=yes
      random_gender=yes
      experience=$loyaly_15b_xp
      animate=yes
    [/unit]
    [clear_variable]
      name=loyaly_15b_xp
    [/clear_variable]
  [/event]


# First time player sights any side 2 unit
  [event]
    name=sighted,moveto
    [filter]
      side=2
      [filter_vision]
        side=1
      [/filter_vision]
    [/filter]
    {REPLACE_SCENARIO_MUSIC battlecry.ogg}
    {APPEND_MUSIC figght_amp.ogg}
    {APPEND_MUSIC moleman.ogg}
    [remove_shroud]
      [filter]
        id=Plebian
        side=2
      [/filter]
      radius=2
    [/remove_shroud]
    [message]
      speaker=Plebian
      message= _ "Beware!  Thieves and bandits to the south!  Whether they be Earl's men or not, we are discovered!  Pitchforks out!"
    [/message]
    [message]
      speaker=Jackery
      message= _ "Peace, friends.  My name is Jackery.  I command honest<small><i>(-ish)</i></small> folk who do not serve the aberrant Earl Flynn.
We are surveying the terrain around Aitsward.  Once we report to the Crown, Earl Flynn will be removed.  May we pass in peace?"
    [/message]
    [message]
      speaker=Plebian
      message= _ "Such fine talk.  Flynn-the-false also spoke fancy - and fooled us, for awhile.
Now we live here, hidden from his gaze, scratching a living in the forest.  Prove yourself!"
    [/message]
    [message]
      speaker=Nippa
      message= _ "You still breathe and we ain't taken your stuff!  " + {WHISPER _"Not that there's owt here worth having... "}
    [/message]
    [message]
      speaker=Plebian
      message= _ "Ah...  Fair point.  Well, we mustn't delay you.  Best way back is the way you came.  Bye-bye!"
    [/message]
    [message]
      speaker=Jackery
      message= _ "Very well, we shall leave you in peace.  Farewell!"
    [/message]
    [move_unit]
      id=Jackery
      to_x,to_y=1,18
    [/move_unit]
    [move_unit]
      id=Nippa
      to_x,to_y=1,17
    [/move_unit]
    [message]
      speaker=Plebian
      message= _ "Wait!  You've passed my little test.  You speak and act truly.  You do indeed seem to be honest folk " + {ASIDE _"despite appearances... "} + "
 
Around this time of year a stretch of land east of here dries out, opening up places normally blocked off.  Going there to hunt and forage, we heard a right racket ahead: Flynn-the-false's troops were clearing a path for a caravan.  But where they were going didn't lead anywhere?  I guess the Crown'd like to know what's going on?  We would."
    [/message]
    [message]
      speaker=Jackery
      message= _ "Intruiging... very well.  Do you know where this caravan is now?  Is it still with escort?  If so, do you know the strength and disposition of the defenders?  Did you notice if-"
    [/message]
    [label]
      x,y=11,1
      color=255,255,0
      text= _ "Summer Shallows"
    [/label]
    [label]
      x,y=24,16
      color=255,255,0
      text= _ "Northgate ford"
    [/label]
    [label]
      x,y=18,21
      color=255,255,0
      text= _ "North Gate"
    [/label]
    [message]
      speaker=Plebian
      message= _ "Hang on, we didn't take notes!  Let's see... they were heading south, towards the dead end... a goodly number... all footsoldiers.  No horses except for the caravan.  Too strong for us alone, but together I reckon we've a chance.
 
To get there it's north, across the Summer Shallows, then south until we find the caravan (if it's still there) or the land runs out.  We'll pass east of Northgate ford.  Don't cross it!  It only leads back to Aitsward's north gate.  If we're seen the militia will raise the alarm - we're not allowed out on our own these days...
 
We want to start over well away from here.  So if we happen across any gold or valuables, we'd want an equal share to buy land, livestock and so forth.  Do we have a deal?"
    [/message]
    [remove_shroud]
      side=1
      x=0-13
      y=0-16
    [/remove_shroud]
    [remove_shroud]
      side=1
      x,y=14,14				# There's always one...
    [/remove_shroud]
    [move_unit]
      id=Jackery
      to_x,to_y=4,8
    [/move_unit]
    [move_unit]
      id=Nippa
      to_x,to_y=2,8
    [/move_unit]
    [foreach]
      array=Jackery_army
      [do]
        [unstore_unit]
          variable=Jackery_army[$i]
          find_vacant=yes
          x,y=4,8
        [/unstore_unit]
        [heal_unit]
          [filter]
            id=$Jackery_army[$i].id
            side=1
          [/filter]
          moves=full
          restore_attacks=yes
        [/heal_unit]
      [/do]
    [/foreach]
    [clear_variable]
      name=Jackery_army
    [/clear_variable]
    [store_unit]			# Transfer Plebian's Peasants to Jackery
      variable=AEI_Plebian_army
      [filter]
        side=2
      [/filter]
    [/store_unit]
    [foreach]
      array=AEI_Plebian_army
      [do]
        [set_variable]
          name=this_item.side
          value=1
        [/set_variable]
        [unstore_unit]
          variable=this_item
          find_vacant=no
        [/unstore_unit]
        [scroll_to_unit]
          id=$this_item.id
        [/scroll_to_unit]
        [floating_text]
          x,y=$this_item.x,$this_item.y
          text= _ "<span color='blue'>Side 1</span>"
        [/floating_text]
        [delay]
          time=500
        [/delay]
      [/do]
    [/foreach]
    [clear_variable]
      name=AEI_Plebian_army
    [/clear_variable]
    [capture_village]
      side=1
      terrain="*^Vl"
      y=4-11
    [/capture_village]
    [message]
      speaker=Jackery
      message= _ "Agreed.  We are allies."
      [option]
        label= _ "OK, lead on."
        [command]		# Create strong peasant (no dialogue)
          [set_variable]
            name=pf_xp
            value=0
          [/set_variable]
          [fire_event]
            name=create_pf
          [/fire_event]
        [/command]
      [/option]
      [option]
        label= _ "Here's 30 gold in advance, as proof of our good faith."
        [command]		# Get two units, one of which is loyal
          [gold]
            side=1
            amount=-30
          [/gold]
          [set_variable]
            name=pf_xp
            value=7
          [/set_variable]
          [fire_event]
            name=create_pf
          [/fire_event]
          [set_variable]
            name=loyaly_15b_xp
            value=9
          [/set_variable]
          [fire_event]
            name=create_loyaly
          [/fire_event]
          [message]
            speaker=loyaly_15b
            image_pos=right
            mirror=yes
            message= _ "I'm tired of hidin' and runnin' away.  I'm with you, Jack'ry sir!"
          [/message]
        [/command]
      [/option]
      [option]
        label= _ "Here's 50 gold in advance, as proof of our good faith."
        [command]		# Get two better units, one of which is loyal plus option for loyal apprentice mage
          [gold]
            side=1
            amount=-50
          [/gold]
          [unit]
            type=AEI_Peasant
            role=new_15b
            [modifications]
              {TRAIT_STRONG}
              {TRAIT_QUICK}
            [/modifications]
            side=1
            x,y=4,4
            generate_name=yes
            random_traits=no
            random_gender=yes
            experience=14
            animate=yes
          [/unit]
          [set_variable]
            name=loyaly_15b_xp
            value=17
          [/set_variable]
          [fire_event]
            name=create_loyaly
          [/fire_event]
          [message]
            speaker=loyaly_15b
            image_pos=right
            mirror=yes
            message= _ "I'm tired of hidin' and runnin' away.  I'm with you, Jack'ry sir!
 
My cousin Sarah was visitin' when we went into hidin'.  She's been stuck here with us since then.  If it's OK she'd like to tag along - but we'll need another 15 gold."
          [/message]
          [message]
            speaker=Jackery
            message= _ "This lot are high maintenance!"
            [option]
              label= _ "No, I can't afford to pay any more."
              [command]		# Continue with current troops
              [/command]
            [/option]
            [option]
              label= _ "OK, here's <i>another</i> 15 gold."
              [command]		# Create Sarahbhrahl
                [gold]
                  side=1
                  amount=-15
                [/gold]
                [unit]
                  id=Sarahbhrahl
                  name=_"Sarahbhrahl"
                  type=App_Mage
                  unrenamable=yes
                  [modifications]
                    {TRAIT_QUICK}
                    {TRAIT_LOYAL}
                  [/modifications]
                  {IS_LOYAL}
                  side=1
                  x,y=2,5
                  generate_name=yes
                  random_traits=yes
                  gender=female
                  experience=19
                  animate=yes
                [/unit]
                [message]
                  speaker=Sarahbhrahl
                  image_pos=right
                  mirror=yes
                  message= _ "At your service, sire."
                [/message]
              [/command]
            [/option]
          [/message]
        [/command]
      [/option]
      [option]
        label= _ "Here's $gold_option_toomuch gold in advance, as proof of our good faith."
        [command]		# Continue with current troops
          [message]
            speaker=Nippa
            message= _ "<b><i>What?</i></b>  " + {WHISPER _"These soil-stirrers ain't got two coppers to rub together!  $gold_option_toomuch is waaay too much, trust me!"}
          [/message]
          [message]
            speaker=Jackery
            message= _ "To pay or not to pay, that is the question..."
            [option]
              label= _ "Nippa's right.  I got carried away.  Lead on, Plebian!"
              [command]		# Continue with current troops
                [message]
                  speaker=Plebian
                  message= _ "-sigh- ... $gold_option_toomuch gold... would've set us up for life..."
                [/message]
              [/command]
            [/option]
            [option]
              label= _ "No, a generous payment will guarantee their loyalty.  Here, Plebian, take it..."
              [command]		# Continue with just outlaws (and greatly reduced gold)
                [gold]
                  side=1
                  amount=-$gold_option_toomuch
                [/gold]
                [message]
                  speaker=Plebian
                  message= _ "<big><big>Yippee!</big></big>"
                [/message]
                [kill]
                  side=1
                  type=AEI_Peasant,Yeoman
                  animate=no
                  fire_event=no
                [/kill]
                [message]
                  speaker=Jackery
                  message= _ "... Plebian?"
                [/message]
                [message]
                  speaker=Nippa
                  message= _ "Told you."
                [/message]
              [/command]
            [/option]
          [/message]
        [/command]
      [/option]
    [/message]
    [clear_variable]
      name=gold_option_toomuch
    [/clear_variable]
    [set_variable]
      name=Peasants_sighted
      value=yes
    [/set_variable]
    [heal_unit]
      [filter]
        id=Jackery, Nippa
        side=1
      [/filter]
      moves=full
    [/heal_unit]
    [show_objectives]
      side=1
    [/show_objectives]
  [/event]


# Player sights leader of Caravan defenders
  [event]
    name=sighted,moveto
    [filter]
      canrecruit=yes
      side=3
      [filter_vision]
        side=1
      [/filter_vision]
    [/filter]
    [modify_side]
      side=3
      [ai]
        passive_leader=no		# Leader now not passive
      [/ai]
    [/modify_side]
    [allow_extra_recruit]
      id=Caravan_Commander
#ifdef EASY
      extra_recruit=Thief
#else
      extra_recruit=Poacher, Thief
#endif
    [/allow_extra_recruit]
    [remove_shroud]
      side=1
      x,y=29,15
      radius=2
    [/remove_shroud]
    [message]
      speaker=Caravan_Commander
      message= _ "Trespassers!  Surely you know the Earl forbade citizens access hereabouts?  Flouting his command is terminally unwise.  Muster the scumba-, uh, reserves..."
    [/message]
    [gold]
      side=3
      amount={ON_DIFFICULTY 70 100 130}
    [/gold]
    [message]
      speaker=Nippa
      message= _ "They'll kill us unless we get'em first!  Besides, if any get back to Aitsward they'll send more goons..."
    [/message]
    [message]
      role=new_15b
      message= _ "The caravan's most likely south of yon keep.  Prob'ly best to clear up here 'fore going after it..."
    [/message]
    [set_variable]
      name=Caravan_Commander_sighted
      value=yes
    [/set_variable]
    [show_objectives]
      side=1
    [/show_objectives]
  [/event]


# Short bit of dialogue between side 3 units first time an outlaw is recruited
  [event]
    name=recruit
    [filter]
      type=Poacher, Thief
      side=3
    [/filter]
    [message]
      speaker=second_unit
      message= _ "I've never trusted your sort.  I'm watching you.  Step out of line and I'll happily execute you!"
    [/message]
    [message]
      speaker=unit
      message= _ "Pff!  You 'av yer orders.  We 'av a deal.  We're a team, like it or not.  "+{ASIDE _"Though that caravan's cargo is temptin'... "}
    [/message]
  [/event]


# "Un guardian" a couple of units first time a player unit moves onto side 2's keep or castle hexes
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
        terrain=Ce,Ke
      [/filter_location]
    [/filter]
    [modify_unit]
      [filter]
        x=30,29
        y=18,19
      [/filter]
      [status]
        guardian=no
      [/status]
    [/modify_unit]
  [/event]


# Player sights Caravan
  [event]
    name=sighted,moveto
    [filter]
      id=Caravan_static
      side=3
      [filter_vision]
        side=1
      [/filter_vision]
    [/filter]
    [if]
      [have_unit]
        x,y=29,25
      [/have_unit]
    [then]
      [move_unit]
        x,y=29,25
        to_x,to_y=28,24
      [/move_unit]
      [message]
        x,y=28,24
        message= _ "-Oof- ... who shoved me aside?"
      [/message]
    [/then]
    [/if]
    [modify_unit]
      [filter]
        id=Caravan_static
      [/filter]
      side=6			# Ensures Caravan Driver (side 3) will attack caravan (side 1 or 6)
    [/modify_unit]
    [unit]
      id=Caravan_Driver
      name= _ "Caravan Driver"
      type=Fencer
      side=3
      x,y=29,25
      generate_name=no
      random_traits=yes
      random_gender=no
      animate=yes
      max_moves=0		# Stay put
    [/unit]
    [message]
      speaker=Caravan_Driver
      message= _ "What a waste.  But this rabble will not have it!"
    [/message]
    [set_variable]
      name=Caravan_static_sighted
      value=yes
    [/set_variable]
    [modify_side]
      side=3
      [ai]			# Side 3 (caravan escort) mounts an all-out attack
        aggression=1.0
        caution=0.0
        grouping=no
      [/ai]
    [/modify_side]
    [show_objectives]
      side=1
    [/show_objectives]
  [/event]


# Event to capture caravan
  [event]
    name=moveto
    [filter]
      [filter_location]
        x,y=28,25
        radius=1
      [/filter_location]
      side=1
    [/filter]
    [transform_unit]
      id=Caravan_static
      transform_to=Caravan
    [/transform_unit]
    [modify_unit]
      [filter]
        id=Caravan_static
      [/filter]
      side=1
    [/modify_unit]
    [message]
      x,y=$x1,$y1
      message= _ "Got the Caravan!"
    [/message]
    [if]
      [have_unit]
        side=3
        count=0
      [/have_unit]
    [then]
      [fire_event]
        name=15b_victory	# Victory event
      [/fire_event]
    [/then]
    [else]
      [show_objectives]
        side=1
      [/show_objectives]
    [/else]
    [/if]
  [/event]


# Turn 1 Dialogue
  [event]
    name=turn 1
    [message]
      speaker=Jackery
      message= _ "Bluddit!  Our path east ends here.  Being so low down by this river we cannot see very far ahead either."
    [/message]
    [message]
      speaker=Nippa
      message= _ "Can we <i>please</i> call it a day?  I'm sick of sloshin' along this scumfrek riverbank.  I'd kill for dry feet..."
    [/message]
    [message]
      speaker=Jackery
      message= _ "There may be a way ahead through the forest..."
    [/message]
    [objectives]
      [objective]
        description = _ "Now what?"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=no
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Find the Caravan"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=yes
          [/variable]
          [variable]
            name=Caravan_static_sighted
            equals=no
          [/variable]
          [and]
            [variable]
              name=Caravan_Commander_sighted
              equals=no
            [/variable]
          [or]
            [have_unit]
              side=3
              [not]
                id=Caravan_static
              [/not]
              count=0
            [/have_unit]
          [/or]
          [/and]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Neutralise (kill) <span foreground='#ffff00'><b>all</b></span> Caravan defenders
<i>and</i> find the Caravan"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=yes
          [/variable]
          [variable]
            name=Caravan_Commander_sighted
            equals=yes
          [/variable]
          [have_unit]
            side=3
            [not]
              id=Caravan_static
            [/not]
          [/have_unit]
          [variable]
            name=Caravan_static_sighted
            equals=no
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Neutralise (kill) <span foreground='#ffff00'><b>all</b></span> Caravan defenders
<i>and</i> capture the Caravan by moving any unit adjacent to it"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=yes
          [/variable]
          [variable]
            name=Caravan_Commander_sighted
            equals=yes
          [/variable]
          [have_unit]
            side=3
            [not]
              id=Caravan_static
            [/not]
          [/have_unit]
          [variable]
            name=Caravan_static_sighted
            equals=yes
          [/variable]
          [have_unit]
            id=Caravan_static
            side=1
            count=0
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Capture the Caravan by moving any unit adjacent to it"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=yes
          [/variable]
          [variable]
            name=Caravan_static_sighted
            equals=yes
          [/variable]
          [have_unit]
            id=Caravan_static
            side=1
            count=0
          [/have_unit]
          [and]
            [variable]
              name=Caravan_Commander_sighted
              equals=no
            [/variable]
          [or]
            [have_unit]
              side=3
              [not]
                id=Caravan_static
              [/not]
              count=0
            [/have_unit]
          [/or]
          [/and]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Neutralise (kill) <span foreground='#ffff00'><b>all</b></span> Caravan defenders"
        condition=win
        [show_if]
          [variable]
            name=Peasants_sighted
            equals=yes
          [/variable]
          [variable]
            name=Caravan_Commander_sighted
            equals=yes
          [/variable]
          [have_unit]
            side=3
            [not]
              id=Caravan_static
            [/not]
          [/have_unit]
          [have_unit]
            id=Caravan_static
            side=1
          [/have_unit]
        [/show_if]
      [/objective]
      [objective]
        description = _ "Death of Jackery"
        condition=lose
      [/objective]
      [objective]
        description = _ "Death of Nippa"
        condition=lose
      [/objective]
      [objective]
        description = _ "Destruction of the Caravan"
        condition=lose
        [show_if]
          [variable]
            name=Caravan_static_sighted
            equals=yes
          [/variable]
        [/show_if]
      [/objective]
      [objective]
        description= _ "Turns run out"
        condition=lose
        show_turn_counter=yes
      [/objective]
      {CARRYOVER 100}
    [/objectives]
  [/event]


# Setup initial conditions
  [event]
    name=prestart
    {AEI_CHANGE_LEADER Jackery 1 18}
    [unstore_unit]
      variable=Jackery_Nippa
      x,y=1,17
    [/unstore_unit]
    [clear_variable]
      name=Jackery_Nippa
    [/clear_variable]
    [set_extra_recruit]		# Jackery cannot recruit in this scenario (may have recalls)
      id=Jackery
      extra_recruit=
    [/set_extra_recruit]
    [item]
      x,y=29,2
      image=scenery/hole.png
    [/item]
    [unit]
      id=Plebian
      name= _ "Plebian"
      type=AEI_Peasant
      role=new_15b
      [modifications]
        {TRAIT_INTELLIGENT}
      [/modifications]
      side=2
      x,y=4,9
      generate_name=no
      random_traits=yes
      random_gender=yes
      experience={ON_DIFFICULTY 16 15 14} # out of 23
    [/unit]
    [unit]
      type=AEI_Peasant
      side=2
      role=new_15b
      x,y=8,10
      generate_name=yes
      [modifications]
        {TRAIT_QUICK}
        {TRAIT_RESILIENT}
      [/modifications]
      random_traits=yes
      random_gender=yes
      experience={ON_DIFFICULTY 9 8 7} # out of 23
    [/unit]
    [unit]
      type=AEI_Peasant
      side=2
      x,y=1,9
      role=new_15b
      generate_name=yes
      [modifications]
        {TRAIT_STRONG}
      [/modifications]
      random_traits=yes
      random_gender=yes
      experience={ON_DIFFICULTY 10 9 8} # out of 23
    [/unit]
#ifdef HARD
    [terrain]			# Extra village and Javelineer on HARD
      x,y=30,20
      terrain=Rb^Vdt
    [/terrain]
    [unit]
      side=3
      type=Javelineer
      x,y=30,20
      generate_name=yes
      random_traits=yes
      upkeep=free
    [/unit]
#endif
#ifdef __UNUSED__
    [capture_village]		# Controller=null; can't control villages
      side=4
      x=13,16,19
      y=23,22,24
    [/capture_village]
#endif
    [unit]			# Wounded, occupies northernmost village
      side=3
      id=hi_nv
      hitpoints={ON_DIFFICULTY 10 11 12} # out of 38
      type=Heavy Infantryman
      x,y=19,4
      [modifications]
#ifdef HARD
        {TRAIT_FEARLESS}
#else
        {TRAIT_INTELLIGENT}
#endif
        {TRAIT_STRONG}
      [/modifications]
      generate_name=yes
      random_traits=no
      ai_special=guardian
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=3
      type=Shock Trooper
      x,y=30,18
      generate_name=yes
      random_traits=yes
      ai_special=guardian
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [unit]
      side=3
      type=Longbowman
      x,y=29,19
      generate_name=yes
      random_traits=yes
      ai_special=guardian
#ifdef EASY
      upkeep=full
#else
      upkeep=free
#endif
    [/unit]
    [store_gold]		# Player has at least 100 gold
      [filter_side]
        side=1
      [/filter_side]
      variable=gold_option_toomuch
    [/store_gold]
    [if]
      [variable]		# If player has more than 200 gold, offer 200 else offer all gold
        name=gold_option_toomuch
        greater_than=200
      [/variable]
    [then]
      [set_variable]
        name=gold_option_toomuch
        value=200
      [/set_variable]
    [/then]
    [/if]
    [unit]
      id=Caravan_static
      type=Caravan_static
      name=_"Caravan"
      unrenamable=yes
      side=3
      x,y=28,25
      random_traits=no
      random_gender=yes
      animate=no
    [/unit]
    [set_variable]
      name=Peasants_sighted
      value=no
    [/set_variable]
    [set_variable]
      name=Caravan_Commander_sighted
      value=no
    [/set_variable]
    [set_variable]
      name=Caravan_static_sighted
      value=no
    [/set_variable]
    [modify_side]			# Wudhed has leader icon but we don't want side 4 to play
      side=4
      controller=null
    [/modify_side]
  [/event]


# Caravan_Commander last breath (death is part of side 3 die event)
  [event]
    name=last breath
    [filter]
      id=Caravan_Commander
    [/filter]
    [message]
      speaker=Caravan_Commander
      message= _ "Egad!  Defeated by such rabble... how embarassi-"
    [/message]
  [/event]


# Side 3 die event (victory if no side 3 units and Caravan captured)
  [event]
    name=die
    first_time_only=no
    [filter]
      side=3
    [/filter]
    [if]
      [have_unit]		# No more side 3 units
        side=3
        [not]
          id=Caravan_static
        [/not]
        count=0
      [/have_unit]
    [then]
      [if]
        [have_unit]		# Caravan already captured
          id=Caravan_static
          side=1
        [/have_unit]
      [then]
        [fire_event]
          name=15b_victory	# Victory event
        [/fire_event]
      [/then]
      [else]
        [show_objectives]
          side=1
        [/show_objectives]
      [/else]
      [/if]
    [/then]
    [/if]
  [/event]


# Caravan die event (defeat)
  [event]
    name=die
    [filter]
      id=Caravan_static
    [/filter]
    [message]
      speaker=Jackery
      message= _ "Oh no, the Caravan is destroyed!"
    [/message]
    [endlevel]
      result=defeat
    [/endlevel]
  [/event]


# Defeat if player crosses ford
  [event]
    name=moveto
    [filter]
      side=1
      [filter_location]
{15BAVOIDXY}
      [not]
        terrain=W*
      [/not]
      [/filter_location]
    [/filter]
    [message]
      speaker=Wudhed
      message= _ "I see yer, sneakin' around!  Guards!  To the north gate!"
    [/message]
    [message]
      speaker=Jackery
      message= _ "We few cannot prevail against the entire town garrison..."
    [/message]
    [endlevel]
      result=defeat
    [/endlevel]
  [/event]


# Time runs out (defeat)
[event]
  name=time over
  [message]
    speaker=Jackery
    message= _ "We were too slow!"
  [/message]
  [endlevel]
    result=defeat
  [/endlevel]
[/event]


# Extra strike (turquoise) ring pickup and drop logic
  {AEI_PICKDROP_RING_ES}

  {AEI_HERO_DEATHS}
[/scenario]

#undef 15BAVOID
#undef 15BAVOIDXY
